<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#F5F0E8">
<title>–ú–æ–∏ —Ñ–∏–Ω–∞–Ω—Å—ã</title>
<link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@400;600;700;800&family=Nunito:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --cream:#F5F0E8; --white:#FFF; --ink:#1A1A2E; --ink-light:#4A4A6A; --ink-muted:#9898B0;
  --violet:#7C5CBF; --violet-light:#EDE8F7;
  --green:#2ECC8E; --green-light:#E0F7EF;
  --coral:#FF6B6B; --coral-light:#FFEDED;
  --yellow:#FFD166; --yellow-light:#FFF7E0;
  --blue:#4A90D9; --blue-light:#E8F2FC;
  --shadow:0 4px 20px rgba(26,26,46,.08);
  --r:20px; --rs:12px; --nav:72px;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{font-family:'Nunito',sans-serif;background:var(--cream);color:var(--ink);min-height:100vh;max-width:430px;margin:0 auto;overflow-x:hidden}
.screen{display:none;flex-direction:column;min-height:100vh;padding-bottom:calc(var(--nav) + 16px)}
.screen.active{display:flex}

/* TOPBAR */
.topbar{padding:52px 24px 16px;background:var(--cream);position:sticky;top:0;z-index:10;display:flex;align-items:flex-start;justify-content:space-between}
.topbar-title{font-family:'Unbounded',sans-serif;font-size:22px;font-weight:800;letter-spacing:-.5px}
.topbar-right{display:flex;gap:8px;align-items:center;margin-top:4px}
.icon-btn{width:40px;height:40px;background:var(--white);border:none;border-radius:12px;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow);transition:transform .1s}
.icon-btn:active{transform:scale(.92)}

/* SYNC STATUS */
.sync-badge{display:flex;align-items:center;gap:5px;padding:5px 10px;border-radius:20px;font-size:11px;font-weight:700;cursor:pointer;transition:all .2s}
.sync-badge.connected{background:var(--green-light);color:var(--green)}
.sync-badge.syncing{background:var(--yellow-light);color:#B8860B}
.sync-badge.error{background:var(--coral-light);color:var(--coral)}
.sync-badge.offline{background:#F0EEF8;color:var(--ink-muted)}
.sync-dot{width:6px;height:6px;border-radius:50%;background:currentColor}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.sync-badge.syncing .sync-dot{animation:pulse .8s infinite}

/* MINI KOPILKA */
.mini-kopilka{margin:0 24px 16px;background:var(--violet-light);border-radius:var(--r);padding:14px 18px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;transition:transform .15s}
.mini-kopilka:active{transform:scale(.98)}
.mk-left{display:flex;align-items:center;gap:10px}
.mk-icon{width:36px;height:36px;background:var(--violet);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px}
.mk-label{font-size:11px;color:var(--violet);font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.mk-val{font-family:'Unbounded',sans-serif;font-size:16px;font-weight:800;color:var(--violet);margin-top:2px}
.mk-arrow{font-size:20px;color:var(--violet);opacity:.4}

/* PERIOD NAV */
.period-nav{display:flex;align-items:center;gap:10px;padding:0 24px;margin-bottom:14px}
.nav-arrow{width:38px;height:38px;background:var(--white);border:none;border-radius:11px;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow);transition:transform .1s;color:var(--ink);line-height:1}
.nav-arrow:active{transform:scale(.9)}
.nav-arrow:disabled{opacity:.25}
.period-center{flex:1;text-align:center}
.period-title{font-family:'Unbounded',sans-serif;font-size:15px;font-weight:700}

/* HERO CARD */
.hero-card{margin:0 24px 14px;background:var(--ink);border-radius:var(--r);padding:20px 22px;color:white;position:relative;overflow:hidden}
.hero-card::before{content:'';position:absolute;top:-40px;right:-40px;width:150px;height:150px;background:var(--violet);border-radius:50%;opacity:.35}
.hero-card::after{content:'';position:absolute;bottom:-50px;left:10px;width:180px;height:180px;background:var(--green);border-radius:50%;opacity:.12}
.hero-income-block{position:relative;z-index:1;margin-bottom:14px}
.hero-income-label{font-size:11px;font-weight:700;opacity:.5;text-transform:uppercase;letter-spacing:.8px}
.hero-income-row{display:flex;align-items:center;gap:10px;margin-top:2px}
.hero-income-val{font-family:'Unbounded',sans-serif;font-size:30px;font-weight:800;letter-spacing:-1px}
.hero-edit-btn{background:rgba(255,255,255,.12);border:none;border-radius:8px;color:white;padding:4px 10px;font-family:'Nunito',sans-serif;font-size:12px;font-weight:700;cursor:pointer;opacity:.7}
.hero-edit-btn:active{opacity:1}
.hero-row{display:flex;gap:8px;position:relative;z-index:1}
.hero-stat{flex:1;background:rgba(255,255,255,.08);border-radius:13px;padding:11px 12px}
.hero-stat-lbl{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;opacity:.5;margin-bottom:4px}
.hero-stat-val{font-family:'Unbounded',sans-serif;font-size:14px;font-weight:800;letter-spacing:-.3px}
.green{color:var(--green)} .coral{color:var(--coral)} .yellow{color:var(--yellow)}

/* PROGRESS */
.prog-wrap{padding:0 24px;margin-bottom:16px}
.prog-label{display:flex;justify-content:space-between;font-size:12px;font-weight:600;color:var(--ink-muted);margin-bottom:6px}
.prog-bar{height:7px;background:#E8E5EE;border-radius:4px;overflow:hidden}
.prog-fill{height:100%;border-radius:4px;transition:width .5s ease;background:var(--green)}
.prog-fill.warn{background:var(--yellow)}
.prog-fill.danger{background:var(--coral)}

/* SECTION HEADER */
.sec-hdr{display:flex;align-items:center;justify-content:space-between;padding:0 24px;margin-bottom:10px}
.sec-title{font-family:'Unbounded',sans-serif;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--ink-muted)}
.add-btn{background:var(--ink);color:white;border:none;border-radius:10px;padding:6px 14px;font-family:'Nunito',sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:transform .1s}
.add-btn:active{transform:scale(.95)}

/* EXPENSE ITEMS */
.exp-list{padding:0 24px;display:flex;flex-direction:column;gap:7px}
.exp-item{background:var(--white);border-radius:var(--rs);padding:13px 14px;display:flex;align-items:center;gap:10px;box-shadow:var(--shadow);transition:all .25s;position:relative;overflow:hidden}
.exp-item.paid{background:var(--green-light)}
.exp-item.paid::before{content:'';position:absolute;left:0;top:0;bottom:0;width:4px;background:var(--green);border-radius:4px 0 0 4px}
.exp-check{width:26px;height:26px;border-radius:8px;border:2px solid #D0CDE0;background:white;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all .2s;cursor:pointer;font-size:13px;color:white}
.exp-item.paid .exp-check{background:var(--green);border-color:var(--green)}
.exp-info{flex:1;min-width:0}
.exp-name{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.exp-item.paid .exp-name{color:var(--ink-light)}
.exp-amt{font-family:'Unbounded',sans-serif;font-size:14px;font-weight:700;flex-shrink:0}
.exp-item.paid .exp-amt{color:var(--green)}
.exp-actions{display:flex;gap:5px;flex-shrink:0}
.exp-btn{width:26px;height:26px;border:none;border-radius:7px;background:rgba(0,0,0,.05);cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center}
.exp-btn.del{background:var(--coral-light);color:var(--coral)}

/* KOPILKA SCREEN */
.kop-hero{margin:0 24px 16px;background:linear-gradient(135deg,var(--violet) 0%,#5B3FA8 100%);border-radius:var(--r);padding:24px;color:white;position:relative;overflow:hidden}
.kop-hero::before{content:'üè¶';position:absolute;right:20px;top:16px;font-size:44px;opacity:.25}
.kop-hero-lbl{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;opacity:.65}
.kop-hero-amt{font-family:'Unbounded',sans-serif;font-size:36px;font-weight:800;margin-top:6px;letter-spacing:-1px}
.kop-btns{padding:0 24px;margin-bottom:16px;display:flex;gap:10px}
.kop-btn{flex:1;padding:11px;border:none;border-radius:var(--rs);font-family:'Nunito',sans-serif;font-size:14px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:5px;transition:transform .1s}
.kop-btn:active{transform:scale(.96)}
.kop-btn.add{background:var(--green-light);color:var(--green)}
.kop-btn.sub{background:var(--coral-light);color:var(--coral)}

/* TIMELINE */
.tl-section-hdr{padding:4px 24px 8px;font-family:'Unbounded',sans-serif;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--ink-muted)}
.tl-item{margin:0 24px 6px;border-radius:var(--rs);padding:11px 14px;display:flex;align-items:center;gap:10px;box-shadow:var(--shadow);position:relative;overflow:hidden}
.tl-item.past{background:#F7F6F9;opacity:.75}
.tl-item.future{background:var(--white)}
.tl-item.danger-row{border:2px solid var(--coral);}
.tl-dot{width:32px;height:32px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;font-weight:700}
.tl-dot.inc.past{background:#E4E2EC;color:#888}
.tl-dot.exp.past{background:#EDE8E8;color:#999}
.tl-dot.inc.future{background:var(--green-light);color:var(--green)}
.tl-dot.exp.future{background:var(--coral-light);color:var(--coral)}
.tl-info{flex:1;min-width:0}
.tl-name{font-size:13px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tl-item.past .tl-name{color:var(--ink-light)}
.tl-bal{font-size:10px;font-weight:600;margin-top:2px}
.tl-bal.ok{color:var(--green)}
.tl-bal.warn{color:var(--coral)}
.tl-right{display:flex;align-items:center;gap:7px;flex-shrink:0}
.tl-amt{font-family:'Unbounded',sans-serif;font-size:13px;font-weight:800}
.tl-item.past .tl-amt{color:var(--ink-muted)}
.tl-amt.inc.future{color:var(--green)}
.tl-amt.exp.future{color:var(--coral)}
.tl-check{width:28px;height:28px;border:none;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;transition:all .2s;flex-shrink:0}
.tl-check.unpaid{background:var(--coral-light);color:var(--coral)}
.tl-check.paid{background:var(--green-light);color:var(--green)}
.tl-warn-icon{font-size:16px;flex-shrink:0}
.tl-right-col{display:flex;flex-direction:column;align-items:flex-end}
.exp-item.future-locked{opacity:.7}
.exp-check.locked{background:#F0EEF8;color:var(--ink-muted);border-color:#E0DDF0;cursor:default;font-size:10px}

/* SETTINGS */
.set-section{padding:0 24px;margin-bottom:22px}
.set-section-title{font-family:'Unbounded',sans-serif;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--ink-muted);margin-bottom:10px}
.set-card{background:var(--white);border-radius:var(--r);padding:18px 20px;box-shadow:var(--shadow)}
.set-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid #F0EEF8}
.set-row:last-child{border-bottom:none;padding-bottom:0}
.set-row-lbl{font-size:14px;font-weight:700}
.set-row-sub{font-size:12px;color:var(--ink-muted);margin-top:2px}
.set-input{width:130px;border:2px solid #EEEEF5;border-radius:10px;padding:8px 12px;font-family:'Nunito',sans-serif;font-size:15px;font-weight:700;background:var(--cream);outline:none;text-align:right;transition:border-color .2s}
.set-input:focus{border-color:var(--violet)}
.set-save-btn{width:100%;margin-top:14px;padding:13px;background:var(--ink);color:white;border:none;border-radius:var(--rs);font-family:'Nunito',sans-serif;font-size:15px;font-weight:800;cursor:pointer;transition:transform .1s}
.set-save-btn:active{transform:scale(.98)}
.sal-preview{margin-top:14px;background:var(--cream);border-radius:12px;padding:14px 16px}
.sal-preview-title{font-size:11px;font-weight:700;color:var(--ink-muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px}
.sal-row{display:flex;justify-content:space-between;align-items:center;padding:4px 0}
.sal-row-lbl{font-size:13px;color:var(--ink-light);font-weight:600}
.sal-row-val{font-family:'Unbounded',sans-serif;font-size:13px;font-weight:700}

/* GOOGLE AUTH CARD */
.auth-card{margin:0 24px 16px;background:var(--white);border-radius:var(--r);padding:20px;box-shadow:var(--shadow)}
.auth-card-title{font-family:'Unbounded',sans-serif;font-size:14px;font-weight:700;margin-bottom:8px}
.auth-card-sub{font-size:13px;color:var(--ink-muted);line-height:1.5;margin-bottom:14px}
.auth-btn{width:100%;padding:12px;border:none;border-radius:var(--rs);font-family:'Nunito',sans-serif;font-size:14px;font-weight:800;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:transform .1s}
.auth-btn:active{transform:scale(.97)}
.auth-btn.google{background:var(--ink);color:white}
.auth-btn.disconnect{background:var(--coral-light);color:var(--coral)}
.auth-status-row{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid #F0EEF8}
.auth-status-row:last-child{border-bottom:none}
.auth-email{font-size:13px;font-weight:700;flex:1}
.auth-sub{font-size:11px;color:var(--ink-muted)}

/* BASE PAYMENTS */
.bp-item{background:var(--white);border-radius:var(--rs);padding:12px 14px;display:flex;align-items:center;gap:10px;box-shadow:var(--shadow);margin-bottom:8px}
.bp-badge{flex-shrink:0;width:32px;height:32px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800;font-family:'Unbounded',sans-serif}
.bp-badge.d5{background:var(--violet-light);color:var(--violet)}
.bp-badge.d20{background:var(--blue-light);color:var(--blue)}
.bp-info{flex:1;min-width:0}
.bp-name{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.bp-sub{font-size:11px;color:var(--ink-muted);margin-top:1px}
.bp-amt{font-family:'Unbounded',sans-serif;font-size:14px;font-weight:700;flex-shrink:0;margin-right:6px}
.bp-actions{display:flex;gap:5px;flex-shrink:0}
.bp-btn{width:26px;height:26px;border:none;border-radius:7px;background:rgba(0,0,0,.05);cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center}
.bp-btn.del{background:var(--coral-light);color:var(--coral)}

/* BOTTOM NAV */
.bottom-nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;height:var(--nav);background:var(--ink);display:flex;border-radius:24px 24px 0 0;padding:0 8px;z-index:100}
.nav-tab{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;border:none;background:none;color:rgba(255,255,255,.35);cursor:pointer;transition:color .2s;padding:0}
.nav-tab.active{color:white}
.nav-wrap{display:flex;flex-direction:column;align-items:center;gap:3px;padding:6px 16px;border-radius:14px}
.nav-tab.active .nav-wrap{background:rgba(255,255,255,.1)}
.nav-ico{font-size:21px;line-height:1}
.nav-lbl{font-family:'Nunito',sans-serif;font-size:10px;font-weight:700}

/* MODALS */
.modal-ov{display:none;position:fixed;inset:0;background:rgba(26,26,46,.5);z-index:200;align-items:flex-end;justify-content:center}
.modal-ov.open{display:flex}
.modal{background:var(--white);border-radius:24px 24px 0 0;padding:24px 24px 44px;width:100%;max-width:430px;animation:slideUp .28s ease}
@keyframes slideUp{from{transform:translateY(100%);opacity:0}to{transform:translateY(0);opacity:1}}
.modal-title{font-family:'Unbounded',sans-serif;font-size:17px;font-weight:800;margin-bottom:18px}
.modal-field{margin-bottom:14px}
.modal-label{font-size:12px;font-weight:700;color:var(--ink-muted);margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px}
.modal-input{width:100%;border:2px solid #EEEEF5;border-radius:var(--rs);padding:11px 14px;font-family:'Nunito',sans-serif;font-size:16px;font-weight:600;color:var(--ink);background:var(--cream);outline:none;transition:border-color .2s}
.modal-input:focus{border-color:var(--violet)}
.modal-seg{display:flex;gap:8px;margin-top:4px}
.modal-seg-btn{flex:1;padding:11px;border:2px solid #EEEEF5;border-radius:var(--rs);background:var(--cream);font-family:'Nunito',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:all .15s;color:var(--ink-muted)}
.modal-seg-btn.active{border-color:var(--violet);background:var(--violet-light);color:var(--violet)}
.modal-actions{display:flex;gap:10px;margin-top:18px}
.modal-btn{flex:1;padding:13px;border:none;border-radius:var(--rs);font-family:'Nunito',sans-serif;font-size:15px;font-weight:800;cursor:pointer;transition:transform .1s}
.modal-btn:active{transform:scale(.97)}
.modal-btn.primary{background:var(--ink);color:white}
.modal-btn.secondary{background:var(--cream);color:var(--ink)}

/* TOAST */
.toast{position:fixed;bottom:calc(var(--nav) + 20px);left:50%;transform:translateX(-50%) translateY(100px);background:var(--ink);color:white;padding:11px 20px;border-radius:100px;font-size:13px;font-weight:700;z-index:400;transition:transform .3s ease;white-space:nowrap;pointer-events:none;max-width:calc(100% - 48px);text-align:center}
.toast.show{transform:translateX(-50%) translateY(0)}
.empty-state{text-align:center;padding:32px 24px;color:var(--ink-muted)}
.empty-ico{font-size:40px;margin-bottom:10px}
.empty-txt{font-size:14px;font-weight:600}

/* LOADING OVERLAY */
.loading-ov{position:fixed;inset:0;background:var(--cream);z-index:500;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px}
.loading-ov.hidden{display:none}
.loading-spinner{width:40px;height:40px;border:3px solid #E8E5EE;border-top-color:var(--violet);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-txt{font-family:'Unbounded',sans-serif;font-size:13px;font-weight:700;color:var(--ink-muted)}
</style>
</head>
<body>

<!-- LOADING -->
<div class="loading-ov" id="loading-ov">
  <div class="loading-spinner"></div>
  <div class="loading-txt" id="loading-txt">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<!-- PERIODS -->
<div class="screen active" id="screen-periods">
  <div class="topbar">
    <div class="topbar-title">–ú–æ–∏ —Ñ–∏–Ω–∞–Ω—Å—ã ‚ú¶</div>
    <div class="topbar-right">
      <div class="sync-badge offline" id="sync-badge" onclick="manualSync()" title="–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è">
        <div class="sync-dot"></div>
        <span id="sync-label">–æ—Ñ–ª–∞–π–Ω</span>
      </div>
      <button class="icon-btn" onclick="switchTab('settings')">‚öôÔ∏è</button>
    </div>
  </div>
  <div class="mini-kopilka" onclick="switchTab('kopilka')">
    <div class="mk-left">
      <div class="mk-icon">üè¶</div>
      <div><div class="mk-label">–ö–æ–ø–∏–ª–∫–∞</div><div class="mk-val" id="mk-val">0 ‚ÇΩ</div></div>
    </div>
    <div class="mk-arrow">‚Ä∫</div>
  </div>
  <div class="period-nav">
    <button class="nav-arrow" id="btn-prev" onclick="changePeriod(-1)">‚Äπ</button>
    <div class="period-center"><div class="period-title" id="period-name">‚Äî</div></div>
    <button class="nav-arrow" id="btn-next" onclick="changePeriod(1)">‚Ä∫</button>
  </div>
  <div class="hero-card">
    <div class="hero-income-block">
      <div class="hero-income-label">–ü–æ–ª—É—á–µ–Ω–æ</div>
      <div class="hero-income-row">
        <div class="hero-income-val" id="hero-income">0 ‚ÇΩ</div>
        <button class="hero-edit-btn" onclick="openEditIncome()">‚úèÔ∏è –∏–∑–º–µ–Ω–∏—Ç—å</button>
      </div>
    </div>
    <div class="hero-row">
      <div class="hero-stat"><div class="hero-stat-lbl">–†–∞—Å—Ö–æ–¥—ã</div><div class="hero-stat-val coral" id="hero-exp">0 ‚ÇΩ</div></div>
      <div class="hero-stat"><div class="hero-stat-lbl">–û–ø–ª–∞—á–µ–Ω–æ</div><div class="hero-stat-val green" id="hero-paid">0 ‚ÇΩ</div></div>
      <div class="hero-stat"><div class="hero-stat-lbl">–û—Å—Ç–∞—Ç–æ–∫</div><div class="hero-stat-val yellow" id="hero-left">0 ‚ÇΩ</div></div>
    </div>
  </div>
  <div class="prog-wrap">
    <div class="prog-label"><span>–û–ø–ª–∞—á–µ–Ω–æ —Ä–∞—Å—Ö–æ–¥–æ–≤</span><span id="prog-pct">0%</span></div>
    <div class="prog-bar"><div class="prog-fill" id="prog-fill" style="width:0%"></div></div>
  </div>
  <div class="sec-hdr">
    <div class="sec-title">–†–∞—Å—Ö–æ–¥—ã</div>
    <button class="add-btn" onclick="openAddExpense()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
  </div>
  <div class="exp-list" id="exp-list"></div>
  <div style="height:16px"></div>
</div>

<!-- KOPILKA -->
<div class="screen" id="screen-kopilka">
  <div class="topbar">
    <div class="topbar-title">–ö–æ–ø–∏–ª–∫–∞ üè¶</div>
    <button class="icon-btn" onclick="switchTab('settings')">‚öôÔ∏è</button>
  </div>
  <div class="kop-hero">
    <div class="kop-hero-lbl">–ë–∞–ª–∞–Ω—Å –∫–æ–ø–∏–ª–∫–∏</div>
    <div class="kop-hero-amt" id="kop-balance">0 ‚ÇΩ</div>
  </div>
  <div class="kop-btns">
    <button class="kop-btn add" onclick="openKopilkaOp('add')">+ –ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
    <button class="kop-btn sub" onclick="openKopilkaOp('sub')">‚àí –°–Ω—è—Ç—å</button>
  </div>
  <div id="kop-timeline"></div>
  <div style="height:16px"></div>
</div>

<!-- SETTINGS -->
<div class="screen" id="screen-settings">
  <div class="topbar">
    <div class="topbar-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚öôÔ∏è</div>
  </div>

  <!-- –ë–∞–∑–æ–≤—ã–µ –ø–ª–∞—Ç–µ–∂–∏ -->
  <div class="set-section">
    <div class="set-section-title">–ë–∞–∑–æ–≤—ã–µ –ø–ª–∞—Ç–µ–∂–∏</div>
    <div style="font-size:13px;color:var(--ink-muted);margin-bottom:12px;line-height:1.5">
      –ò–∑–º–µ–Ω–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ —Å—É–º–º—É ‚Äî –æ–±–Ω–æ–≤–∏—Ç—Å—è –≤–æ –≤—Å–µ—Ö –±—É–¥—É—â–∏—Ö –ø–µ—Ä–∏–æ–¥–∞—Ö
    </div>
    <div id="bp-list"></div>
    <button class="set-save-btn" style="margin-top:4px" onclick="openAddBP()">+ –î–æ–±–∞–≤–∏—Ç—å –±–∞–∑–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂</button>
  </div>

  <!-- –î–∞–Ω–Ω—ã–µ -->
  <div class="set-section">
    <div class="set-section-title">–î–∞–Ω–Ω—ã–µ</div>
    <div class="set-card">
      <div class="set-row">
        <div><div class="set-row-lbl">–ú–æ–∏ —Ñ–∏–Ω–∞–Ω—Å—ã</div><div class="set-row-sub">–í–µ—Ä—Å–∏—è 2.1 ¬∑ Google Sheets ‚Äî –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã</div></div>
      </div>
      <div class="set-row" style="cursor:pointer" onclick="resetData()">
        <div><div class="set-row-lbl" style="color:var(--coral)">–°–±—Ä–æ—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</div><div class="set-row-sub">–í–µ—Ä–Ω—É—Ç—å –∫ –Ω–∞—á–∞–ª—å–Ω—ã–º –¥–∞–Ω–Ω—ã–º</div></div>
        <span style="color:var(--coral)">‚Ä∫</span>
      </div>
    </div>
  </div>
  <div style="height:16px"></div>
</div>

<!-- NAV -->
<nav class="bottom-nav">
  <button class="nav-tab active" onclick="switchTab('periods')" id="nav-periods">
    <div class="nav-wrap"><span class="nav-ico">üìÖ</span><span class="nav-lbl">–ü–µ—Ä–∏–æ–¥—ã</span></div>
  </button>
  <button class="nav-tab" onclick="switchTab('kopilka')" id="nav-kopilka">
    <div class="nav-wrap"><span class="nav-ico">üè¶</span><span class="nav-lbl">–ö–æ–ø–∏–ª–∫–∞</span></div>
  </button>
  <button class="nav-tab" onclick="switchTab('settings')" id="nav-settings">
    <div class="nav-wrap"><span class="nav-ico">‚öôÔ∏è</span><span class="nav-lbl">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span></div>
  </button>
</nav>

<!-- MODAL: Expense -->
<div class="modal-ov" id="modal-expense">
  <div class="modal">
    <div class="modal-title" id="modal-exp-title">–ù–æ–≤—ã–π —Ä–∞—Å—Ö–æ–¥</div>
    <div class="modal-field"><div class="modal-label">–ù–∞–∑–≤–∞–Ω–∏–µ</div><input class="modal-input" id="exp-name-in" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –û–∑–æ–Ω" type="text"></div>
    <div class="modal-field"><div class="modal-label">–°—É–º–º–∞, ‚ÇΩ</div><input class="modal-input" id="exp-amt-in" placeholder="0" type="number" inputmode="numeric"></div>
    <div class="modal-actions">
      <button class="modal-btn secondary" onclick="closeModal('modal-expense')">–û—Ç–º–µ–Ω–∞</button>
      <button class="modal-btn primary" onclick="saveExpense()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- MODAL: Income -->
<div class="modal-ov" id="modal-income">
  <div class="modal">
    <div class="modal-title">–ò–∑–º–µ–Ω–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–Ω—É—é —Å—É–º–º—É</div>
    <div class="modal-field"><div class="modal-label">–ü–æ–ª—É—á–µ–Ω–æ, ‚ÇΩ</div><input class="modal-input" id="income-in" placeholder="0" type="number" inputmode="numeric"></div>
    <div class="modal-actions">
      <button class="modal-btn secondary" onclick="closeModal('modal-income')">–û—Ç–º–µ–Ω–∞</button>
      <button class="modal-btn primary" onclick="saveIncome()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- MODAL: Kopilka Op -->
<div class="modal-ov" id="modal-kop">
  <div class="modal">
    <div class="modal-title" id="modal-kop-title">–ü–æ–ø–æ–ª–Ω–∏—Ç—å –∫–æ–ø–∏–ª–∫—É</div>
    <div class="modal-field"><div class="modal-label">–°—É–º–º–∞, ‚ÇΩ</div><input class="modal-input" id="kop-amt-in" placeholder="0" type="number" inputmode="numeric"></div>
    <div class="modal-field"><div class="modal-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</div><input class="modal-input" id="kop-comment-in" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –ü—Ä–æ—Ü–µ–Ω—Ç—ã –ø–æ –≤–∫–ª–∞–¥—É" type="text"></div>
    <div class="modal-actions">
      <button class="modal-btn secondary" onclick="closeModal('modal-kop')">–û—Ç–º–µ–Ω–∞</button>
      <button class="modal-btn primary" onclick="saveKopOp()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- MODAL: Base Payment -->
<div class="modal-ov" id="modal-bp">
  <div class="modal">
    <div class="modal-title" id="modal-bp-title">–ë–∞–∑–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂</div>
    <div class="modal-field"><div class="modal-label">–ù–∞–∑–≤–∞–Ω–∏–µ</div><input class="modal-input" id="bp-name-in" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –†–µ—Å–Ω–∏—Ü—ã" type="text"></div>
    <div class="modal-field"><div class="modal-label">–°—É–º–º–∞, ‚ÇΩ</div><input class="modal-input" id="bp-amt-in" placeholder="0" type="number" inputmode="numeric"></div>
    <div class="modal-field">
      <div class="modal-label">–ü–µ—Ä–∏–æ–¥ (–≤ –∫–∞–∫–æ–µ —á–∏—Å–ª–æ)</div>
      <div class="modal-seg">
        <button class="modal-seg-btn active" id="bp-seg-5" onclick="selectBPDay(5)">5 —á–∏—Å–ª–∞</button>
        <button class="modal-seg-btn" id="bp-seg-20" onclick="selectBPDay(20)">20 —á–∏—Å–ª–∞</button>
      </div>
    </div>
    <div class="modal-actions">
      <button class="modal-btn secondary" onclick="closeModal('modal-bp')">–û—Ç–º–µ–Ω–∞</button>
      <button class="modal-btn primary" onclick="saveBP()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- MODAL: Edit Kopilka Entry Amount -->
<div class="modal-ov" id="modal-kop-edit">
  <div class="modal">
    <div class="modal-title">–í –∫–æ–ø–∏–ª–∫—É ‚Äî <span id="kop-edit-period" style="color:var(--violet)"></span></div>
    <input type="hidden" id="kop-edit-id">
    <div class="modal-field">
      <div class="modal-label">–°—É–º–º–∞, ‚ÇΩ</div>
      <input class="modal-input" id="kop-edit-amt" placeholder="0" type="number" inputmode="numeric">
    </div>
    <div style="font-size:12px;color:var(--ink-muted);margin-top:-6px;line-height:1.5">
      –ò–∑–º–µ–Ω–µ–Ω–∏–µ –æ–±–Ω–æ–≤–∏—Ç —Å—É–º–º—É –≤ —Ç–∞–±–ª–∏—Ü–µ –ö–æ–ø–∏–ª–∫–∏ –∏ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ—Ç –ø—Ä–æ–≥–Ω–æ–∑ –±–∞–ª–∞–Ω—Å–∞
    </div>
    <div class="modal-actions">
      <button class="modal-btn secondary" onclick="closeModal('modal-kop-edit')">–û—Ç–º–µ–Ω–∞</button>
      <button class="modal-btn primary" onclick="saveKopilkaEntryEdit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const GOOGLE_CLIENT_ID = '91072547655-uut7hbnspu6thk06jlhoktngtqufcaoi.apps.googleusercontent.com';
const SPREADSHEET_ID   = '1-WAxJNhPFJPVs4j9PZjBpMGUDk6J5FISpFATpO_HPIE';
const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

// Sheet names
const SH_PERIODS = '–ü–µ—Ä–∏–æ–¥—ã';
const SH_KOPILKA = '–ö–æ–ø–∏–ª–∫–∞';
const SH_BP      = '–ë–∞–∑–æ–≤—ã–µ –ø–ª–∞—Ç–µ–∂–∏';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RUSSIAN PUBLIC HOLIDAYS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const RU_HOLIDAYS = new Set([
  '2025-1-1','2025-1-2','2025-1-3','2025-1-6','2025-1-7','2025-1-8',
  '2025-2-24','2025-3-10','2025-5-1','2025-5-2','2025-5-8','2025-5-9',
  '2025-6-12','2025-6-13','2025-11-4','2025-12-31',
  '2026-1-1','2026-1-2','2026-1-5','2026-1-6','2026-1-7','2026-1-8','2026-1-9',
  '2026-2-23','2026-3-9','2026-5-1','2026-5-4','2026-5-11',
  '2026-6-12','2026-11-4','2026-12-31',
  '2027-1-1','2027-1-4','2027-1-5','2027-1-6','2027-1-7','2027-1-8',
  '2027-2-22','2027-2-23','2027-3-8','2027-5-3','2027-5-10',
  '2027-6-14','2027-11-4','2027-11-5',
]);
function isWorkingDay(y,m,d){const dt=new Date(y,m,d);const dow=dt.getDay();if(dow===0||dow===6)return false;return!RU_HOLIDAYS.has(`${y}-${m+1}-${d}`);}
function countWorkingDays(y,m,from,to){const last=new Date(y,m+1,0).getDate();let cnt=0;for(let d=from;d<=Math.min(to,last);d++){if(isWorkingDay(y,m,d))cnt++;}return cnt;}
function calcAvans(salary,y,m){const total=countWorkingDays(y,m,1,31);if(!total)return 0;return Math.round(salary*countWorkingDays(y,m,1,15)/total);}
function calcZarplata(salary,y,m){let pm=m-1,py=y;if(pm<0){pm=11;py--;}return salary-calcAvans(salary,py,pm);}
function genSalaryPreview(salary){
  const mn=['—è–Ω–≤–∞—Ä—å','—Ñ–µ–≤—Ä–∞–ª—å','–º–∞—Ä—Ç','–∞–ø—Ä–µ–ª—å','–º–∞–π','–∏—é–Ω—å','–∏—é–ª—å','–∞–≤–≥—É—Å—Ç','—Å–µ–Ω—Ç—è–±—Ä—å','–æ–∫—Ç—è–±—Ä—å','–Ω–æ—è–±—Ä—å','–¥–µ–∫–∞–±—Ä—å'];
  const t=new Date();let y=t.getFullYear(),m=t.getMonth();const res=[];
  for(let i=0;i<10&&res.length<6;i++){
    res.push({label:mn[m]+' ‚Äî 20 (–∞–≤–∞–Ω—Å)',val:calcAvans(salary,y,m),note:'avans'});
    if(res.length<6){let nm=m+1,ny=y;if(nm>11){nm=0;ny++;}res.push({label:mn[nm]+' ‚Äî 5 (–∑–∞—Ä–ø–ª–∞—Ç–∞)',val:calcZarplata(salary,ny,nm),note:'zp'});}
    m++;if(m>11){m=0;y++;}
  }
  return res.slice(0,6);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INITIAL DATA (fallback)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const INIT_PERIODS = [
  {name:'–¥–µ–∫–∞–±—Ä—å 5',income:82500,expenses:[{name:'–†–µ—Å–Ω–∏—Ü—ã',amount:3000,paid:false},{name:'–Ø–Ω–¥–µ–∫—Å –ü–µ–π',amount:10914,paid:false},{name:'–¢–∏–Ω—å–∫–æ—Ñ –∞–≤—Ç–æ',amount:4690,paid:false},{name:'–ê–ª—å—Ñ–∞',amount:10400,paid:false},{name:'–í –∫–æ–ø–∏–ª–∫—É',amount:29000,paid:false},{name:'–¢–∏–Ω—å–∫–æ—Ñ –∫—Ä–µ–¥–∏—Ç–∫–∞',amount:10800,paid:false}]},
  {name:'–¥–µ–∫–∞–±—Ä—å 20',income:65000,expenses:[{name:'–û–∑–æ–Ω –¥–µ–∫–∞–±—Ä—å',amount:29000,paid:false},{name:'–¢–∏–Ω—å–∫–æ—Ñ –∫—Ä–µ–¥–∏—Ç–∫–∞',amount:10800,paid:false},{name:'–í –∫–æ–ø–∏–ª–∫—É',amount:2500,paid:false},{name:'–Ø–Ω–¥–µ–∫—Å –ü–µ–π',amount:10914,paid:false},{name:'–ê–ª—å—Ñ–∞',amount:10400,paid:false},{name:'–ü—Ä–æ–¥—É–∫—Ç—ã',amount:10000,paid:false}]},
  {name:'—Ñ–µ–≤—Ä–∞–ª—å 5',income:128800,expenses:[{name:'–¢–∏–Ω—å–∫–æ—Ñ –∞–≤—Ç–æ',amount:4690,paid:false},{name:'–Ø–Ω–¥–µ–∫—Å –ü–µ–π',amount:29910,paid:false},{name:'–ê–ª—å—Ñ–∞',amount:10400,paid:false},{name:'–í –∫–æ–ø–∏–ª–∫—É',amount:55500,paid:false},{name:'–ü—Ä–æ–¥—É–∫—Ç—ã',amount:9000,paid:false},{name:'–ú–æ–π —Ç–µ–ª–µ—Ñ–æ–Ω',amount:390,paid:false},{name:'–î–æ–ª–≥ –º–∞–º–µ',amount:22500,paid:false}]},
  {name:'—Ñ–µ–≤—Ä–∞–ª—å 20',income:78947,expenses:[{name:'–¢–∏–Ω—å–∫–æ—Ñ –∞–≤—Ç–æ',amount:4690,paid:false},{name:'–¢–∏–Ω—å–∫–æ—Ñ –∫—Ä–µ–¥–∏—Ç–∫–∞',amount:6400,paid:false},{name:'–î–æ–ª–≥ –º–∞–º–µ',amount:22500,paid:false},{name:'–í–æ–ª–æ—Å—ã',amount:40000,paid:false},{name:'–°–ø–ª–∏—Ç',amount:1650,paid:false},{name:'–û–∑–æ–Ω —Ñ–µ–≤—Ä–∞–ª—å',amount:30000,paid:false},{name:'–ú–µ–ª–æ—á–∏',amount:10000,paid:false}]},
  {name:'–º–∞—Ä—Ç 5',income:71053,expenses:[{name:'–¢–∏–Ω—å–∫–æ—Ñ –∞–≤—Ç–æ',amount:4690,paid:false},{name:'–Ø–Ω–¥–µ–∫—Å –ü–µ–π',amount:29849,paid:false},{name:'–ê–ª—å—Ñ–∞',amount:10400,paid:false},{name:'–í –∫–æ–ø–∏–ª–∫—É',amount:26900,paid:false},{name:'–ü—Ä–æ–¥—É–∫—Ç—ã',amount:9000,paid:false},{name:'–ú–æ–π —Ç–µ–ª–µ—Ñ–æ–Ω',amount:390,paid:false},{name:'–†–µ—Å–Ω–∏—Ü—ã',amount:2500,paid:false},{name:'–¢–∏–Ω—å–∫–æ–≤ –∫—Ä–µ–¥–∏—Ç–∫–∞',amount:1900,paid:false}]},
  {name:'–º–∞—Ä—Ç 20',income:64286,expenses:[{name:'–í –∫–æ–ø–∏–ª–∫—É',amount:49000,paid:false},{name:'–ü—Ä–æ–¥—É–∫—Ç—ã',amount:7900,paid:false},{name:'–ú–∞–º–∞ —Å–≤—è–∑—å',amount:1500,paid:false},{name:'–û–∑–æ–Ω –º–∞—Ä—Ç',amount:3344,paid:false},{name:'–†–µ—Å–Ω–∏—Ü—ã',amount:2500,paid:false}]},
  {name:'–∞–ø—Ä–µ–ª—å 5',income:85714,expenses:[{name:'–Ø–Ω–¥–µ–∫—Å –ü–µ–π',amount:29849,paid:false},{name:'–¢–∏–Ω—å–∫–æ—Ñ –∞–≤—Ç–æ',amount:4690,paid:false},{name:'–ê–ª—å—Ñ–∞',amount:10400,paid:false},{name:'–í –∫–æ–ø–∏–ª–∫—É',amount:26900,paid:false},{name:'–ü—Ä–æ–¥—É–∫—Ç—ã',amount:9000,paid:false},{name:'–ú–æ–π —Ç–µ–ª–µ—Ñ–æ–Ω',amount:390,paid:false},{name:'–†–µ—Å–Ω–∏—Ü—ã',amount:2500,paid:false},{name:'–¢–∏–Ω—å–∫–æ–≤ –∫—Ä–µ–¥–∏—Ç–∫–∞',amount:1900,paid:false}]},
  {name:'–∞–ø—Ä–µ–ª—å 20',income:75000,expenses:[{name:'–í –∫–æ–ø–∏–ª–∫—É',amount:60000,paid:false},{name:'–ü—Ä–æ–¥—É–∫—Ç—ã',amount:8700,paid:false},{name:'–ú–∞–º–∞ —Å–≤—è–∑—å',amount:1500,paid:false},{name:'–û–∑–æ–Ω –∞–ø—Ä–µ–ª—å',amount:3174,paid:false},{name:'–†–µ—Å–Ω–∏—Ü—ã',amount:2500,paid:false}]},
  {name:'–º–∞–π 5',income:75000,expenses:[{name:'–Ø–Ω–¥–µ–∫—Å –ü–µ–π',amount:29849,paid:false},{name:'–¢–∏–Ω—å–∫–æ—Ñ –∞–≤—Ç–æ',amount:4690,paid:false},{name:'–ê–ª—å—Ñ–∞',amount:10400,paid:false},{name:'–í –∫–æ–ø–∏–ª–∫—É',amount:15000,paid:false},{name:'–ü—Ä–æ–¥—É–∫—Ç—ã',amount:10000,paid:false},{name:'–ú–æ–π —Ç–µ–ª–µ—Ñ–æ–Ω',amount:390,paid:false},{name:'–†–µ—Å–Ω–∏—Ü—ã',amount:2500,paid:false},{name:'–¢–∏–Ω—å–∫–æ–≤ –∫—Ä–µ–¥–∏—Ç–∫–∞',amount:1900,paid:false}]},
  {name:'–º–∞–π 20',income:66667,expenses:[{name:'–í –∫–æ–ø–∏–ª–∫—É',amount:55700,paid:false},{name:'–ü—Ä–æ–¥—É–∫—Ç—ã',amount:9400,paid:false},{name:'–ß–∞—Ç –≥–ø—Ç',amount:2490,paid:false},{name:'–ú–∞–º–∞ —Å–≤—è–∑—å',amount:1500,paid:false},{name:'–û–∑–æ–Ω –º–∞–π',amount:3159,paid:false}]},
  {name:'–∏—é–Ω—å 5',income:83333,expenses:[{name:'–†–µ—Å–Ω–∏—Ü—ã',amount:2500,paid:false},{name:'–Ø–Ω–¥–µ–∫—Å –ü–µ–π',amount:18935,paid:false},{name:'–¢–∏–Ω—å–∫–æ—Ñ –∞–≤—Ç–æ',amount:4690,paid:false},{name:'–ê–ª—å—Ñ–∞',amount:10400,paid:false},{name:'–í –∫–æ–ø–∏–ª–∫—É',amount:30000,paid:false},{name:'–ü—Ä–æ–¥—É–∫—Ç—ã',amount:9500,paid:false},{name:'–¢–∏–Ω—å–∫–æ–≤ –∫—Ä–µ–¥–∏—Ç–∫–∞',amount:1900,paid:false}]},
  {name:'–∏—é–Ω—å 20',income:71429,expenses:[{name:'–ü—Ä–æ–¥—É–∫—Ç—ã',amount:10000,paid:false},{name:'–í –∫–æ–ø–∏–ª–∫—É',amount:60000,paid:false},{name:'–ß–∞—Ç –≥–ø—Ç',amount:2600,paid:false},{name:'–ú–∞–º–∞ —Å–≤—è–∑—å',amount:1500,paid:false}]},
];
const INIT_BASE_PAYMENTS = [
  {id:'bp1',name:'–¢–∏–Ω—å–∫–æ—Ñ –∞–≤—Ç–æ',amount:4690,day:5},
  {id:'bp2',name:'–Ø–Ω–¥–µ–∫—Å –ü–µ–π',amount:29849,day:5},
  {id:'bp3',name:'–ê–ª—å—Ñ–∞',amount:10400,day:5},
  {id:'bp4',name:'–ü—Ä–æ–¥—É–∫—Ç—ã',amount:9000,day:5},
  {id:'bp5',name:'–ú–æ–π —Ç–µ–ª–µ—Ñ–æ–Ω',amount:390,day:5},
  {id:'bp6',name:'–†–µ—Å–Ω–∏—Ü—ã',amount:2500,day:5},
  {id:'bp7',name:'–¢–∏–Ω—å–∫–æ—Ñ –∫—Ä–µ–¥–∏—Ç–∫–∞',amount:1900,day:5},
  {id:'bp8',name:'–ü—Ä–æ–¥—É–∫—Ç—ã',amount:8000,day:20},
  {id:'bp9',name:'–ú–∞–º–∞ —Å–≤—è–∑—å',amount:1500,day:20},
  {id:'bp10',name:'–†–µ—Å–Ω–∏—Ü—ã',amount:2500,day:20},
  {id:'bp11',name:'–ß–∞—Ç –≥–ø—Ç',amount:2500,day:20},
];
const INIT_KOPILKA = {
  balance:42369,
  timeline:[
    {id:'t1',type:'income',name:'–¥–µ–∫–∞–±—Ä—å 30',amount:15000,paid:true,isCredit:false,pastBal:76010},
    {id:'t2',type:'income',name:'—è–Ω–≤–∞—Ä—å 20',amount:22500,paid:true,isCredit:false,pastBal:86331},
    {id:'t3',type:'expense',name:'–º–∞–º–∞ –≤ –¥–æ–ª–≥ —Ñ–µ–≤—Ä–∞–ª—å 13',amount:70000,paid:true,isCredit:false,pastBal:16331},
    {id:'t4',type:'income',name:'—Ñ–µ–≤—Ä–∞–ª—å 5',amount:55500,paid:true,isCredit:false,pastBal:91831},
    {id:'t5',type:'expense',name:'–∫—Ä–µ–¥–∏—Ç —Ñ–µ–≤—Ä–∞–ª—å 5',amount:93000,paid:true,isCredit:true,pastBal:9192},
    {id:'t6',type:'income',name:'–º–∞–º–∞ –≤–æ–∑–≤—Ä–∞—Ç —Ñ–µ–≤—Ä–∞–ª—å 24',amount:50000,paid:true,isCredit:false,pastBal:59192},
    {id:'t7',type:'income',name:'—Ñ–µ–≤—Ä–∞–ª—å 20',amount:62800,paid:false,isCredit:false},
    {id:'t8',type:'expense',name:'–∫—Ä–µ–¥–∏—Ç —Ñ–µ–≤—Ä–∞–ª—å 20',amount:17000,paid:false,isCredit:true},
    {id:'t9',type:'income',name:'–º–∞—Ä—Ç 5',amount:21200,paid:false,isCredit:false},
    {id:'t10',type:'expense',name:'–∫—Ä–µ–¥–∏—Ç –º–∞—Ä—Ç 5',amount:93000,paid:false,isCredit:true},
    {id:'t11',type:'income',name:'–º–∞—Ä—Ç 20',amount:49000,paid:false,isCredit:false},
    {id:'t12',type:'expense',name:'–∫—Ä–µ–¥–∏—Ç –º–∞—Ä—Ç 20',amount:17000,paid:false,isCredit:true},
    {id:'t13',type:'income',name:'–∞–ø—Ä–µ–ª—å 5',amount:26900,paid:false,isCredit:false},
    {id:'t14',type:'expense',name:'–∫—Ä–µ–¥–∏—Ç –∞–ø—Ä–µ–ª—å 5',amount:93000,paid:false,isCredit:true},
    {id:'t15',type:'income',name:'–∞–ø—Ä–µ–ª—å 20',amount:60000,paid:false,isCredit:false},
    {id:'t16',type:'expense',name:'–∫—Ä–µ–¥–∏—Ç –∞–ø—Ä–µ–ª—å 20',amount:17000,paid:false,isCredit:true},
    {id:'t17',type:'income',name:'–º–∞–π 5',amount:15000,paid:false,isCredit:false},
    {id:'t18',type:'expense',name:'–∫—Ä–µ–¥–∏—Ç –º–∞–π 5',amount:93000,paid:false,isCredit:true},
  ]
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadState(){
  try{const s=localStorage.getItem('finance_v10');if(s)return JSON.parse(s);}catch(e){}
  return{periods:[],kopilka:{entries:[],balance:0},basePayments:JSON.parse(JSON.stringify(INIT_BASE_PAYMENTS)),currentIdx:0,salary:150000,excludedBPs:{}};
}
function saveState(){localStorage.setItem('finance_v10',JSON.stringify(state));}

let state = loadState();
let curTab = 'periods';
let editExpIdx = null;
let kopOpType = 'add';
let editBPIdx = null;
let bpDay = 5;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GOOGLE AUTH & SHEETS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let gAccessToken = null;
let gUserEmail   = null;
let tokenClient  = null;
let isSyncing    = false;

function setSyncStatus(status, label) {
  const badge = document.getElementById('sync-badge');
  const lbl   = document.getElementById('sync-label');
  badge.className = 'sync-badge ' + status;
  lbl.textContent = label;
}

function initGoogleAuth() {
  // Restore token from localStorage if available
  const saved = localStorage.getItem('gauth_v2');
  if (saved) {
    try {
      const d = JSON.parse(saved);
      if (d.email) { gUserEmail = d.email; }
    } catch(e) {}
  }

  // Wait for GSI to load
  const waitGSI = setInterval(() => {
    if (typeof google === 'undefined' || !google.accounts) return;
    clearInterval(waitGSI);

    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: GOOGLE_CLIENT_ID,
      scope: SCOPES,
      callback: async (resp) => {
        if (resp.error) { setSyncStatus('error','–æ—à–∏–±–∫–∞'); showToast('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏'); return; }
        gAccessToken = resp.access_token;
        // Save email for silent refresh on next load
        if (resp.access_token) {
          // Fetch user info to get email
          fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
            headers: { Authorization: `Bearer ${gAccessToken}` }
          }).then(r=>r.json()).then(info => {
            if (info.email) {
              gUserEmail = info.email;
              localStorage.setItem('gauth_v2', JSON.stringify({ email: info.email }));
              renderAuthCard();
            }
          }).catch(()=>{});
        }
        setSyncStatus('syncing','—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...');
        try {
          await initSheets();
          await syncFromSheets();
          setSyncStatus('connected','—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
          renderPeriod();
          renderKopilka();
        } catch(e) {
          setSyncStatus('error','–æ—à–∏–±–∫–∞');
          showToast('‚ùå ' + (e.message || '–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏'));
        }
        renderSettings();
      }
    });

    // Auto-try silent token refresh if we had email before
    if (gUserEmail) {
      setSyncStatus('syncing','–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ...');
      // Use 'select_account' only if no email, otherwise skip account chooser
      tokenClient.requestAccessToken({ prompt: 'none', login_hint: gUserEmail,
        error_callback: () => {
          // Silent failed ‚Äî need user interaction, show badge as offline
          setSyncStatus('offline','–æ—Ñ–ª–∞–π–Ω');
          renderAuthCard();
        }
      });
    }
  }, 200);
}

function signIn() {
  if (!tokenClient) {
    showToast('‚è≥ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
    let attempts = 0;
    const wait = setInterval(() => {
      attempts++;
      if (tokenClient) {
        clearInterval(wait);
        tokenClient.requestAccessToken({ prompt: 'consent' });
      } else if (attempts > 25) {
        clearInterval(wait);
        showToast('‚ùå –ü–æ–ø—Ä–æ–±—É–π –æ—Ç–∫—Ä—ã—Ç—å –≤ —Ä–µ–∂–∏–º–µ –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ (—Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –º–æ–≥—É—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å)');
      }
    }, 200);
    return;
  }
  tokenClient.requestAccessToken({ prompt: 'consent' });
}

function signOut() {
  if (gAccessToken) {
    google.accounts.oauth2.revoke(gAccessToken);
    gAccessToken = null;
  }
  gUserEmail = null;
  localStorage.removeItem('gauth_v2');
  setSyncStatus('offline','–æ—Ñ–ª–∞–π–Ω');
  renderSettings();
  showToast('üëã –û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç Google');
}

async function sheetsRequest(method, range, body) {
  if (!gAccessToken) throw new Error('–ù–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
  const base = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}`;
  let url, opts;

  if (method === 'GET') {
    url = `${base}/values/${encodeURIComponent(range)}?majorDimension=ROWS`;
    opts = { headers: { Authorization: `Bearer ${gAccessToken}` } };
  } else if (method === 'PUT') {
    url = `${base}/values/${encodeURIComponent(range)}?valueInputOption=USER_ENTERED`;
    opts = { method:'PUT', headers:{'Authorization':`Bearer ${gAccessToken}`,'Content-Type':'application/json'}, body:JSON.stringify(body) };
  } else if (method === 'CLEAR') {
    url = `${base}/values/${encodeURIComponent(range)}:clear`;
    opts = { method:'POST', headers:{'Authorization':`Bearer ${gAccessToken}`,'Content-Type':'application/json'}, body:'{}' };
  } else if (method === 'BATCH_UPDATE') {
    url = `${base}/values:batchUpdate`;
    opts = { method:'POST', headers:{'Authorization':`Bearer ${gAccessToken}`,'Content-Type':'application/json'}, body:JSON.stringify(body) };
  }

  const resp = await fetch(url, opts);
  if (!resp.ok) {
    const err = await resp.json().catch(() => ({}));
    // Token might be expired ‚Äî reset
    if (resp.status === 401) { gAccessToken = null; setSyncStatus('offline','–æ—Ñ–ª–∞–π–Ω'); }
    throw new Error(err.error?.message || `HTTP ${resp.status}`);
  }
  return resp.json();
}

// ‚îÄ‚îÄ‚îÄ Check if sheets exist and have headers, create if needed ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function initSheets() {
  // Get spreadsheet metadata to see existing sheet names
  const metaResp = await fetch(
    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}?fields=sheets.properties.title`,
    { headers: { Authorization: `Bearer ${gAccessToken}` } }
  );
  const meta = await metaResp.json();
  const existingSheets = meta.sheets?.map(s => s.properties.title) || [];

  // Just verify sheets exist, no headers needed
  const needed = [SH_PERIODS, SH_KOPILKA, SH_BP];
  for (const name of needed) {
    if (!existingSheets.includes(name)) {
      throw new Error(`–õ–∏—Å—Ç "${name}" –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞–π –µ–≥–æ –≤ —Ç–∞–±–ª–∏—Ü–µ.`);
    }
  }

  // Get user info
  try {
    const ui = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', { headers: { Authorization: `Bearer ${gAccessToken}` } });
    const ud = await ui.json();
    gUserEmail = ud.email;
    localStorage.setItem('gauth_v2', JSON.stringify({ email: gUserEmail }));
  } catch(e) {}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SYNC: READ FROM SHEETS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function syncFromSheets() {
  setSyncStatus('syncing','—á—Ç–µ–Ω–∏–µ...');

  // --- BASE PAYMENTS first (needed for auto-populate) ---
  const bpResp = await sheetsRequest('GET', `${SH_BP}!A1:C100`);
  const bpRows = bpResp.values || [];
  if (bpRows.length > 0) {
    const bps = bpRows
      .filter(r => r[0] && r[0] !== '–Ω–∞–∑–≤–∞–Ω–∏–µ' && r[0] !== 'name') // skip header if exists
      .map((r,i) => ({
        id: 'bp_'+i, name: r[0]||'',
        amount: parseFloat(String(r[1]||'').replace(/\s/g,''))||0,
        day: parseInt(r[2])||5,
      }))
      .filter(bp => bp.name && bp.amount > 0);
    if (bps.length > 0) state.basePayments = bps;
  }
  // No fallback write ‚Äî table is the source of truth

  // --- PERIODS ---
  const perResp = await sheetsRequest('GET', `${SH_PERIODS}!A1:ZZ500`);
  const perRows = perResp.values || [];

  if (perRows.length > 0) {
    const curName = state.periods[state.currentIdx]?.name;
    const periods = [];

    for (const row of perRows) {
      if (!row[0] || !row[1]) continue;
      const name   = row[0].trim();
      const income = parseFloat(String(row[1]).replace(/\s/g,'')) || 0;
      // Only read MANUAL expenses from –ü–µ—Ä–∏–æ–¥—ã sheet (not base payments)
      const manualExpenses = [];
      for (let c = 2; c + 1 < row.length; c += 3) {
        const expName = (row[c] || '').trim();
        const expAmt  = parseFloat(String(row[c+1] || '').replace(/\s/g,''));
        const expPaid = (row[c+2] || '').toString().toUpperCase() === 'TRUE';
        if (expName && !isNaN(expAmt) && expAmt > 0)
          manualExpenses.push({ name: expName, amount: expAmt, paid: expPaid, manual: true });
      }
      periods.push({ name, income, manualExpenses });
    }

    if (periods.length > 0) {
      // Build full expense list: base payments first, then manual
      periods.forEach(p => {
        const day = parseInt(p.name.match(/\d+$/)?.[0]) || 0;
        const bps = state.basePayments.filter(bp => bp.day === day);
        // Base payments: preserve paid status if period already existed
        const oldPeriod = state.periods.find(op => op.name === p.name);
        const basePaidMap = {};
        if (oldPeriod) {
          oldPeriod.expenses.forEach(e => { if (!e.manual) basePaidMap[e.name] = e.paid; });
        }
        const excludedForPeriod = (state.excludedBPs && state.excludedBPs[p.name.toLowerCase()]) || [];
        console.log('excludedBPs for', p.name, ':', excludedForPeriod);
        const baseExpenses = bps.map(bp => {
          // Skip if excluded for this period
          if (excludedForPeriod.includes(bp.name)) return null;
          // Check if this BP was manually overridden in the sheet for this period
          const manualOverride = p.manualExpenses.find(e => e.name === bp.name);
          if (manualOverride) return null;
          return {
            name: bp.name, amount: bp.amount,
            paid: basePaidMap[bp.name] || false,
            manual: false
          };
        }).filter(Boolean);
        p.expenses = [...baseExpenses, ...p.manualExpenses];
        delete p.manualExpenses;
      });

      state.periods = periods;
      const newIdx = periods.findIndex(p => p.name === curName);
      if (newIdx >= 0) {
        state.currentIdx = newIdx;
      } else {
        let best = 0;
        for (let i = 0; i < periods.length; i++) {
          const pd = getPeriodDate(periods[i].name);
          const today = new Date(); today.setHours(0,0,0,0);
          if (pd && pd <= today) best = i;
        }
        state.currentIdx = best;
      }

      // No need to write back ‚Äî base payments are NOT stored in –ü–µ—Ä–∏–æ–¥—ã sheet
    }
  }

  // --- KOPILKA ---
  // Format: –ø–µ—Ä–∏–æ–¥ | —Ç–∏–ø | –Ω–∞–∑–≤–∞–Ω–∏–µ | —Å—É–º–º–∞ | –æ–ø–ª–∞—á–µ–Ω–æ
  // —Ç–∏–ø: '–±–∞–ª–∞–Ω—Å' | '–≤ –∫–æ–ø–∏–ª–∫—É' | '–∏–∑ –∫–æ–ø–∏–ª–∫–∏' | '–∫—Ä–µ–¥–∏—Ç'
  const kopResp = await sheetsRequest('GET', `${SH_KOPILKA}!A1:E500`);
  const kopRows = kopResp.values || [];
  if (kopRows.length > 0) {
    const entries = kopRows
      .filter(r => r[0] && r[3] && r[0] !== '–ø–µ—Ä–∏–æ–¥')
      .map((r, i) => {
        const period = (r[0]||'').trim();
        const typ = (r[1]||'').trim();
        const name = (r[2]||'').trim();
        const stableId = 'k_' + period.toLowerCase().replace(/\s+/g,'_') + '__' + typ.toLowerCase().replace(/\s+/g,'_');
        return {
          id: stableId,
          period, typ, name,
          amount: parseFloat(String(r[3]||'').replace(/\s/g,''))||0,
          paid: (r[4]||'').toString().toUpperCase() === 'TRUE',
          rowIndex: i + 1,
        };
      })
      .filter(e => e.amount > 0);
    if (entries.length > 0) {
      state.kopilka.entries = entries;
      recalcKopilkaBalance();
      injectKopilkaIntoPeriods();
      // Debug: log what was read
      console.log('Kopilka entries:', entries.map(e => e.period + ' | ' + e.typ + ' | ' + e.amount + ' | paid:' + e.paid));
      console.log('Kopilka balance:', state.kopilka.balance);
    }
  }

  saveState();
}

function recalcKopilkaBalance() {
  if (!state.kopilka.entries || !state.kopilka.entries.length) return;
  let bal = 0;
  state.kopilka.entries.forEach(e => {
    if (!e.paid) return;
    const t = e.typ.toLowerCase().trim();
    if (t === '–±–∞–ª–∞–Ω—Å' || t === '–≤ –∫–æ–ø–∏–ª–∫—É') bal += e.amount;
    else bal -= e.amount; // '–∏–∑ –∫–æ–ø–∏–ª–∫–∏', '–∫—Ä–µ–¥–∏—Ç'
  });
  state.kopilka.balance = bal;
}

function injectKopilkaIntoPeriods() {
  // First clear ALL fromKopilka entries from all periods
  state.periods.forEach(p => {
    p.expenses = p.expenses.filter(e => !e.fromKopilka);
  });
  // Then inject current kopilka entries into matching periods
  (state.kopilka.entries || []).forEach(kEntry => {
    if (kEntry.typ.toLowerCase().trim() !== '–≤ –∫–æ–ø–∏–ª–∫—É') return;
    const p = state.periods.find(p => p.name.toLowerCase().trim() === kEntry.period.toLowerCase().trim());
    if (!p) return;
    // Only inject once per period (skip if already injected)
    if (p.expenses.some(e => e.fromKopilka)) return;
    p.expenses.unshift({
      name: '–í –∫–æ–ø–∏–ª–∫—É',
      amount: kEntry.amount,
      paid: kEntry.paid,
      manual: false,
      fromKopilka: true,
      kopilkaId: kEntry.id,
    });
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SYNC: WRITE TO SHEETS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function writeKopilkaToSheets() {
  // Write full kopilka table (period | —Ç–∏–ø | –Ω–∞–∑–≤–∞–Ω–∏–µ | —Å—É–º–º–∞ | –æ–ø–ª–∞—á–µ–Ω–æ)
  const rows = state.kopilka.entries.map(e => [
    e.period, e.typ, e.name, e.amount,
    e.paid ? 'TRUE' : 'FALSE'
  ]);
  await sheetsRequest('CLEAR', `${SH_KOPILKA}!A1:E500`);
  if (rows.length > 0) {
    await sheetsRequest('PUT', `${SH_KOPILKA}!A1`, { range:`${SH_KOPILKA}!A1`, majorDimension:'ROWS', values: rows });
  }
}

// Write only the paid status of one entry (by rowIndex)
async function writeKopilkaRowPaid(entry) {
  if (!gAccessToken || !entry.rowIndex) return;
  const row = entry.rowIndex;
  await sheetsRequest('PUT', `${SH_KOPILKA}!E${row}`, {
    range: `${SH_KOPILKA}!E${row}`,
    majorDimension: 'ROWS',
    values: [[entry.paid ? 'TRUE' : 'FALSE']]
  });
}

// Write only the amount of one entry (by rowIndex)
async function writeKopilkaRowAmount(entry) {
  if (!gAccessToken || !entry.rowIndex) return;
  const row = entry.rowIndex;
  await sheetsRequest('PUT', `${SH_KOPILKA}!D${row}`, {
    range: `${SH_KOPILKA}!D${row}`,
    majorDimension: 'ROWS',
    values: [[entry.amount]]
  });
}

async function writeBPToSheets() {
  const rows = state.basePayments.map(bp => [bp.name, bp.amount, bp.day]);
  await sheetsRequest('CLEAR', `${SH_BP}!A1:C100`);
  await sheetsRequest('PUT', `${SH_BP}!A1`, { range:`${SH_BP}!A1`, majorDimension:'ROWS', values: rows });
}

// ‚îÄ‚îÄ‚îÄ Write period row: only income + manual expenses (base payments NOT stored in –ü–µ—Ä–∏–æ–¥—ã) ‚îÄ‚îÄ
async function writePeriodRow(periodIdx) {
  if (!gAccessToken) return;
  const p = state.periods[periodIdx];
  const sheetRow = periodIdx + 1;
  const row = [p.name, p.income];
  // Only write manual expenses to the sheet
  p.expenses.filter(e => e.manual).forEach(e => {
    row.push(e.name, e.amount, e.paid ? 'TRUE' : 'FALSE');
  });
  // First clear the entire row (up to col ZZ), then write fresh data
  await sheetsRequest('CLEAR', `${SH_PERIODS}!A${sheetRow}:ZZ${sheetRow}`);
  await sheetsRequest('PUT', `${SH_PERIODS}!A${sheetRow}`, {
    range: `${SH_PERIODS}!A${sheetRow}`,
    majorDimension: 'ROWS',
    values: [row]
  });
}

// ‚îÄ‚îÄ‚îÄ Debounced sync wrapper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let syncTimer = null;
function scheduleSync(writeFn) {
  if (!gAccessToken) return;
  clearTimeout(syncTimer);
  syncTimer = setTimeout(async () => {
    setSyncStatus('syncing','—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...');
    try {
      await writeFn();
      setSyncStatus('connected','—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
    } catch(e) {
      setSyncStatus('error','–æ—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏');
      showToast('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü—É');
    }
  }, 800);
}

async function manualSync() {
  if (!gAccessToken) { signIn(); return; }
  setSyncStatus('syncing','—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...');
  try {
    await syncFromSheets();
    setSyncStatus('connected','—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
    showToast('üîÑ –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!');
    renderPeriod();
    if (curTab === 'kopilka') renderKopilka();
    if (curTab === 'settings') renderSettings();
  } catch(e) {
    setSyncStatus('error','–æ—à–∏–±–∫–∞');
    showToast('‚ùå ' + (e.message || '–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏'));
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function fmt(n){return Math.round(n).toLocaleString('ru-RU')+' ‚ÇΩ';}
let toastTimer=null;
function showToast(msg, duration){
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.classList.add('show');
  if(toastTimer)clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>t.classList.remove('show'), duration||2500);
}
function closeModal(id){document.getElementById(id).classList.remove('open');}
function openModal(id){document.getElementById(id).classList.add('open');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchTab(tab){
  curTab=tab;
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(n=>n.classList.remove('active'));
  document.getElementById('screen-'+tab).classList.add('active');
  const nav=document.getElementById('nav-'+tab);if(nav)nav.classList.add('active');
  if(tab==='kopilka')renderKopilka();
  if(tab==='periods')renderPeriod();
  if(tab==='settings')renderSettings();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PERIODS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function changePeriod(dir){
  const ni=state.currentIdx+dir;
  if(ni<0||ni>=state.periods.length)return;
  state.currentIdx=ni;saveState();renderPeriod();
}

function renderPeriod(){
  if(!state.periods.length){
    document.getElementById('period-name').textContent='‚Äî';
    document.getElementById('hero-income').textContent='0 ‚ÇΩ';
    document.getElementById('hero-exp').textContent='0 ‚ÇΩ';
    document.getElementById('hero-paid').textContent='0 ‚ÇΩ';
    const le=document.getElementById('hero-left');le.textContent='0 ‚ÇΩ';le.className='hero-stat-val yellow';
    document.getElementById('prog-pct').textContent='0%';
    document.getElementById('prog-fill').style.width='0%';
    document.getElementById('btn-prev').disabled=true;
    document.getElementById('btn-next').disabled=true;
    document.getElementById('mk-val').textContent=fmt(state.kopilka.balance);
    document.getElementById('exp-list').innerHTML='<div class="empty-state"><div class="empty-ico">üîÑ</div><div class="empty-txt">–í–æ–π–¥–∏ —á–µ—Ä–µ–∑ Google<br>—á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–µ—Ä–∏–æ–¥—ã</div></div>';
    return;
  }
  const p=state.periods[state.currentIdx];
  document.getElementById('period-name').textContent=p.name;
  document.getElementById('hero-income').textContent=fmt(p.income);
  const totalExp=p.expenses.reduce((s,e)=>s+e.amount,0);
  const paidExp=p.expenses.filter(e=>e.paid).reduce((s,e)=>s+e.amount,0);
  const leftover=p.income-totalExp;
  document.getElementById('hero-exp').textContent=fmt(totalExp);
  document.getElementById('hero-paid').textContent=fmt(paidExp);
  const le=document.getElementById('hero-left');
  le.textContent=fmt(leftover);
  le.className='hero-stat-val '+(leftover<0?'coral':'yellow');
  const pct=totalExp>0?Math.round(paidExp/totalExp*100):0;
  document.getElementById('prog-pct').textContent=pct+'%';
  const fill=document.getElementById('prog-fill');
  fill.style.width=Math.min(pct,100)+'%';
  fill.className='prog-fill'+(pct>=100?' danger':pct>=70?' warn':'');
  document.getElementById('btn-prev').disabled=state.currentIdx===0;
  document.getElementById('btn-next').disabled=state.currentIdx===state.periods.length-1;
  document.getElementById('mk-val').textContent=fmt(state.kopilka.balance);

  const isFuture=!isCurrentOrPastPeriod(state.currentIdx);
  const list=document.getElementById('exp-list');list.innerHTML='';

  if(isFuture){
    const notice=document.createElement('div');
    notice.style.cssText='margin:0 0 12px;padding:10px 16px;background:var(--yellow-light);border-radius:var(--rs);font-size:13px;font-weight:600;color:#B8860B;display:flex;align-items:center;gap:8px;';
    notice.innerHTML='‚è≥ –≠—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥ –µ—â—ë –Ω–µ –Ω–∞—Å—Ç—É–ø–∏–ª ‚Äî –æ—Ç–º–µ—Ç–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞';
    list.appendChild(notice);
  }
  if(!p.expenses.length){
    const empty=document.createElement('div');
    empty.innerHTML='<div class="empty-state"><div class="empty-ico">üéâ</div><div class="empty-txt">–†–∞—Å—Ö–æ–¥–æ–≤ –Ω–µ—Ç</div></div>';
    list.appendChild(empty);return;
  }
  p.expenses.forEach((exp,i)=>{
    const el=document.createElement('div');
    el.className='exp-item'+(exp.paid?' paid':'')+(isFuture?' future-locked':'');
    el.innerHTML=`
      <div class="exp-check ${isFuture?'locked':''}" ${isFuture?'':`onclick="toggleExp(${i})"`}>${exp.paid?'‚úì':(isFuture?'üîí':'')}</div>
      <div class="exp-info"><div class="exp-name">${exp.name}</div></div>
      <div class="exp-amt">${fmt(exp.amount)}</div>
      <div class="exp-actions">
        <button class="exp-btn" onclick="openEditExp(${i})">‚úèÔ∏è</button>
        <button class="exp-btn del" onclick="deleteExp(${i})">‚úï</button>
      </div>`;
    list.appendChild(el);
  });
}

const MONTH_MAP={'—è–Ω–≤–∞—Ä—å':0,'—Ñ–µ–≤—Ä–∞–ª—å':1,'–º–∞—Ä—Ç':2,'–∞–ø—Ä–µ–ª—å':3,'–º–∞–π':4,'–∏—é–Ω—å':5,'–∏—é–ª—å':6,'–∞–≤–≥—É—Å—Ç':7,'—Å–µ–Ω—Ç—è–±—Ä—å':8,'–æ–∫—Ç—è–±—Ä—å':9,'–Ω–æ—è–±—Ä—å':10,'–¥–µ–∫–∞–±—Ä—å':11};
function getPeriodDate(name){
  const parts=name.trim().split(' ');const month=MONTH_MAP[parts[0]];const day=parseInt(parts[1]);
  if(month===undefined||isNaN(day))return null;
  const now=new Date();let year=now.getFullYear();const testDate=new Date(year,month,day);
  const sixMonths=180*24*3600*1000;
  if(testDate-now>sixMonths)year--;else if(now-testDate>sixMonths)year++;
  return new Date(year,month,day);
}
function isCurrentOrPastPeriod(idx){
  const p=state.periods[idx];const pd=getPeriodDate(p.name);if(!pd)return true;
  const today=new Date();today.setHours(0,0,0,0);return pd<=today;
}

function toggleExp(i){
  if(!isCurrentOrPastPeriod(state.currentIdx)){showToast('‚è≥ –≠—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥ –µ—â—ë –Ω–µ –Ω–∞—Å—Ç—É–ø–∏–ª');return;}
  const p=state.periods[state.currentIdx];
  const exp=p.expenses[i];
  exp.paid=!exp.paid;

  if(exp.fromKopilka){
    // Sync paid status back to kopilka entry
    const kEntry=(state.kopilka.entries||[]).find(e=>e.id===exp.kopilkaId);
    if(kEntry){
      kEntry.paid=exp.paid;
      recalcKopilkaBalance();
      document.getElementById('mk-val').textContent=fmt(state.kopilka.balance);
      showToast(exp.paid?'üí∞ +'+fmt(exp.amount)+' –≤ –∫–æ–ø–∏–ª–∫—É!':'‚Ü©Ô∏è –£–±—Ä–∞–Ω–æ –∏–∑ –∫–æ–ø–∏–ª–∫–∏');
      scheduleSync(()=>writeKopilkaRowPaid(kEntry));
    }
  }else{
    showToast(exp.paid?'‚úÖ –û–ø–ª–∞—á–µ–Ω–æ!':'‚Ü©Ô∏è –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ');
    scheduleSync(()=>writePeriodRow(state.currentIdx));
  }
  saveState();renderPeriod();
}

function deleteExp(i){
  if(!confirm('–£–¥–∞–ª–∏—Ç—å —Ä–∞—Å—Ö–æ–¥?'))return;
  const p = state.periods[state.currentIdx];
  const exp = p.expenses[i];
  // If base payment (not manual, not from kopilka) ‚Äî record exclusion so it doesn't come back on sync
  if(!exp.manual && !exp.fromKopilka){
    if(!state.excludedBPs) state.excludedBPs = {};
    const _epKey = p.name.toLowerCase();
    if(!state.excludedBPs[_epKey]) state.excludedBPs[_epKey] = [];
    if(!state.excludedBPs[_epKey].includes(exp.name))
      state.excludedBPs[_epKey].push(exp.name);
    console.log('Saved exclusion:', _epKey, exp.name, state.excludedBPs);
  }
  p.expenses.splice(i,1);
  saveState();renderPeriod();showToast('üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ');
  if(gAccessToken){
    setSyncStatus('syncing','—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...');
    writePeriodRow(state.currentIdx).then(()=>setSyncStatus('connected','—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ')).catch(()=>setSyncStatus('error','–æ—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏'));
  }
}

function openAddExpense(){
  editExpIdx=null;
  document.getElementById('modal-exp-title').textContent='–ù–æ–≤—ã–π —Ä–∞—Å—Ö–æ–¥';
  document.getElementById('exp-name-in').value='';
  document.getElementById('exp-amt-in').value='';
  openModal('modal-expense');
  setTimeout(()=>document.getElementById('exp-name-in').focus(),300);
}
function openEditExp(i){
  const e=state.periods[state.currentIdx].expenses[i];
  // If this is a kopilka-injected expense, open kopilka amount editor
  if(e.fromKopilka){
    openEditKopilkaEntry(e.kopilkaId);
    return;
  }
  editExpIdx=i;
  document.getElementById('modal-exp-title').textContent='–ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞—Å—Ö–æ–¥';
  document.getElementById('exp-name-in').value=e.name;
  document.getElementById('exp-amt-in').value=e.amount;
  openModal('modal-expense');
}

function openEditKopilkaEntry(kopilkaId){
  const entry=(state.kopilka.entries||[]).find(e=>e.id===kopilkaId);
  if(!entry)return;
  document.getElementById('kop-edit-id').value=kopilkaId;
  document.getElementById('kop-edit-amt').value=entry.amount;
  document.getElementById('kop-edit-period').textContent=entry.period;
  openModal('modal-kop-edit');
  setTimeout(()=>document.getElementById('kop-edit-amt').select(),300);
}

function saveKopilkaEntryEdit(){
  const id=document.getElementById('kop-edit-id').value;
  const amt=parseFloat(document.getElementById('kop-edit-amt').value);
  if(isNaN(amt)||amt<=0){showToast('‚ö†Ô∏è –í–≤–µ–¥–∏ —Å—É–º–º—É');return;}
  const entry=(state.kopilka.entries||[]).find(e=>e.id===id);
  if(!entry)return;
  entry.amount=amt;
  recalcKopilkaBalance();
  injectKopilkaIntoPeriods();
  saveState();
  closeModal('modal-kop-edit');
  renderPeriod();
  if(curTab==='kopilka')renderKopilka();
  document.getElementById('mk-val').textContent=fmt(state.kopilka.balance);
  showToast('‚úÖ –°—É–º–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
  // Write only the changed cell immediately
  if(gAccessToken){
    const editId=document.getElementById('kop-edit-id').value;
    const target=(state.kopilka.entries||[]).find(e=>e.id===editId);
    if(target){
      setSyncStatus('syncing','—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...');
      writeKopilkaRowAmount(target)
        .then(()=>setSyncStatus('connected','—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ'))
        .catch(()=>setSyncStatus('error','–æ—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏'));
    }
  }
}
function saveExpense(){
  const name=document.getElementById('exp-name-in').value.trim();
  const amount=parseFloat(document.getElementById('exp-amt-in').value);
  if(!name||isNaN(amount)||amount<=0){showToast('‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è');return;}
  const p=state.periods[state.currentIdx];
  if(editExpIdx!==null){
    const exp=p.expenses[editExpIdx];
    exp.name=name;
    exp.amount=amount;
    // If this was a base payment and something changed ‚Äî mark as manual so it saves to sheet
    if(!exp.manual) exp.manual=true;
    showToast('‚úèÔ∏è –ò–∑–º–µ–Ω–µ–Ω–æ!');
  } else {
    const isKopilka = name.toLowerCase().includes('–∫–æ–ø–∏–ª–∫');
    if(isKopilka){
      // Create entry in kopilka sheet instead of period sheet
      const periodName = p.name.toLowerCase();
      const stableId = 'k_' + periodName.replace(/\s+/g,'_') + '__–≤_–∫–æ–ø–∏–ª–∫—É';
      // Check if entry already exists for this period
      const existing = (state.kopilka.entries||[]).find(e=>e.id===stableId);
      if(existing){
        existing.amount = amount;
      } else {
        if(!state.kopilka.entries) state.kopilka.entries=[];
        // Insert before first unpaid entry
        const firstUnpaidIdx = state.kopilka.entries.findIndex(e=>!e.paid);
        const newEntry = {
          id: stableId,
          period: p.name,
          typ: '–≤ –∫–æ–ø–∏–ª–∫—É',
          name: '–í –∫–æ–ø–∏–ª–∫—É',
          amount,
          paid: false,
          rowIndex: 0,
        };
        if(firstUnpaidIdx===-1) state.kopilka.entries.push(newEntry);
        else state.kopilka.entries.splice(firstUnpaidIdx,0,newEntry);
      }
      recalcKopilkaBalance();
      injectKopilkaIntoPeriods();
      document.getElementById('mk-val').textContent=fmt(state.kopilka.balance);
      showToast('‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ–ø–∏–ª–∫—É!');
      saveState();closeModal('modal-expense');renderPeriod();
      if(gAccessToken){
        setSyncStatus('syncing','—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...');
        writeKopilkaToSheets()
          .then(()=>setSyncStatus('connected','—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ'))
          .catch(()=>setSyncStatus('error','–æ—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏'));
      }
      return;
    }
    p.expenses.push({name,amount,paid:false,manual:true});
    showToast('‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ!');
  }
  saveState();closeModal('modal-expense');renderPeriod();
  scheduleSync(()=>writePeriodRow(state.currentIdx));
}

function openEditIncome(){
  document.getElementById('income-in').value=state.periods[state.currentIdx].income;
  openModal('modal-income');
  setTimeout(()=>document.getElementById('income-in').select(),300);
}
function saveIncome(){
  const v=parseFloat(document.getElementById('income-in').value);
  if(isNaN(v)||v<0){showToast('‚ö†Ô∏è –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—É–º–º–∞');return;}
  state.periods[state.currentIdx].income=v;
  saveState();closeModal('modal-income');renderPeriod();showToast('üí∏ –°—É–º–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
  scheduleSync(()=>writePeriodRow(state.currentIdx));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KOPILKA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderKopilka(showAllHistory) {
  document.getElementById('kop-balance').textContent = fmt(state.kopilka.balance);
  const container = document.getElementById('kop-timeline');
  container.innerHTML = '';
  const entries = state.kopilka.entries || [];
  // Skip '–±–∞–ª–∞–Ω—Å' entry in timeline display
  const items = entries.filter(e => e.typ.toLowerCase().trim() !== '–±–∞–ª–∞–Ω—Å');
  const pastItems   = items.filter(e => e.paid);
  const futureItems = items.filter(e => !e.paid);

  // Running balance for future items
  let runBal = state.kopilka.balance;
  const futureWithBal = futureItems.map(e => {
    const balBefore = runBal;
    if (e.typ.toLowerCase().trim() === '–≤ –∫–æ–ø–∏–ª–∫—É') runBal += e.amount;
    else runBal -= e.amount;
    return { ...e, balBefore, balAfter: runBal };
  });

  // HISTORY section
  if (pastItems.length) {
    const HIST_LIMIT = 3;
    const showAll = showAllHistory === true;
    const hiddenCount = Math.max(0, pastItems.length - HIST_LIMIT);
    const visiblePast = showAll ? pastItems : pastItems.slice(-HIST_LIMIT);

    const hdr = document.createElement('div');
    hdr.className = 'tl-section-hdr';
    hdr.innerHTML = '–ò—Å—Ç–æ—Ä–∏—è <span style="font-size:10px;opacity:.6;font-family:\'Nunito\';text-transform:none;font-weight:600;letter-spacing:0">' + pastItems.length + ' –æ–ø–µ—Ä–∞—Ü–∏–π</span>';
    container.appendChild(hdr);

    if (!showAll && hiddenCount > 0) {
      const btn = document.createElement('button');
      btn.style.cssText = 'display:block;width:calc(100% - 48px);margin:0 24px 8px;padding:10px;background:var(--white);border:2px dashed #D8D5E8;border-radius:var(--rs);font-family:\'Nunito\',sans-serif;font-size:13px;font-weight:700;color:var(--ink-muted);cursor:pointer;';
      btn.textContent = '‚Üë –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é (' + hiddenCount + ' —Å–∫—Ä—ã—Ç–æ)';
      btn.onclick = () => renderKopilka(true);
      container.appendChild(btn);
    }
    visiblePast.forEach(e => container.appendChild(makeKopEntry(e, 'past', null)));
    if (showAll && hiddenCount > 0) {
      const btn = document.createElement('button');
      btn.style.cssText = 'display:block;width:calc(100% - 48px);margin:6px 24px 0;padding:10px;background:var(--white);border:2px dashed #D8D5E8;border-radius:var(--rs);font-family:\'Nunito\',sans-serif;font-size:13px;font-weight:700;color:var(--ink-muted);cursor:pointer;';
      btn.textContent = '‚Üì –°–≤–µ—Ä–Ω—É—Ç—å –∏—Å—Ç–æ—Ä–∏—é';
      btn.onclick = () => renderKopilka(false);
      container.appendChild(btn);
    }
  }

  // PLANNED section
  if (futureItems.length) {
    const hdr = document.createElement('div');
    hdr.className = 'tl-section-hdr';
    hdr.style.marginTop = pastItems.length ? '10px' : '0';
    hdr.textContent = '–ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è';
    container.appendChild(hdr);
    futureWithBal.forEach(e => {
      const isShort = (e.typ === '–∫—Ä–µ–¥–∏—Ç' || e.typ === '–∏–∑ –∫–æ–ø–∏–ª–∫–∏') && e.balBefore < e.amount;
      container.appendChild(makeKopEntry(e, 'future', e.balAfter, isShort));
    });
  }
}

function makeKopEntry(e, section, balAfter, isShort) {
  const t_ = e.typ.toLowerCase().trim();
  const isIncome = t_ === '–≤ –∫–æ–ø–∏–ª–∫—É';
  const isCredit = t_ === '–∫—Ä–µ–¥–∏—Ç';
  const el = document.createElement('div');
  el.className = 'tl-item ' + section + (isShort ? ' danger-row' : '');

  const dotClass = 'tl-dot ' + (isIncome ? 'inc' : 'exp') + ' ' + section;
  const amtClass = 'tl-amt ' + (isIncome ? 'inc' : 'exp') + ' ' + section;
  const sign = isIncome ? '+' : '‚àí';
  const symbol = isIncome ? '‚Üë' : '‚Üì';

  // Balance hint
  let balHtml = '';
  if (section === 'past') {
    // Compute running balance up to this entry from entries array
    let bal = 0;
    for (const en of (state.kopilka.entries || [])) {
      if (en.typ === '–±–∞–ª–∞–Ω—Å') { bal = en.amount; }
      else if (en.typ === '–≤ –∫–æ–ø–∏–ª–∫—É') bal += en.amount;
      else bal -= en.amount;
      if (en.id === e.id) break;
    }
    balHtml = `<div class="tl-bal ok" style="color:#aaa">‚Üí ${fmt(bal)}</div>`;
  } else if (balAfter !== null && balAfter !== undefined) {
    const ok = balAfter >= 0;
    const short = ok ? '' : ' (' + fmt(Math.abs(balAfter)) + ' –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç)';
    balHtml = `<div class="tl-bal ${ok ? 'ok' : 'warn'}">‚Üí ${fmt(balAfter)}${short}</div>`;
  }

  // Right side
  let rightHtml = '';
  if (isCredit && section === 'future') {
    rightHtml = `<div class="tl-right-col"><div class="${amtClass}">${sign}${fmt(e.amount)}</div></div>` +
      (isShort ? '<div class="tl-warn-icon">‚ö†Ô∏è</div>' : '') +
      `<button class="tl-check unpaid" onclick="toggleKopEntry('${e.id}')">‚óã</button>`;
  } else if (isCredit && section === 'past') {
    rightHtml = `<div class="${amtClass}">${sign}${fmt(e.amount)}</div><div class="tl-check paid" style="cursor:default;pointer-events:none">‚úì</div>`;
  } else if (!isIncome && section === 'future') {
    // '–∏–∑ –∫–æ–ø–∏–ª–∫–∏' ‚Äî also toggleable
    rightHtml = `<div class="tl-right-col"><div class="${amtClass}">${sign}${fmt(e.amount)}</div></div>` +
      (isShort ? '<div class="tl-warn-icon">‚ö†Ô∏è</div>' : '') +
      `<button class="tl-check unpaid" onclick="toggleKopEntry('${e.id}')">‚óã</button>`;
  } else {
    rightHtml = `<div class="${amtClass}">${sign}${fmt(e.amount)}</div>`;
  }

  el.innerHTML = `<div class="${dotClass}">${symbol}</div><div class="tl-info"><div class="tl-name">${e.name}</div>${balHtml}</div><div class="tl-right">${rightHtml}</div>`;
  return el;
}

function toggleKopEntry(id) {
  const e = (state.kopilka.entries || []).find(x => x.id === id);
  if (!e) return;
  e.paid = !e.paid;
  recalcKopilkaBalance();
  injectKopilkaIntoPeriods();
  saveState();
  renderKopilka();
  renderPeriod();
  document.getElementById('mk-val').textContent = fmt(state.kopilka.balance);
  showToast(e.paid ? '‚úÖ –û—Ç–º–µ—á–µ–Ω–æ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–º' : '‚Ü©Ô∏è –û—Ç–º–µ–Ω–µ–Ω–æ');
  scheduleSync(() => writeKopilkaRowPaid(e));
}

function openKopilkaOp(type) {
  kopOpType = type;
  document.getElementById('modal-kop-title').textContent = type === 'add' ? '+ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –∫–æ–ø–∏–ª–∫—É' : '‚àí –°–Ω—è—Ç—å –∏–∑ –∫–æ–ø–∏–ª–∫–∏';
  document.getElementById('kop-amt-in').value = '';
  document.getElementById('kop-comment-in').value = '';
  openModal('modal-kop');
  setTimeout(() => document.getElementById('kop-amt-in').focus(), 300);
}

function saveKopOp() {
  const a = parseFloat(document.getElementById('kop-amt-in').value);
  const c = document.getElementById('kop-comment-in').value.trim() || (kopOpType === 'add' ? '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ' : '–°–Ω—è—Ç–∏–µ');
  if (isNaN(a) || a <= 0) { showToast('‚ö†Ô∏è –í–≤–µ–¥–∏ —Å—É–º–º—É'); return; }
  const isAdd = kopOpType === 'add';
  const entries = state.kopilka.entries || [];
  const firstUnpaidIdx = entries.findIndex(e => !e.paid);
  const newEntry = {
    id: 'manual_' + Date.now(),
    period: '–≤—Ä—É—á–Ω—É—é',
    typ: isAdd ? '–≤ –∫–æ–ø–∏–ª–∫—É' : '–∏–∑ –∫–æ–ø–∏–ª–∫–∏',
    name: c,
    amount: a,
    paid: true,
    rowIndex: 0,
  };
  if (firstUnpaidIdx === -1) entries.push(newEntry);
  else entries.splice(firstUnpaidIdx, 0, newEntry);
  state.kopilka.entries = entries;
  recalcKopilkaBalance();
  injectKopilkaIntoPeriods();
  saveState();
  closeModal('modal-kop');
  renderKopilka();
  document.getElementById('mk-val').textContent = fmt(state.kopilka.balance);
  showToast(isAdd ? 'üí∞ –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ–ø–∏–ª–∫—É!' : 'üí∏ –°–Ω—è—Ç–æ –∏–∑ –∫–æ–ø–∏–ª–∫–∏!');
  scheduleSync(() => writeKopilkaToSheets());
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSettings(){
  renderBPList();
  renderAuthCard();
}

function renderAuthCard(){
  const el=document.getElementById('auth-card-content');
  if(!el) return;
  if(gAccessToken&&gUserEmail){
    el.innerHTML=`
      <div class="auth-status-row">
        <div><div class="set-row-lbl">‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ</div><div class="auth-sub">${gUserEmail}</div></div>
      </div>
      <div class="auth-status-row">
        <div><div class="set-row-lbl">–¢–∞–±–ª–∏—Ü–∞</div><div class="auth-sub">–ú–æ–∏ —Ç—Ä–∞—Ç—ã 2025</div></div>
        <a href="https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}" target="_blank" style="font-size:12px;color:var(--violet);font-weight:700;text-decoration:none">–û—Ç–∫—Ä—ã—Ç—å ‚Üí</a>
      </div>
      <button class="auth-btn disconnect" style="margin-top:14px" onclick="signOut()">–û—Ç–∫–ª—é—á–∏—Ç—å Google –∞–∫–∫–∞—É–Ω—Ç</button>`;
  } else if(gUserEmail && !gAccessToken) {
    // Email known but token not yet restored ‚Äî show loading
    el.innerHTML=`
      <div class="set-row-lbl" style="margin-bottom:6px">üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏...</div>
      <div class="auth-sub" style="font-size:13px;color:var(--ink-muted)">${gUserEmail}</div>`;
  } else {
    el.innerHTML=`
      <div class="set-row-lbl" style="margin-bottom:6px">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</div>
      <div class="auth-sub" style="font-size:13px;color:var(--ink-muted);line-height:1.5;margin-bottom:14px">–ü–æ–¥–∫–ª—é—á–∏ Google –∞–∫–∫–∞—É–Ω—Ç, —á—Ç–æ–±—ã –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è–ª–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ –∏ –±—ã–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã —Å –ª—é–±–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</div>
      <button class="auth-btn google" onclick="signIn()">üîë –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>`;
  }
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BASE PAYMENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderBPList(){
  const container=document.getElementById('bp-list');container.innerHTML='';
  if(!state.basePayments.length){container.innerHTML='<div class="empty-state"><div class="empty-ico">üìã</div><div class="empty-txt">–ë–∞–∑–æ–≤—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π –Ω–µ—Ç</div></div>';return;}
  [5,20].forEach(day=>{
    const items=state.basePayments.filter(bp=>bp.day===day);if(!items.length)return;
    const hdr=document.createElement('div');
    hdr.style.cssText='font-size:11px;font-weight:700;color:var(--ink-muted);text-transform:uppercase;letter-spacing:.5px;margin:10px 0 6px;';
    hdr.textContent=day===5?'üìÖ 5 —á–∏—Å–ª–∞':'üìÖ 20 —á–∏—Å–ª–∞';container.appendChild(hdr);
    items.forEach(bp=>{
      const idx=state.basePayments.indexOf(bp);
      const el=document.createElement('div');el.className='bp-item';
      el.innerHTML=`<div class="bp-badge ${day===5?'d5':'d20'}">${day}</div><div class="bp-info"><div class="bp-name">${bp.name}</div><div class="bp-sub">${day} —á–∏—Å–ª–∞ –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞</div></div><div class="bp-amt">${fmt(bp.amount)}</div><div class="bp-actions"><button class="bp-btn" onclick="openEditBP(${idx})">‚úèÔ∏è</button><button class="bp-btn del" onclick="deleteBP(${idx})">‚úï</button></div>`;
      container.appendChild(el);
    });
  });
}

function openAddBP(){editBPIdx=null;bpDay=5;document.getElementById('modal-bp-title').textContent='–ù–æ–≤—ã–π –±–∞–∑–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂';document.getElementById('bp-name-in').value='';document.getElementById('bp-amt-in').value='';selectBPDay(5);openModal('modal-bp');setTimeout(()=>document.getElementById('bp-name-in').focus(),300);}
function openEditBP(idx){editBPIdx=idx;const bp=state.basePayments[idx];document.getElementById('modal-bp-title').textContent='–ò–∑–º–µ–Ω–∏—Ç—å –±–∞–∑–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂';document.getElementById('bp-name-in').value=bp.name;document.getElementById('bp-amt-in').value=bp.amount;bpDay=bp.day;selectBPDay(bp.day);openModal('modal-bp');}
function selectBPDay(day){bpDay=day;document.getElementById('bp-seg-5').className='modal-seg-btn'+(day===5?' active':'');document.getElementById('bp-seg-20').className='modal-seg-btn'+(day===20?' active':'');}
function saveBP(){
  const name=document.getElementById('bp-name-in').value.trim();
  const amount=parseFloat(document.getElementById('bp-amt-in').value);
  if(!name||isNaN(amount)||amount<=0){showToast('‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è');return;}
  if(editBPIdx!==null){
    const oldBP=state.basePayments[editBPIdx];const oldName=oldBP.name;const oldAmt=oldBP.amount;const oldDay=oldBP.day;
    oldBP.name=name;oldBP.amount=amount;oldBP.day=bpDay;
    let updatedCount=0;
    state.periods.forEach(p=>{const periodDay=p.name.match(/\d+$/)?.[0];if(parseInt(periodDay)===oldDay||bpDay===oldDay){p.expenses.forEach(exp=>{if(!exp.paid&&exp.name===oldName&&exp.amount===oldAmt){exp.name=name;exp.amount=amount;updatedCount++;}});}});
    saveState();closeModal('modal-bp');renderBPList();renderPeriod();
    showToast(`‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ${updatedCount>0?' –≤ '+updatedCount+' –ø–µ—Ä–∏–æ–¥–∞—Ö':''}!`);
    scheduleSync(()=>writeBPToSheets());
  }else{
    const id='bp_'+Date.now();state.basePayments.push({id,name,amount,day:bpDay});
    saveState();closeModal('modal-bp');renderBPList();showToast('‚úÖ –ë–∞–∑–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂ –¥–æ–±–∞–≤–ª–µ–Ω!');
    scheduleSync(()=>writeBPToSheets());
  }
}
function deleteBP(idx){
  if(!confirm('–£–¥–∞–ª–∏—Ç—å –±–∞–∑–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂? –ò–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–µ—Ä–∏–æ–¥–æ–≤ –æ–Ω –Ω–µ —É–¥–∞–ª–∏—Ç—Å—è.'))return;
  state.basePayments.splice(idx,1);saveState();renderBPList();showToast('üóëÔ∏è –£–¥–∞–ª—ë–Ω');
  scheduleSync(()=>writeBPToSheets());
}

function resetData(){
  if(!confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∫ –Ω–∞—á–∞–ª—å–Ω—ã–º? –≠—Ç–æ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.'))return;
  localStorage.removeItem('finance_v10');
  state=loadState();saveState();renderPeriod();showToast('üîÑ –î–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODAL HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.querySelectorAll('.modal-ov').forEach(o=>{o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open');});});
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){['modal-expense','modal-income','modal-kop','modal-bp'].forEach(closeModal);}
  if(e.key==='Enter'){
    if(document.getElementById('modal-expense').classList.contains('open'))saveExpense();
    if(document.getElementById('modal-income').classList.contains('open'))saveIncome();
    if(document.getElementById('modal-kop').classList.contains('open'))saveKopOp();
    if(document.getElementById('modal-bp').classList.contains('open'))saveBP();
    if(document.getElementById('modal-kop-edit').classList.contains('open'))saveKopilkaEntryEdit();
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function init() {
  // Hide loading immediately ‚Äî show local data right away
  document.getElementById('loading-ov').classList.add('hidden');
  renderPeriod();
  renderAuthCard();
  // Google auth initialises in background
  initGoogleAuth();
}

init();
</script>
</body>
</html>
