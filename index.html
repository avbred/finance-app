<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑÑ‹">
<meta name="theme-color" content="#1A1A2E">
<title>ĞœĞ¾Ğ¸ Ñ„Ğ¸Ğ½Ğ°Ğ½ÑÑ‹</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj4KICA8cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEyMCIgZmlsbD0iIzFBMUEyRSIvPgogIDxyZWN0IHg9IjgwIiB5PSIyMDAiIHdpZHRoPSIzNTIiIGhlaWdodD0iMjIwIiByeD0iMTYiIGZpbGw9IiM3QzVDQkYiLz4KICA8cmVjdCB4PSI2MCIgeT0iMTg1IiB3aWR0aD0iMzkyIiBoZWlnaHQ9IjQwIiByeD0iMTIiIGZpbGw9IiM5QjdGRDQiLz4KICA8cG9seWdvbiBwb2ludHM9IjI1Niw4MCA4MCwyMDAgNDMyLDIwMCIgZmlsbD0iI0VERThGNyIvPgogIDxyZWN0IHg9IjE0MCIgeT0iMjYwIiB3aWR0aD0iNzAiIGhlaWdodD0iOTAiIHJ4PSI4IiBmaWxsPSIjRURFOEY3Ii8+CiAgPHJlY3QgeD0iMjIxIiB5PSIyNjAiIHdpZHRoPSI3MCIgaGVpZ2h0PSI5MCIgcng9IjgiIGZpbGw9IiNFREU4RjciLz4KICA8cmVjdCB4PSIzMDIiIHk9IjI2MCIgd2lkdGg9IjcwIiBoZWlnaHQ9IjkwIiByeD0iOCIgZmlsbD0iI0VERThGNyIvPgogIDxyZWN0IHg9IjEwMCIgeT0iMzkwIiB3aWR0aD0iMzEyIiBoZWlnaHQ9IjIyIiByeD0iOCIgZmlsbD0iI0VERThGNyIvPgo8L3N2Zz4=">
<link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj4KICA8cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEyMCIgZmlsbD0iIzFBMUEyRSIvPgogIDxyZWN0IHg9IjgwIiB5PSIyMDAiIHdpZHRoPSIzNTIiIGhlaWdodD0iMjIwIiByeD0iMTYiIGZpbGw9IiM3QzVDQkYiLz4KICA8cmVjdCB4PSI2MCIgeT0iMTg1IiB3aWR0aD0iMzkyIiBoZWlnaHQ9IjQwIiByeD0iMTIiIGZpbGw9IiM5QjdGRDQiLz4KICA8cG9seWdvbiBwb2ludHM9IjI1Niw4MCA4MCwyMDAgNDMyLDIwMCIgZmlsbD0iI0VERThGNyIvPgogIDxyZWN0IHg9IjE0MCIgeT0iMjYwIiB3aWR0aD0iNzAiIGhlaWdodD0iOTAiIHJ4PSI4IiBmaWxsPSIjRURFOEY3Ii8+CiAgPHJlY3QgeD0iMjIxIiB5PSIyNjAiIHdpZHRoPSI3MCIgaGVpZ2h0PSI5MCIgcng9IjgiIGZpbGw9IiNFREU4RjciLz4KICA8cmVjdCB4PSIzMDIiIHk9IjI2MCIgd2lkdGg9IjcwIiBoZWlnaHQ9IjkwIiByeD0iOCIgZmlsbD0iI0VERThGNyIvPgogIDxyZWN0IHg9IjEwMCIgeT0iMzkwIiB3aWR0aD0iMzEyIiBoZWlnaHQ9IjIyIiByeD0iOCIgZmlsbD0iI0VERThGNyIvPgo8L3N2Zz4=">
<link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@400;600;700;800&family=Nunito:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --cream:#F5F0E8; --white:#FFF; --ink:#1A1A2E; --ink-light:#4A4A6A; --ink-muted:#9898B0;
  --violet:#7C5CBF; --violet-light:#EDE8F7;
  --green:#2ECC8E; --green-light:#E0F7EF;
  --coral:#FF6B6B; --coral-light:#FFEDED;
  --yellow:#FFD166; --yellow-light:#FFF7E0;
  --blue:#4A90D9; --blue-light:#E8F2FC;
  --shadow:0 4px 20px rgba(26,26,46,.08);
  --r:20px; --rs:12px; --nav:72px;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{font-family:'Nunito',sans-serif;background:var(--cream);color:var(--ink);min-height:100vh;max-width:430px;margin:0 auto;overflow-x:hidden}
.screen{display:none;flex-direction:column;min-height:100vh;padding-bottom:calc(var(--nav) + 16px)}
.screen.active{display:flex}

/* TOPBAR */
.topbar{padding:20px 24px 12px;background:var(--cream);position:sticky;top:0;z-index:10;display:flex;align-items:flex-start;justify-content:space-between}
.topbar-title{font-family:'Unbounded',sans-serif;font-size:22px;font-weight:800;letter-spacing:-.5px}
.topbar-right{display:flex;gap:8px;align-items:center;margin-top:4px}
.icon-btn{width:40px;height:40px;background:var(--white);border:none;border-radius:12px;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow);transition:transform .1s}
.icon-btn:active{transform:scale(.92)}

/* SYNC STATUS */
.sync-badge{display:flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:12px;cursor:pointer;transition:all .2s;box-shadow:var(--shadow)}
.sync-badge.connected{background:var(--white)}
.sync-badge.syncing{background:var(--white)}
.sync-badge.error{background:var(--coral-light)}
.sync-badge.offline{background:var(--white)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* MINI KOPILKA */
.mini-kopilka{margin:0 24px 16px;background:var(--violet-light);border-radius:var(--r);padding:14px 18px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;transition:transform .15s}
.mini-kopilka:active{transform:scale(.98)}
.mk-left{display:flex;align-items:center;gap:10px}
.mk-icon{width:36px;height:36px;background:var(--violet);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px}
.mk-label{font-size:11px;color:var(--violet);font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.mk-val{font-family:'Unbounded',sans-serif;font-size:16px;font-weight:800;color:var(--violet);margin-top:2px}
.mk-arrow{font-size:20px;color:var(--violet);opacity:.4}

/* PERIOD NAV */
.period-nav{display:flex;align-items:center;gap:10px;padding:0 24px;margin-bottom:14px}
.nav-arrow{width:38px;height:38px;background:var(--white);border:none;border-radius:11px;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow);transition:transform .1s;color:var(--ink);line-height:1}
.nav-arrow:active{transform:scale(.9)}
.nav-arrow:disabled{opacity:.25}
.period-center{flex:1;text-align:center}
.period-title{font-family:'Unbounded',sans-serif;font-size:15px;font-weight:700}

/* HERO CARD */
.hero-card{margin:0 24px 14px;background:var(--ink);border-radius:var(--r);padding:20px 22px;color:white;position:relative;overflow:hidden}
.hero-card::before{content:'';position:absolute;top:-40px;right:-40px;width:150px;height:150px;background:var(--violet);border-radius:50%;opacity:.35}
.hero-card::after{content:'';position:absolute;bottom:-50px;left:10px;width:180px;height:180px;background:var(--green);border-radius:50%;opacity:.12}
.hero-income-block{position:relative;z-index:1;margin-bottom:14px}
.hero-income-label{font-size:11px;font-weight:700;opacity:.5;text-transform:uppercase;letter-spacing:.8px}
.hero-income-row{display:flex;align-items:center;gap:10px;margin-top:2px}
.hero-income-val{font-family:'Unbounded',sans-serif;font-size:30px;font-weight:800;letter-spacing:-1px}
.hero-edit-btn{background:rgba(255,255,255,.12);border:none;border-radius:8px;color:white;padding:4px 10px;font-family:'Nunito',sans-serif;font-size:12px;font-weight:700;cursor:pointer;opacity:.7}
.hero-edit-btn:active{opacity:1}
.hero-row{display:flex;gap:8px;position:relative;z-index:1}
.hero-stat{flex:1;background:rgba(255,255,255,.08);border-radius:13px;padding:11px 12px}
.hero-stat-lbl{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;opacity:.5;margin-bottom:4px}
.hero-stat-val{font-family:'Unbounded',sans-serif;font-size:14px;font-weight:800;letter-spacing:-.3px}
.green{color:var(--green)} .coral{color:var(--coral)} .yellow{color:var(--yellow)}

/* PROGRESS */
.prog-wrap{padding:0 24px;margin-bottom:16px}
.prog-label{display:flex;justify-content:space-between;font-size:12px;font-weight:600;color:var(--ink-muted);margin-bottom:6px}
.prog-bar{height:7px;background:#E8E5EE;border-radius:4px;overflow:hidden}
.prog-fill{height:100%;border-radius:4px;transition:width .5s ease;background:var(--green)}
.prog-fill.warn{background:var(--yellow)}
.prog-fill.danger{background:var(--coral)}

/* SECTION HEADER */
.sec-hdr{display:flex;align-items:center;justify-content:space-between;padding:0 24px;margin-bottom:10px}
.sec-title{font-family:'Unbounded',sans-serif;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--ink-muted)}
.add-btn{background:var(--ink);color:white;border:none;border-radius:10px;padding:6px 14px;font-family:'Nunito',sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:transform .1s}
.add-btn:active{transform:scale(.95)}

/* EXPENSE ITEMS */
.exp-list{padding:0 24px;display:flex;flex-direction:column;gap:7px}
.exp-item{background:var(--white);border-radius:var(--rs);padding:13px 14px;display:flex;align-items:center;gap:10px;box-shadow:var(--shadow);transition:all .25s;position:relative;overflow:hidden}
.exp-item.paid{background:var(--green-light)}
.exp-item.paid::before{content:'';position:absolute;left:0;top:0;bottom:0;width:4px;background:var(--green);border-radius:4px 0 0 4px}
.exp-check{width:26px;height:26px;border-radius:8px;border:2px solid #D0CDE0;background:white;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all .2s;cursor:pointer;font-size:13px;color:white}
.exp-item.paid .exp-check{background:var(--green);border-color:var(--green)}
.exp-info{flex:1;min-width:0}
.exp-name{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.exp-item.paid .exp-name{color:var(--ink-light)}
.exp-amt{font-family:'Unbounded',sans-serif;font-size:14px;font-weight:700;flex-shrink:0}
.exp-item.paid .exp-amt{color:var(--green)}
.exp-actions{display:flex;gap:5px;flex-shrink:0}
.exp-btn{width:26px;height:26px;border:none;border-radius:7px;background:rgba(0,0,0,.05);cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center}
.exp-btn.del{background:var(--coral-light);color:var(--coral)}

/* KOPILKA SCREEN */
.kop-hero{margin:0 24px 16px;background:linear-gradient(135deg,var(--violet) 0%,#5B3FA8 100%);border-radius:var(--r);padding:24px;color:white;position:relative;overflow:hidden}
.kop-hero::before{content:'ğŸ¦';position:absolute;right:20px;top:16px;font-size:44px;opacity:.25}
.kop-hero-lbl{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;opacity:.65}
.kop-hero-amt{font-family:'Unbounded',sans-serif;font-size:36px;font-weight:800;margin-top:6px;letter-spacing:-1px}
.kop-btns{padding:0 24px;margin-bottom:16px;display:flex;gap:10px}
.kop-btn{flex:1;padding:11px;border:none;border-radius:var(--rs);font-family:'Nunito',sans-serif;font-size:14px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:5px;transition:transform .1s}
.kop-btn:active{transform:scale(.96)}
.kop-btn.add{background:var(--green-light);color:var(--green)}
.kop-btn.sub{background:var(--coral-light);color:var(--coral)}

/* TIMELINE */
.tl-section-hdr{padding:4px 24px 8px;font-family:'Unbounded',sans-serif;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--ink-muted)}
.tl-item{margin:0 24px 6px;border-radius:var(--rs);padding:11px 14px;display:flex;align-items:center;gap:10px;box-shadow:var(--shadow);position:relative;overflow:hidden}
.tl-item.past{background:#F7F6F9;opacity:.75}
.tl-item.future{background:var(--white)}
.tl-item.danger-row{border:2px solid var(--coral);}
.tl-dot{width:32px;height:32px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;font-weight:700}
.tl-dot.inc.past{background:#E4E2EC;color:#888}
.tl-dot.exp.past{background:#EDE8E8;color:#999}
.tl-dot.inc.future{background:var(--green-light);color:var(--green)}
.tl-dot.exp.future{background:var(--coral-light);color:var(--coral)}
.tl-info{flex:1;min-width:0}
.tl-name{font-size:13px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tl-item.past .tl-name{color:var(--ink-light)}
.tl-bal{font-size:10px;font-weight:600;margin-top:2px}
.tl-bal.ok{color:var(--green)}
.tl-bal.warn{color:var(--coral)}
.tl-right{display:flex;align-items:center;gap:7px;flex-shrink:0}
.tl-amt{font-family:'Unbounded',sans-serif;font-size:13px;font-weight:800}
.tl-item.past .tl-amt{color:var(--ink-muted)}
.tl-amt.inc.future{color:var(--green)}
.tl-amt.exp.future{color:var(--coral)}
.tl-check{width:28px;height:28px;border:none;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;transition:all .2s;flex-shrink:0}
.tl-check.unpaid{background:var(--coral-light);color:var(--coral)}
.tl-check.paid{background:var(--green-light);color:var(--green)}
.tl-warn-icon{font-size:16px;flex-shrink:0}
.tl-right-col{display:flex;flex-direction:column;align-items:flex-end}
.exp-item.future-locked{opacity:.7}
.exp-check.locked{background:#F0EEF8;color:var(--ink-muted);border-color:#E0DDF0;cursor:default;font-size:10px}

/* SETTINGS */
.set-section{padding:0 24px;margin-bottom:22px}
.set-section-title{font-family:'Unbounded',sans-serif;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--ink-muted);margin-bottom:10px}
.set-card{background:var(--white);border-radius:var(--r);padding:18px 20px;box-shadow:var(--shadow)}
.set-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid #F0EEF8}
.set-row:last-child{border-bottom:none;padding-bottom:0}
.set-row-lbl{font-size:14px;font-weight:700}
.set-row-sub{font-size:12px;color:var(--ink-muted);margin-top:2px}
.set-input{width:130px;border:2px solid #EEEEF5;border-radius:10px;padding:8px 12px;font-family:'Nunito',sans-serif;font-size:15px;font-weight:700;background:var(--cream);outline:none;text-align:right;transition:border-color .2s}
.set-input:focus{border-color:var(--violet)}
.set-save-btn{width:100%;margin-top:14px;padding:13px;background:var(--ink);color:white;border:none;border-radius:var(--rs);font-family:'Nunito',sans-serif;font-size:15px;font-weight:800;cursor:pointer;transition:transform .1s}
.set-save-btn:active{transform:scale(.98)}
.sal-preview{margin-top:14px;background:var(--cream);border-radius:12px;padding:14px 16px}
.sal-preview-title{font-size:11px;font-weight:700;color:var(--ink-muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px}
.sal-row{display:flex;justify-content:space-between;align-items:center;padding:4px 0}
.sal-row-lbl{font-size:13px;color:var(--ink-light);font-weight:600}
.sal-row-val{font-family:'Unbounded',sans-serif;font-size:13px;font-weight:700}

/* GOOGLE AUTH CARD */
.auth-card{margin:0 24px 16px;background:var(--white);border-radius:var(--r);padding:20px;box-shadow:var(--shadow)}
.auth-card-title{font-family:'Unbounded',sans-serif;font-size:14px;font-weight:700;margin-bottom:8px}
.auth-card-sub{font-size:13px;color:var(--ink-muted);line-height:1.5;margin-bottom:14px}
.auth-btn{width:100%;padding:12px;border:none;border-radius:var(--rs);font-family:'Nunito',sans-serif;font-size:14px;font-weight:800;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:transform .1s}
.auth-btn:active{transform:scale(.97)}
.auth-btn.google{background:var(--ink);color:white}
.auth-btn.disconnect{background:var(--coral-light);color:var(--coral)}
.auth-status-row{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid #F0EEF8}
.auth-status-row:last-child{border-bottom:none}
.auth-email{font-size:13px;font-weight:700;flex:1}
.auth-sub{font-size:11px;color:var(--ink-muted)}

/* BASE PAYMENTS */
.bp-item{background:var(--white);border-radius:var(--rs);padding:12px 14px;display:flex;align-items:center;gap:10px;box-shadow:var(--shadow);margin-bottom:8px}
.bp-badge{flex-shrink:0;width:32px;height:32px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800;font-family:'Unbounded',sans-serif}
.bp-badge.d5{background:var(--violet-light);color:var(--violet)}
.bp-badge.d20{background:var(--blue-light);color:var(--blue)}
.bp-info{flex:1;min-width:0}
.bp-name{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.bp-sub{font-size:11px;color:var(--ink-muted);margin-top:1px}
.bp-amt{font-family:'Unbounded',sans-serif;font-size:14px;font-weight:700;flex-shrink:0;margin-right:6px}
.bp-actions{display:flex;gap:5px;flex-shrink:0}
.bp-btn{width:26px;height:26px;border:none;border-radius:7px;background:rgba(0,0,0,.05);cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center}
.bp-btn.del{background:var(--coral-light);color:var(--coral)}

/* BOTTOM NAV */
.bottom-nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;height:var(--nav);background:var(--ink);display:flex;border-radius:24px 24px 0 0;padding:0 8px;z-index:100}
.nav-tab{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;border:none;background:none;color:rgba(255,255,255,.35);cursor:pointer;transition:color .2s;padding:0}
.nav-tab.active{color:white}
.nav-wrap{display:flex;flex-direction:column;align-items:center;gap:3px;padding:6px 16px;border-radius:14px}
.nav-tab.active .nav-wrap{background:rgba(255,255,255,.1)}
.nav-ico{font-size:21px;line-height:1}
.nav-lbl{font-family:'Nunito',sans-serif;font-size:10px;font-weight:700}

/* MODALS */
.modal-ov{display:none;position:fixed;inset:0;background:rgba(26,26,46,.5);z-index:200;align-items:flex-end;justify-content:center}
.modal-ov.open{display:flex}
.modal{background:var(--white);border-radius:24px 24px 0 0;padding:24px 24px 44px;width:100%;max-width:430px;animation:slideUp .28s ease}
@keyframes slideUp{from{transform:translateY(100%);opacity:0}to{transform:translateY(0);opacity:1}}
.modal-title{font-family:'Unbounded',sans-serif;font-size:17px;font-weight:800;margin-bottom:18px}
.modal-field{margin-bottom:14px}
.modal-label{font-size:12px;font-weight:700;color:var(--ink-muted);margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px}
.modal-input{width:100%;border:2px solid #EEEEF5;border-radius:var(--rs);padding:11px 14px;font-family:'Nunito',sans-serif;font-size:16px;font-weight:600;color:var(--ink);background:var(--cream);outline:none;transition:border-color .2s}
.modal-input:focus{border-color:var(--violet)}
.modal-seg{display:flex;gap:8px;margin-top:4px}
.modal-seg-btn{flex:1;padding:11px;border:2px solid #EEEEF5;border-radius:var(--rs);background:var(--cream);font-family:'Nunito',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:all .15s;color:var(--ink-muted)}
.modal-seg-btn.active{border-color:var(--violet);background:var(--violet-light);color:var(--violet)}
.modal-actions{display:flex;gap:10px;margin-top:18px}
.modal-btn{flex:1;padding:13px;border:none;border-radius:var(--rs);font-family:'Nunito',sans-serif;font-size:15px;font-weight:800;cursor:pointer;transition:transform .1s}
.modal-btn:active{transform:scale(.97)}
.modal-btn.primary{background:var(--ink);color:white}
.modal-btn.secondary{background:var(--cream);color:var(--ink)}

/* TOAST */
.toast{position:fixed;bottom:calc(var(--nav) + 20px);left:50%;transform:translateX(-50%) translateY(100px);background:var(--ink);color:white;padding:11px 20px;border-radius:100px;font-size:13px;font-weight:700;z-index:400;transition:transform .3s ease;white-space:nowrap;pointer-events:none;max-width:calc(100% - 48px);text-align:center}
.toast.show{transform:translateX(-50%) translateY(0)}
.empty-state{text-align:center;padding:32px 24px;color:var(--ink-muted)}
.empty-ico{font-size:40px;margin-bottom:10px}
.empty-txt{font-size:14px;font-weight:600}

/* LOADING OVERLAY */
.loading-ov{position:fixed;inset:0;background:var(--cream);z-index:500;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px}
.loading-ov.hidden{display:none}
.loading-spinner{width:40px;height:40px;border:3px solid #E8E5EE;border-top-color:var(--violet);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-txt{font-family:'Unbounded',sans-serif;font-size:13px;font-weight:700;color:var(--ink-muted)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DESKTOP LAYOUT (>= 900px)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (min-width: 900px) {
  body { max-width: 100%; background: #ECEAE4; }
  .bottom-nav { display: none; }
  .screen { padding-bottom: 0; min-height: 100vh; }

  /* Desktop wrapper */
  #desktop-shell {
    display: flex; flex-direction: column; min-height: 100vh;
  }
  /* Desktop topbar */
  #desktop-topbar {
    display: flex; align-items: center; justify-content: space-between;
    padding: 18px 40px; background: var(--ink); color: white; position: sticky; top: 0; z-index: 50;
  }
  #desktop-topbar .dt-title {
    font-family: 'Unbounded', sans-serif; font-size: 18px; font-weight: 800; color: white;
  }
  #desktop-topbar .dt-nav { display: flex; gap: 8px; }
  #desktop-topbar .dt-tab {
    padding: 8px 18px; border: none; border-radius: 10px; font-family: 'Nunito', sans-serif;
    font-size: 13px; font-weight: 700; cursor: pointer; background: rgba(255,255,255,.1);
    color: rgba(255,255,255,.6); transition: all .2s;
  }
  #desktop-topbar .dt-tab.active { background: white; color: var(--ink); }
  #desktop-topbar .dt-right { display: flex; align-items: center; gap: 12px; }
  #desktop-topbar .dt-kopilka {
    background: var(--violet); border-radius: 12px; padding: 8px 16px;
    display: flex; align-items: center; gap: 8px; cursor: pointer; transition: opacity .2s;
  }
  #desktop-topbar .dt-kopilka:hover { opacity: .85; }
  #desktop-topbar .dt-kop-label { font-size: 10px; font-weight: 700; color: rgba(255,255,255,.7); text-transform: uppercase; letter-spacing: .5px; }
  #desktop-topbar .dt-kop-val { font-family: 'Unbounded', sans-serif; font-size: 15px; font-weight: 800; color: white; }

  /* Hide mobile screens on desktop */
  #screen-periods, #screen-kopilka, #screen-settings { display: none !important; }

  /* Desktop content area */
  #desktop-content { flex: 1; padding: 28px 40px; }

  /* Desktop: periods grid view */
  #dt-periods-grid {
    display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;
  }
  .dt-period-card {
    background: var(--white); border-radius: var(--r); box-shadow: var(--shadow);
    overflow: hidden; display: flex; flex-direction: column;
  }
  .dt-period-card.current { outline: 2px solid var(--violet); }
  .dt-card-header {
    background: var(--ink); color: white; padding: 14px 16px 12px;
    display: flex; justify-content: space-between; align-items: flex-start;
  }
  .dt-card-name { font-family: 'Unbounded', sans-serif; font-size: 13px; font-weight: 700; }
  .dt-card-income { font-family: 'Unbounded', sans-serif; font-size: 18px; font-weight: 800; margin-top: 4px; }
  .dt-card-stats { display: flex; gap: 6px; margin-top: 8px; }
  .dt-stat { flex: 1; background: rgba(255,255,255,.08); border-radius: 8px; padding: 6px 8px; }
  .dt-stat-lbl { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: .5px; opacity: .5; }
  .dt-stat-val { font-family: 'Unbounded', sans-serif; font-size: 12px; font-weight: 800; margin-top: 2px; }
  .dt-prog { height: 3px; background: rgba(255,255,255,.15); margin-top: 10px; border-radius: 2px; }
  .dt-prog-fill { height: 100%; border-radius: 2px; background: var(--green); }
  .dt-prog-fill.warn { background: var(--yellow); }
  .dt-expenses { padding: 10px 12px; flex: 1; }
  .dt-exp-item {
    display: flex; align-items: center; gap: 8px; padding: 6px 0;
    border-bottom: 1px solid #F0EEF8; font-size: 13px; cursor: pointer;
  }
  .dt-exp-item:last-child { border-bottom: none; }
  .dt-exp-item.paid .dt-exp-name { color: var(--ink-muted); text-decoration: line-through; }
  .dt-exp-check {
    width: 20px; height: 20px; border-radius: 6px; border: 2px solid #D0CDE0;
    flex-shrink: 0; display: flex; align-items: center; justify-content: center;
    font-size: 10px; color: white; background: white; transition: all .2s;
  }
  .dt-exp-item.paid .dt-exp-check { background: var(--green); border-color: var(--green); }
  .dt-exp-name { flex: 1; font-weight: 600; }
  .dt-exp-amt { font-family: 'Unbounded', sans-serif; font-size: 12px; font-weight: 700; }
  .dt-exp-item.paid .dt-exp-amt { color: var(--green); }
  .dt-card-footer {
    padding: 10px 12px; border-top: 1px solid #F0EEF8;
    display: flex; justify-content: space-between; align-items: center;
  }
  .dt-add-btn {
    background: none; border: 1px dashed #D0CDE0; border-radius: 8px; padding: 5px 10px;
    font-family: 'Nunito', sans-serif; font-size: 12px; font-weight: 700; color: var(--ink-muted);
    cursor: pointer; transition: all .2s;
  }
  .dt-add-btn:hover { border-color: var(--violet); color: var(--violet); }
  .dt-leftover { font-family: 'Unbounded', sans-serif; font-size: 12px; font-weight: 700; }

  /* Desktop settings & kopilka â€” centered single column */
  #dt-settings-wrap, #dt-kopilka-wrap {
    max-width: 600px; margin: 0 auto;
  }
  #dt-settings-wrap .screen, #dt-kopilka-wrap .screen {
    display: flex !important; max-width: 100%;
  }
  #dt-settings-wrap .topbar, #dt-kopilka-wrap .topbar { display: none; }
  #dt-settings-wrap .screen, #dt-kopilka-wrap .screen {
    padding-bottom: 0;
  }
}

@media (max-width: 899px) {
  #desktop-shell { display: none !important; }
}
</style>
</head>
<body>

<!-- LOADING -->
<div class="loading-ov" id="loading-ov">
  <div class="loading-spinner"></div>
  <div class="loading-txt" id="loading-txt">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>
</div>

<!-- DESKTOP SHELL -->
<div id="desktop-shell">
  <div id="desktop-topbar">
    <div class="dt-title">ĞœĞ¾Ğ¸ Ñ„Ğ¸Ğ½Ğ°Ğ½ÑÑ‹ âœ¨</div>
    <div class="dt-nav">
      <button class="dt-tab active" id="dt-tab-periods" onclick="dtSwitchTab('periods')">ğŸ“… ĞŸĞµÑ€Ğ¸Ğ¾Ğ´Ñ‹</button>
      <button class="dt-tab" id="dt-tab-kopilka" onclick="dtSwitchTab('kopilka')">ğŸ’¸ ĞšĞ¾Ğ¿Ğ¸Ğ»ĞºĞ°</button>
      <button class="dt-tab" id="dt-tab-settings" onclick="dtSwitchTab('settings')">âš™ï¸ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸</button>
    </div>
    <div class="dt-right">
      <div class="dt-kopilka" onclick="dtSwitchTab('kopilka')">
        <div>
          <div class="dt-kop-label">ĞšĞ¾Ğ¿Ğ¸Ğ»ĞºĞ°</div>
          <div class="dt-kop-val" id="dt-kop-val">0</div>
        </div>
        <span style="font-size:20px">ğŸ’¸</span>
      </div>
      <div class="sync-badge offline" id="sync-badge-dt" onclick="manualSync()" style="width:40px;height:40px;border-radius:12px;background:rgba(255,255,255,.1);display:flex;align-items:center;justify-content:center;cursor:pointer;" title="Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ">
        <span id="sync-label-dt" style="font-size:18px">ğŸ¤«</span>
      </div>
    </div>
  </div>
  <div id="desktop-content">
    <!-- Periods grid -->
    <div id="dt-periods-view">
      <div id="dt-periods-grid"></div>
    </div>
    <!-- Kopilka view -->
    <div id="dt-kopilka-view" style="display:none; max-width:600px; margin:0 auto;">
      <div id="dt-kopilka-content"></div>
    </div>
    <!-- Settings view -->
    <div id="dt-settings-view" style="display:none; max-width:600px; margin:0 auto;">
      <div id="dt-settings-content"></div>
    </div>
  </div>
</div>



<!-- PERIODS -->
<div class="screen active" id="screen-periods">
  <div class="topbar">
    <div class="topbar-title">ĞœĞ¾Ğ¸ Ñ„Ğ¸Ğ½Ğ°Ğ½ÑÑ‹ âœ¨</div>
    <div class="topbar-right">
      <div class="sync-badge offline" id="sync-badge" onclick="manualSync()" title="Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ">
        <span id="sync-label" style="font-size:18px">ğŸ¤«</span>
      </div>
    </div>
  </div>
  <div class="mini-kopilka" onclick="switchTab('kopilka')">
    <div class="mk-left">
      <div class="mk-icon">ğŸ’¸</div>
      <div><div class="mk-label">ĞšĞ¾Ğ¿Ğ¸Ğ»ĞºĞ°</div><div class="mk-val" id="mk-val">0 â‚½</div></div>
    </div>
    <div class="mk-arrow">â€º</div>
  </div>
  <div class="period-nav">
    <button class="nav-arrow" id="btn-prev" onclick="changePeriod(-1)">â€¹</button>
    <div class="period-center"><div class="period-title" id="period-name">â€”</div></div>
    <button class="nav-arrow" id="btn-next" onclick="changePeriod(1)">â€º</button>
  </div>
  <div class="hero-card">
    <div class="hero-income-block">
      <div class="hero-income-label">ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¾</div>
      <div class="hero-income-row">
        <div class="hero-income-val" id="hero-income">0 â‚½</div>
        <button class="hero-edit-btn" onclick="openEditIncome()">âœï¸ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ</button>
      </div>
    </div>
    <div class="hero-row">
      <div class="hero-stat"><div class="hero-stat-lbl">Ğ Ğ°ÑÑ…Ğ¾Ğ´Ñ‹</div><div class="hero-stat-val coral" id="hero-exp">0 â‚½</div></div>
      <div class="hero-stat"><div class="hero-stat-lbl">ĞĞ¿Ğ»Ğ°Ñ‡ĞµĞ½Ğ¾</div><div class="hero-stat-val green" id="hero-paid">0 â‚½</div></div>
      <div class="hero-stat"><div class="hero-stat-lbl">ĞÑÑ‚Ğ°Ñ‚Ğ¾Ğº</div><div class="hero-stat-val yellow" id="hero-left">0 â‚½</div></div>
    </div>
  </div>
  <div class="prog-wrap">
    <div class="prog-label"><span>ĞĞ¿Ğ»Ğ°Ñ‡ĞµĞ½Ğ¾ Ñ€Ğ°ÑÑ…Ğ¾Ğ´Ğ¾Ğ²</span><span id="prog-pct">0%</span></div>
    <div class="prog-bar"><div class="prog-fill" id="prog-fill" style="width:0%"></div></div>
  </div>
  <div class="sec-hdr">
    <div class="sec-title">Ğ Ğ°ÑÑ…Ğ¾Ğ´Ñ‹</div>
    <button class="add-btn" onclick="openAddExpense()">+ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ</button>
  </div>
  <div class="exp-list" id="exp-list"></div>
  <div style="height:16px"></div>
</div>

<!-- KOPILKA -->
<div class="screen" id="screen-kopilka">
  <div class="topbar">
    <div class="topbar-title">ĞšĞ¾Ğ¿Ğ¸Ğ»ĞºĞ° ğŸ’¸</div>
  </div>
  <div class="kop-hero">
    <div class="kop-hero-lbl">Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºĞ¸</div>
    <div class="kop-hero-amt" id="kop-balance">0 â‚½</div>
  </div>
  <div class="kop-btns">
    <button class="kop-btn add" onclick="openKopilkaOp('add')">+ ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ</button>
    <button class="kop-btn sub" onclick="openKopilkaOp('sub')">âˆ’ Ğ¡Ğ½ÑÑ‚ÑŒ</button>
  </div>
  <div id="kop-timeline"></div>
  <div style="height:16px"></div>
</div>

<!-- SETTINGS -->
<div class="screen" id="screen-settings">
  <div class="topbar">
    <div class="topbar-title">ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ âš™ï¸</div>
  </div>

  <!-- Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğµ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ¸ -->
  <div class="set-section">
    <div class="set-section-title">Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğµ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ¸</div>
    <div style="font-size:13px;color:var(--ink-muted);margin-bottom:12px;line-height:1.5">
      Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸Ğ»Ğ¸ ÑÑƒĞ¼Ğ¼Ñƒ â€” Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑÑ Ğ²Ğ¾ Ğ²ÑĞµÑ… Ğ±ÑƒĞ´ÑƒÑ‰Ğ¸Ñ… Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°Ñ…
    </div>
    <div id="bp-list"></div>
    <button class="set-save-btn" style="margin-top:4px" onclick="openAddBP()">+ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ»Ğ°Ñ‚Ñ‘Ğ¶</button>
  </div>

  <!-- Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ -->
  <div class="set-section">
    <div class="set-section-title">Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ</div>
    <div class="set-card">
      <div class="set-row">
        <div><div class="set-row-lbl">ĞœĞ¾Ğ¸ Ñ„Ğ¸Ğ½Ğ°Ğ½ÑÑ‹</div><div class="set-row-sub">Ğ’ĞµÑ€ÑĞ¸Ñ 2.1 Â· Google Sheets â€” Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº Ğ¿Ñ€Ğ°Ğ²Ğ´Ñ‹</div></div>
      </div>
      <div class="set-row" style="cursor:pointer" onclick="publishAllPeriods()">
        <div><div class="set-row-lbl" style="color:var(--green)">Ğ—Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ²ÑÑ‘ Ğ² Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ</div><div class="set-row-sub">Ğ—Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ²ÑĞµ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ñ‹ Ğ¸Ğ· Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ Ğ² Google Sheets</div></div>
        <span style="color:var(--green)">â€º</span>
      </div>
      <div class="set-row" style="cursor:pointer" onclick="loadFromSheets()">
        <div><div class="set-row-lbl" style="color:var(--violet)">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ¸Ğ· Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹</div><div class="set-row-sub">Ğ¡Ğ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ¸Ğ· Google Sheets</div></div>
        <span style="color:var(--violet)">â€º</span>
      </div>
      <div class="set-row" style="cursor:pointer" onclick="resetData()">
        <div><div class="set-row-lbl" style="color:var(--coral)">Ğ¡Ğ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ</div><div class="set-row-sub">Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒ Ğº Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼</div></div>
        <span style="color:var(--coral)">â€º</span>
      </div>
    </div>
  </div>
  <div style="height:16px"></div>
</div>

<!-- NAV -->
<nav class="bottom-nav">
  <button class="nav-tab active" onclick="switchTab('periods')" id="nav-periods">
    <div class="nav-wrap"><span class="nav-ico">ğŸ“…</span><span class="nav-lbl">ĞŸĞµÑ€Ğ¸Ğ¾Ğ´Ñ‹</span></div>
  </button>
  <button class="nav-tab" onclick="switchTab('kopilka')" id="nav-kopilka">
    <div class="nav-wrap"><span class="nav-ico">ğŸ¦</span><span class="nav-lbl">ĞšĞ¾Ğ¿Ğ¸Ğ»ĞºĞ°</span></div>
  </button>
  <button class="nav-tab" onclick="switchTab('settings')" id="nav-settings">
    <div class="nav-wrap"><span class="nav-ico">âš™ï¸</span><span class="nav-lbl">ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸</span></div>
  </button>
</nav>

<!-- MODAL: Expense -->
<div class="modal-ov" id="modal-expense">
  <div class="modal">
    <div class="modal-title" id="modal-exp-title">ĞĞ¾Ğ²Ñ‹Ğ¹ Ñ€Ğ°ÑÑ…Ğ¾Ğ´</div>
    <div class="modal-field"><div class="modal-label">ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ</div><input class="modal-input" id="exp-name-in" placeholder="ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, ĞĞ·Ğ¾Ğ½" type="text"></div>
    <div class="modal-field"><div class="modal-label">Ğ¡ÑƒĞ¼Ğ¼Ğ°, â‚½</div><input class="modal-input" id="exp-amt-in" placeholder="0" type="number" inputmode="numeric"></div>
    <div class="modal-actions">
      <button class="modal-btn secondary" onclick="closeModal('modal-expense')">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
      <button class="modal-btn primary" onclick="saveExpense()">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>
    </div>
  </div>
</div>

<!-- MODAL: Income -->
<div class="modal-ov" id="modal-income">
  <div class="modal">
    <div class="modal-title">Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ½ÑƒÑ ÑÑƒĞ¼Ğ¼Ñƒ</div>
    <div class="modal-field"><div class="modal-label">ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¾, â‚½</div><input class="modal-input" id="income-in" placeholder="0" type="number" inputmode="numeric"></div>
    <div class="modal-actions">
      <button class="modal-btn secondary" onclick="closeModal('modal-income')">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
      <button class="modal-btn primary" onclick="saveIncome()">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>
    </div>
  </div>
</div>

<!-- MODAL: Kopilka Op -->
<div class="modal-ov" id="modal-kop">
  <div class="modal">
    <div class="modal-title" id="modal-kop-title">ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ</div>
    <div class="modal-field"><div class="modal-label">Ğ¡ÑƒĞ¼Ğ¼Ğ°, â‚½</div><input class="modal-input" id="kop-amt-in" placeholder="0" type="number" inputmode="numeric"></div>
    <div class="modal-field"><div class="modal-label">ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹</div><input class="modal-input" id="kop-comment-in" placeholder="ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, ĞŸÑ€Ğ¾Ñ†ĞµĞ½Ñ‚Ñ‹ Ğ¿Ğ¾ Ğ²ĞºĞ»Ğ°Ğ´Ñƒ" type="text"></div>
    <div class="modal-actions">
      <button class="modal-btn secondary" onclick="closeModal('modal-kop')">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
      <button class="modal-btn primary" onclick="saveKopOp()">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>
    </div>
  </div>
</div>

<!-- MODAL: Base Payment -->
<div class="modal-ov" id="modal-bp">
  <div class="modal">
    <div class="modal-title" id="modal-bp-title">Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ»Ğ°Ñ‚Ñ‘Ğ¶</div>
    <div class="modal-field"><div class="modal-label">ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ</div><input class="modal-input" id="bp-name-in" placeholder="ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, Ğ ĞµÑĞ½Ğ¸Ñ†Ñ‹" type="text"></div>
    <div class="modal-field"><div class="modal-label">Ğ¡ÑƒĞ¼Ğ¼Ğ°, â‚½</div><input class="modal-input" id="bp-amt-in" placeholder="0" type="number" inputmode="numeric"></div>
    <div class="modal-field">
      <div class="modal-label">ĞŸĞµÑ€Ğ¸Ğ¾Ğ´ (Ğ² ĞºĞ°ĞºĞ¾Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾)</div>
      <div class="modal-seg">
        <button class="modal-seg-btn active" id="bp-seg-5" onclick="selectBPDay(5)">5 Ñ‡Ğ¸ÑĞ»Ğ°</button>
        <button class="modal-seg-btn" id="bp-seg-20" onclick="selectBPDay(20)">20 Ñ‡Ğ¸ÑĞ»Ğ°</button>
      </div>
    </div>
    <div class="modal-actions">
      <button class="modal-btn secondary" onclick="closeModal('modal-bp')">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
      <button class="modal-btn primary" onclick="saveBP()">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- MODAL: Edit Kopilka Entry Amount -->
<div class="modal-ov" id="modal-kop-edit">
  <div class="modal">
    <div class="modal-title">Ğ’ ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ â€” <span id="kop-edit-period" style="color:var(--violet)"></span></div>
    <input type="hidden" id="kop-edit-id">
    <div class="modal-field">
      <div class="modal-label">Ğ¡ÑƒĞ¼Ğ¼Ğ°, â‚½</div>
      <input class="modal-input" id="kop-edit-amt" placeholder="0" type="number" inputmode="numeric">
    </div>
    <div style="font-size:12px;color:var(--ink-muted);margin-top:-6px;line-height:1.5">
      Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ ÑÑƒĞ¼Ğ¼Ñƒ Ğ² Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğµ ĞšĞ¾Ğ¿Ğ¸Ğ»ĞºĞ¸ Ğ¸ Ğ¿ĞµÑ€ĞµÑÑ‡Ğ¸Ñ‚Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ· Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°
    </div>
    <div class="modal-actions">
      <button class="modal-btn secondary" onclick="closeModal('modal-kop-edit')">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
      <button class="modal-btn primary" onclick="saveKopilkaEntryEdit()">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>
    </div>
  </div>
</div>

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GOOGLE_CLIENT_ID = '91072547655-uut7hbnspu6thk06jlhoktngtqufcaoi.apps.googleusercontent.com';
const SPREADSHEET_ID   = '1-WAxJNhPFJPVs4j9PZjBpMGUDk6J5FISpFATpO_HPIE';
const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

// Sheet names
const SH_PERIODS = 'ĞŸĞµÑ€Ğ¸Ğ¾Ğ´Ñ‹';
const SH_KOPILKA = 'ĞšĞ¾Ğ¿Ğ¸Ğ»ĞºĞ°';
const SH_BP      = 'Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğµ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ¸';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RUSSIAN PUBLIC HOLIDAYS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const RU_HOLIDAYS = new Set([
  '2025-1-1','2025-1-2','2025-1-3','2025-1-6','2025-1-7','2025-1-8',
  '2025-2-24','2025-3-10','2025-5-1','2025-5-2','2025-5-8','2025-5-9',
  '2025-6-12','2025-6-13','2025-11-4','2025-12-31',
  '2026-1-1','2026-1-2','2026-1-5','2026-1-6','2026-1-7','2026-1-8','2026-1-9',
  '2026-2-23','2026-3-9','2026-5-1','2026-5-4','2026-5-11',
  '2026-6-12','2026-11-4','2026-12-31',
  '2027-1-1','2027-1-4','2027-1-5','2027-1-6','2027-1-7','2027-1-8',
  '2027-2-22','2027-2-23','2027-3-8','2027-5-3','2027-5-10',
  '2027-6-14','2027-11-4','2027-11-5',
]);
function isWorkingDay(y,m,d){const dt=new Date(y,m,d);const dow=dt.getDay();if(dow===0||dow===6)return false;return!RU_HOLIDAYS.has(`${y}-${m+1}-${d}`);}
function countWorkingDays(y,m,from,to){const last=new Date(y,m+1,0).getDate();let cnt=0;for(let d=from;d<=Math.min(to,last);d++){if(isWorkingDay(y,m,d))cnt++;}return cnt;}
function calcAvans(salary,y,m){const total=countWorkingDays(y,m,1,31);if(!total)return 0;return Math.round(salary*countWorkingDays(y,m,1,15)/total);}
function calcZarplata(salary,y,m){let pm=m-1,py=y;if(pm<0){pm=11;py--;}return salary-calcAvans(salary,py,pm);}
function genSalaryPreview(salary){
  const mn=['ÑĞ½Ğ²Ğ°Ñ€ÑŒ','Ñ„ĞµĞ²Ñ€Ğ°Ğ»ÑŒ','Ğ¼Ğ°Ñ€Ñ‚','Ğ°Ğ¿Ñ€ĞµĞ»ÑŒ','Ğ¼Ğ°Ğ¹','Ğ¸ÑĞ½ÑŒ','Ğ¸ÑĞ»ÑŒ','Ğ°Ğ²Ğ³ÑƒÑÑ‚','ÑĞµĞ½Ñ‚ÑĞ±Ñ€ÑŒ','Ğ¾ĞºÑ‚ÑĞ±Ñ€ÑŒ','Ğ½Ğ¾ÑĞ±Ñ€ÑŒ','Ğ´ĞµĞºĞ°Ğ±Ñ€ÑŒ'];
  const t=new Date();let y=t.getFullYear(),m=t.getMonth();const res=[];
  for(let i=0;i<10&&res.length<6;i++){
    res.push({label:mn[m]+' â€” 20 (Ğ°Ğ²Ğ°Ğ½Ñ)',val:calcAvans(salary,y,m),note:'avans'});
    if(res.length<6){let nm=m+1,ny=y;if(nm>11){nm=0;ny++;}res.push({label:mn[nm]+' â€” 5 (Ğ·Ğ°Ñ€Ğ¿Ğ»Ğ°Ñ‚Ğ°)',val:calcZarplata(salary,ny,nm),note:'zp'});}
    m++;if(m>11){m=0;y++;}
  }
  return res.slice(0,6);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INITIAL DATA (fallback)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const INIT_PERIODS = [
  {name:'Ğ´ĞµĞºĞ°Ğ±Ñ€ÑŒ 5',income:82500,expenses:[{name:'Ğ ĞµÑĞ½Ğ¸Ñ†Ñ‹',amount:3000,paid:false},{name:'Ğ¯Ğ½Ğ´ĞµĞºÑ ĞŸĞµĞ¹',amount:10914,paid:false},{name:'Ğ¢Ğ¸Ğ½ÑŒĞºĞ¾Ñ„ Ğ°Ğ²Ñ‚Ğ¾',amount:4690,paid:false},{name:'ĞĞ»ÑŒÑ„Ğ°',amount:10400,paid:false},{name:'Ğ’ ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ',amount:29000,paid:false},{name:'Ğ¢Ğ¸Ğ½ÑŒĞºĞ¾Ñ„ ĞºÑ€ĞµĞ´Ğ¸Ñ‚ĞºĞ°',amount:10800,paid:false}]},
  {name:'Ğ´ĞµĞºĞ°Ğ±Ñ€ÑŒ 20',income:65000,expenses:[{name:'ĞĞ·Ğ¾Ğ½ Ğ´ĞµĞºĞ°Ğ±Ñ€ÑŒ',amount:29000,paid:false},{name:'Ğ¢Ğ¸Ğ½ÑŒĞºĞ¾Ñ„ ĞºÑ€ĞµĞ´Ğ¸Ñ‚ĞºĞ°',amount:10800,paid:false},{name:'Ğ’ ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ',amount:2500,paid:false},{name:'Ğ¯Ğ½Ğ´ĞµĞºÑ ĞŸĞµĞ¹',amount:10914,paid:false},{name:'ĞĞ»ÑŒÑ„Ğ°',amount:10400,paid:false},{name:'ĞŸÑ€Ğ¾Ğ´ÑƒĞºÑ‚Ñ‹',amount:10000,paid:false}]},
  {name:'Ñ„ĞµĞ²Ñ€Ğ°Ğ»ÑŒ 5',income:128800,expenses:[{name:'Ğ¢Ğ¸Ğ½ÑŒĞºĞ¾Ñ„ Ğ°Ğ²Ñ‚Ğ¾',amount:4690,paid:false},{name:'Ğ¯Ğ½Ğ´ĞµĞºÑ ĞŸĞµĞ¹',amount:29910,paid:false},{name:'ĞĞ»ÑŒÑ„Ğ°',amount:10400,paid:false},{name:'Ğ’ ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ',amount:55500,paid:false},{name:'ĞŸÑ€Ğ¾Ğ´ÑƒĞºÑ‚Ñ‹',amount:9000,paid:false},{name:'ĞœĞ¾Ğ¹ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½',amount:390,paid:false},{name:'Ğ”Ğ¾Ğ»Ğ³ Ğ¼Ğ°Ğ¼Ğµ',amount:22500,paid:false}]},
  {name:'Ñ„ĞµĞ²Ñ€Ğ°Ğ»ÑŒ 20',income:78947,expenses:[{name:'Ğ¢Ğ¸Ğ½ÑŒĞºĞ¾Ñ„ Ğ°Ğ²Ñ‚Ğ¾',amount:4690,paid:false},{name:'Ğ¢Ğ¸Ğ½ÑŒĞºĞ¾Ñ„ ĞºÑ€ĞµĞ´Ğ¸Ñ‚ĞºĞ°',amount:6400,paid:false},{name:'Ğ”Ğ¾Ğ»Ğ³ Ğ¼Ğ°Ğ¼Ğµ',amount:22500,paid:false},{name:'Ğ’Ğ¾Ğ»Ğ¾ÑÑ‹',amount:40000,paid:false},{name:'Ğ¡Ğ¿Ğ»Ğ¸Ñ‚',amount:1650,paid:false},{name:'ĞĞ·Ğ¾Ğ½ Ñ„ĞµĞ²Ñ€Ğ°Ğ»ÑŒ',amount:30000,paid:false},{name:'ĞœĞµĞ»Ğ¾Ñ‡Ğ¸',amount:10000,paid:false}]},
  {name:'Ğ¼Ğ°Ñ€Ñ‚ 5',income:71053,expenses:[{name:'Ğ¢Ğ¸Ğ½ÑŒĞºĞ¾Ñ„ Ğ°Ğ²Ñ‚Ğ¾',amount:4690,paid:false},{name:'Ğ¯Ğ½Ğ´ĞµĞºÑ ĞŸĞµĞ¹',amount:29849,paid:false},{name:'ĞĞ»ÑŒÑ„Ğ°',amount:10400,paid:false},{name:'Ğ’ ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ',amount:26900,paid:false},{name:'ĞŸÑ€Ğ¾Ğ´ÑƒĞºÑ‚Ñ‹',amount:9000,paid:false},{name:'ĞœĞ¾Ğ¹ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½',amount:390,paid:false},{name:'Ğ ĞµÑĞ½Ğ¸Ñ†Ñ‹',amount:2500,paid:false},{name:'Ğ¢Ğ¸Ğ½ÑŒĞºĞ¾Ğ² ĞºÑ€ĞµĞ´Ğ¸Ñ‚ĞºĞ°',amount:1900,paid:false}]},
  {name:'Ğ¼Ğ°Ñ€Ñ‚ 20',income:64286,expenses:[{name:'Ğ’ ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ',amount:49000,paid:false},{name:'ĞŸÑ€Ğ¾Ğ´ÑƒĞºÑ‚Ñ‹',amount:7900,paid:false},{name:'ĞœĞ°Ğ¼Ğ° ÑĞ²ÑĞ·ÑŒ',amount:1500,paid:false},{name:'ĞĞ·Ğ¾Ğ½ Ğ¼Ğ°Ñ€Ñ‚',amount:3344,paid:false},{name:'Ğ ĞµÑĞ½Ğ¸Ñ†Ñ‹',amount:2500,paid:false}]},
  {name:'Ğ°Ğ¿Ñ€ĞµĞ»ÑŒ 5',income:85714,expenses:[{name:'Ğ¯Ğ½Ğ´ĞµĞºÑ ĞŸĞµĞ¹',amount:29849,paid:false},{name:'Ğ¢Ğ¸Ğ½ÑŒĞºĞ¾Ñ„ Ğ°Ğ²Ñ‚Ğ¾',amount:4690,paid:false},{name:'ĞĞ»ÑŒÑ„Ğ°',amount:10400,paid:false},{name:'Ğ’ ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ',amount:26900,paid:false},{name:'ĞŸÑ€Ğ¾Ğ´ÑƒĞºÑ‚Ñ‹',amount:9000,paid:false},{name:'ĞœĞ¾Ğ¹ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½',amount:390,paid:false},{name:'Ğ ĞµÑĞ½Ğ¸Ñ†Ñ‹',amount:2500,paid:false},{name:'Ğ¢Ğ¸Ğ½ÑŒĞºĞ¾Ğ² ĞºÑ€ĞµĞ´Ğ¸Ñ‚ĞºĞ°',amount:1900,paid:false}]},
  {name:'Ğ°Ğ¿Ñ€ĞµĞ»ÑŒ 20',income:75000,expenses:[{name:'Ğ’ ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ',amount:60000,paid:false},{name:'ĞŸÑ€Ğ¾Ğ´ÑƒĞºÑ‚Ñ‹',amount:8700,paid:false},{name:'ĞœĞ°Ğ¼Ğ° ÑĞ²ÑĞ·ÑŒ',amount:1500,paid:false},{name:'ĞĞ·Ğ¾Ğ½ Ğ°Ğ¿Ñ€ĞµĞ»ÑŒ',amount:3174,paid:false},{name:'Ğ ĞµÑĞ½Ğ¸Ñ†Ñ‹',amount:2500,paid:false}]},
  {name:'Ğ¼Ğ°Ğ¹ 5',income:75000,expenses:[{name:'Ğ¯Ğ½Ğ´ĞµĞºÑ ĞŸĞµĞ¹',amount:29849,paid:false},{name:'Ğ¢Ğ¸Ğ½ÑŒĞºĞ¾Ñ„ Ğ°Ğ²Ñ‚Ğ¾',amount:4690,paid:false},{name:'ĞĞ»ÑŒÑ„Ğ°',amount:10400,paid:false},{name:'Ğ’ ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ',amount:15000,paid:false},{name:'ĞŸÑ€Ğ¾Ğ´ÑƒĞºÑ‚Ñ‹',amount:10000,paid:false},{name:'ĞœĞ¾Ğ¹ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½',amount:390,paid:false},{name:'Ğ ĞµÑĞ½Ğ¸Ñ†Ñ‹',amount:2500,paid:false},{name:'Ğ¢Ğ¸Ğ½ÑŒĞºĞ¾Ğ² ĞºÑ€ĞµĞ´Ğ¸Ñ‚ĞºĞ°',amount:1900,paid:false}]},
  {name:'Ğ¼Ğ°Ğ¹ 20',income:66667,expenses:[{name:'Ğ’ ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ',amount:55700,paid:false},{name:'ĞŸÑ€Ğ¾Ğ´ÑƒĞºÑ‚Ñ‹',amount:9400,paid:false},{name:'Ğ§Ğ°Ñ‚ Ğ³Ğ¿Ñ‚',amount:2490,paid:false},{name:'ĞœĞ°Ğ¼Ğ° ÑĞ²ÑĞ·ÑŒ',amount:1500,paid:false},{name:'ĞĞ·Ğ¾Ğ½ Ğ¼Ğ°Ğ¹',amount:3159,paid:false}]},
  {name:'Ğ¸ÑĞ½ÑŒ 5',income:83333,expenses:[{name:'Ğ ĞµÑĞ½Ğ¸Ñ†Ñ‹',amount:2500,paid:false},{name:'Ğ¯Ğ½Ğ´ĞµĞºÑ ĞŸĞµĞ¹',amount:18935,paid:false},{name:'Ğ¢Ğ¸Ğ½ÑŒĞºĞ¾Ñ„ Ğ°Ğ²Ñ‚Ğ¾',amount:4690,paid:false},{name:'ĞĞ»ÑŒÑ„Ğ°',amount:10400,paid:false},{name:'Ğ’ ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ',amount:30000,paid:false},{name:'ĞŸÑ€Ğ¾Ğ´ÑƒĞºÑ‚Ñ‹',amount:9500,paid:false},{name:'Ğ¢Ğ¸Ğ½ÑŒĞºĞ¾Ğ² ĞºÑ€ĞµĞ´Ğ¸Ñ‚ĞºĞ°',amount:1900,paid:false}]},
  {name:'Ğ¸ÑĞ½ÑŒ 20',income:71429,expenses:[{name:'ĞŸÑ€Ğ¾Ğ´ÑƒĞºÑ‚Ñ‹',amount:10000,paid:false},{name:'Ğ’ ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ',amount:60000,paid:false},{name:'Ğ§Ğ°Ñ‚ Ğ³Ğ¿Ñ‚',amount:2600,paid:false},{name:'ĞœĞ°Ğ¼Ğ° ÑĞ²ÑĞ·ÑŒ',amount:1500,paid:false}]},
];
const INIT_BASE_PAYMENTS = [
  {id:'bp1',name:'Ğ¢Ğ¸Ğ½ÑŒĞºĞ¾Ñ„ Ğ°Ğ²Ñ‚Ğ¾',amount:4690,day:5},
  {id:'bp2',name:'Ğ¯Ğ½Ğ´ĞµĞºÑ ĞŸĞµĞ¹',amount:29849,day:5},
  {id:'bp3',name:'ĞĞ»ÑŒÑ„Ğ°',amount:10400,day:5},
  {id:'bp4',name:'ĞŸÑ€Ğ¾Ğ´ÑƒĞºÑ‚Ñ‹',amount:9000,day:5},
  {id:'bp5',name:'ĞœĞ¾Ğ¹ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½',amount:390,day:5},
  {id:'bp6',name:'Ğ ĞµÑĞ½Ğ¸Ñ†Ñ‹',amount:2500,day:5},
  {id:'bp7',name:'Ğ¢Ğ¸Ğ½ÑŒĞºĞ¾Ñ„ ĞºÑ€ĞµĞ´Ğ¸Ñ‚ĞºĞ°',amount:1900,day:5},
  {id:'bp8',name:'ĞŸÑ€Ğ¾Ğ´ÑƒĞºÑ‚Ñ‹',amount:8000,day:20},
  {id:'bp9',name:'ĞœĞ°Ğ¼Ğ° ÑĞ²ÑĞ·ÑŒ',amount:1500,day:20},
  {id:'bp10',name:'Ğ ĞµÑĞ½Ğ¸Ñ†Ñ‹',amount:2500,day:20},
  {id:'bp11',name:'Ğ§Ğ°Ñ‚ Ğ³Ğ¿Ñ‚',amount:2500,day:20},
];
const INIT_KOPILKA = {
  balance:42369,
  timeline:[
    {id:'t1',type:'income',name:'Ğ´ĞµĞºĞ°Ğ±Ñ€ÑŒ 30',amount:15000,paid:true,isCredit:false,pastBal:76010},
    {id:'t2',type:'income',name:'ÑĞ½Ğ²Ğ°Ñ€ÑŒ 20',amount:22500,paid:true,isCredit:false,pastBal:86331},
    {id:'t3',type:'expense',name:'Ğ¼Ğ°Ğ¼Ğ° Ğ² Ğ´Ğ¾Ğ»Ğ³ Ñ„ĞµĞ²Ñ€Ğ°Ğ»ÑŒ 13',amount:70000,paid:true,isCredit:false,pastBal:16331},
    {id:'t4',type:'income',name:'Ñ„ĞµĞ²Ñ€Ğ°Ğ»ÑŒ 5',amount:55500,paid:true,isCredit:false,pastBal:91831},
    {id:'t5',type:'expense',name:'ĞºÑ€ĞµĞ´Ğ¸Ñ‚ Ñ„ĞµĞ²Ñ€Ğ°Ğ»ÑŒ 5',amount:93000,paid:true,isCredit:true,pastBal:9192},
    {id:'t6',type:'income',name:'Ğ¼Ğ°Ğ¼Ğ° Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ñ„ĞµĞ²Ñ€Ğ°Ğ»ÑŒ 24',amount:50000,paid:true,isCredit:false,pastBal:59192},
    {id:'t7',type:'income',name:'Ñ„ĞµĞ²Ñ€Ğ°Ğ»ÑŒ 20',amount:62800,paid:false,isCredit:false},
    {id:'t8',type:'expense',name:'ĞºÑ€ĞµĞ´Ğ¸Ñ‚ Ñ„ĞµĞ²Ñ€Ğ°Ğ»ÑŒ 20',amount:17000,paid:false,isCredit:true},
    {id:'t9',type:'income',name:'Ğ¼Ğ°Ñ€Ñ‚ 5',amount:21200,paid:false,isCredit:false},
    {id:'t10',type:'expense',name:'ĞºÑ€ĞµĞ´Ğ¸Ñ‚ Ğ¼Ğ°Ñ€Ñ‚ 5',amount:93000,paid:false,isCredit:true},
    {id:'t11',type:'income',name:'Ğ¼Ğ°Ñ€Ñ‚ 20',amount:49000,paid:false,isCredit:false},
    {id:'t12',type:'expense',name:'ĞºÑ€ĞµĞ´Ğ¸Ñ‚ Ğ¼Ğ°Ñ€Ñ‚ 20',amount:17000,paid:false,isCredit:true},
    {id:'t13',type:'income',name:'Ğ°Ğ¿Ñ€ĞµĞ»ÑŒ 5',amount:26900,paid:false,isCredit:false},
    {id:'t14',type:'expense',name:'ĞºÑ€ĞµĞ´Ğ¸Ñ‚ Ğ°Ğ¿Ñ€ĞµĞ»ÑŒ 5',amount:93000,paid:false,isCredit:true},
    {id:'t15',type:'income',name:'Ğ°Ğ¿Ñ€ĞµĞ»ÑŒ 20',amount:60000,paid:false,isCredit:false},
    {id:'t16',type:'expense',name:'ĞºÑ€ĞµĞ´Ğ¸Ñ‚ Ğ°Ğ¿Ñ€ĞµĞ»ÑŒ 20',amount:17000,paid:false,isCredit:true},
    {id:'t17',type:'income',name:'Ğ¼Ğ°Ğ¹ 5',amount:15000,paid:false,isCredit:false},
    {id:'t18',type:'expense',name:'ĞºÑ€ĞµĞ´Ğ¸Ñ‚ Ğ¼Ğ°Ğ¹ 5',amount:93000,paid:false,isCredit:true},
  ]
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadState(){
  try{const s=localStorage.getItem('finance_v10');if(s)return JSON.parse(s);}catch(e){}
  return{periods:[],kopilka:{entries:[],balance:0},basePayments:JSON.parse(JSON.stringify(INIT_BASE_PAYMENTS)),currentIdx:0,salary:150000,excludedBPs:{}};
}
function saveState(){localStorage.setItem('finance_v10',JSON.stringify(state));}

let state = loadState();
let curTab = 'periods';
let editExpIdx = null;
let kopOpType = 'add';
let editBPIdx = null;
let bpDay = 5;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GOOGLE AUTH & SHEETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let gAccessToken = null;
let gUserEmail   = null;
let tokenClient  = null;
let isSyncing    = false;

function setSyncStatus(status, label) {
  const badge = document.getElementById('sync-badge');
  const lbl   = document.getElementById('sync-label');
  if (badge) { badge.className = 'sync-badge ' + status; }
  const emoji = status === 'connected' ? 'ğŸ™‚' : status === 'syncing' ? 'ğŸ‘€' : 'ğŸ¤«';
  if (lbl) lbl.textContent = emoji;
  // Desktop badge
  const lblDt = document.getElementById('sync-label-dt');
  if (lblDt) lblDt.textContent = emoji;
  // Refresh desktop grid when connected
  if (status === 'connected' && typeof isDesktop === 'function' && isDesktop()) {
    if (typeof dtCurrentTab !== 'undefined') {
      if (dtCurrentTab === 'periods') setTimeout(renderDtGrid, 0);
      renderDtKopilkaBalance();
    }
  }
}

function saveToken(token, email) {
  localStorage.setItem('gauth_v2', JSON.stringify({
    token, email, savedAt: Date.now()
  }));
}

function loadSavedToken() {
  try {
    const d = JSON.parse(localStorage.getItem('gauth_v2') || '{}');
    if (!d.token || !d.savedAt) return null;
    const age = (Date.now() - d.savedAt) / 1000 / 60; // minutes
    if (age > 50) return null; // expired
    return d;
  } catch(e) { return null; }
}

async function onTokenReady(token) {
  gAccessToken = token;
  setSyncStatus('syncing','ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ...');
  try {
    await initSheets();
    await syncFromSheets();
    setSyncStatus('connected','ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾');
    renderPeriod();
    renderKopilka();
  } catch(e) {
    setSyncStatus('error','Ğ¾ÑˆĞ¸Ğ±ĞºĞ°');
    showToast('âŒ ' + (e.message || 'ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸'));
  }
  renderSettings();
}

function initGoogleAuth() {
  // Try to restore saved token first (< 50 min old)
  const saved = loadSavedToken();
  if (saved) {
    gUserEmail = saved.email;
    setSyncStatus('syncing','Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ...');
    onTokenReady(saved.token);
  } else {
    // Try to get email for silent refresh hint
    try {
      const d = JSON.parse(localStorage.getItem('gauth_v2') || '{}');
      if (d.email) gUserEmail = d.email;
    } catch(e) {}
  }

  // Wait for GSI to load
  const waitGSI = setInterval(() => {
    if (typeof google === 'undefined' || !google.accounts) return;
    clearInterval(waitGSI);

    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: GOOGLE_CLIENT_ID,
      scope: SCOPES,
      callback: async (resp) => {
        if (resp.error) { setSyncStatus('error','Ğ¾ÑˆĞ¸Ğ±ĞºĞ°'); showToast('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸'); return; }
        // Fetch email if not known
        if (!gUserEmail) {
          fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
            headers: { Authorization: `Bearer ${resp.access_token}` }
          }).then(r=>r.json()).then(info => {
            if (info.email) { gUserEmail = info.email; renderAuthCard(); }
            saveToken(resp.access_token, gUserEmail || '');
          }).catch(()=>{ saveToken(resp.access_token, gUserEmail || ''); });
        } else {
          saveToken(resp.access_token, gUserEmail);
        }
        await onTokenReady(resp.access_token);
      }
    });

    // If token was already restored â€” no need for silent refresh
    if (gAccessToken) return;

    // Try silent refresh if we know the email
    if (gUserEmail) {
      setSyncStatus('syncing','Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ...');
      tokenClient.requestAccessToken({ prompt: 'none', login_hint: gUserEmail,
        error_callback: () => {
          setSyncStatus('offline','Ğ¾Ñ„Ğ»Ğ°Ğ¹Ğ½');
          renderAuthCard();
        }
      });
    }
  }, 200);
}

function signIn() {
  if (!tokenClient) {
    showToast('â³ ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ...');
    let attempts = 0;
    const wait = setInterval(() => {
      attempts++;
      if (tokenClient) {
        clearInterval(wait);
        tokenClient.requestAccessToken({ prompt: 'consent' });
      } else if (attempts > 25) {
        clearInterval(wait);
        showToast('âŒ ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ² Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ Ğ¸Ğ½ĞºĞ¾Ğ³Ğ½Ğ¸Ñ‚Ğ¾ (Ñ€Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ¸Ñ Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ)');
      }
    }, 200);
    return;
  }
  tokenClient.requestAccessToken({ prompt: 'consent' });
}

function signOut() {
  if (gAccessToken) {
    google.accounts.oauth2.revoke(gAccessToken);
    gAccessToken = null;
  }
  gUserEmail = null;
  localStorage.removeItem('gauth_v2');
  setSyncStatus('offline','Ğ¾Ñ„Ğ»Ğ°Ğ¹Ğ½');
  renderSettings();
  showToast('ğŸ‘‹ ĞÑ‚ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾ Ğ¾Ñ‚ Google');
}

async function sheetsRequest(method, range, body) {
  if (!gAccessToken) throw new Error('ĞĞµÑ‚ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸');
  const base = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}`;
  let url, opts;

  if (method === 'GET') {
    url = `${base}/values/${encodeURIComponent(range)}?majorDimension=ROWS`;
    opts = { headers: { Authorization: `Bearer ${gAccessToken}` } };
  } else if (method === 'PUT') {
    url = `${base}/values/${encodeURIComponent(range)}?valueInputOption=USER_ENTERED`;
    opts = { method:'PUT', headers:{'Authorization':`Bearer ${gAccessToken}`,'Content-Type':'application/json'}, body:JSON.stringify(body) };
  } else if (method === 'CLEAR') {
    url = `${base}/values/${encodeURIComponent(range)}:clear`;
    opts = { method:'POST', headers:{'Authorization':`Bearer ${gAccessToken}`,'Content-Type':'application/json'}, body:'{}' };
  } else if (method === 'BATCH_UPDATE') {
    url = `${base}/values:batchUpdate`;
    opts = { method:'POST', headers:{'Authorization':`Bearer ${gAccessToken}`,'Content-Type':'application/json'}, body:JSON.stringify(body) };
  }

  const resp = await fetch(url, opts);
  if (!resp.ok) {
    const err = await resp.json().catch(() => ({}));
    // Token might be expired â€” reset
    if (resp.status === 401) { gAccessToken = null; setSyncStatus('offline','Ğ¾Ñ„Ğ»Ğ°Ğ¹Ğ½'); }
    throw new Error(err.error?.message || `HTTP ${resp.status}`);
  }
  return resp.json();
}

// â”€â”€â”€ Check if sheets exist and have headers, create if needed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function initSheets() {
  // Get spreadsheet metadata to see existing sheet names
  const metaResp = await fetch(
    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}?fields=sheets.properties.title`,
    { headers: { Authorization: `Bearer ${gAccessToken}` } }
  );
  const meta = await metaResp.json();
  const existingSheets = meta.sheets?.map(s => s.properties.title) || [];

  // Just verify sheets exist, no headers needed
  const needed = [SH_PERIODS, SH_KOPILKA, SH_BP];
  for (const name of needed) {
    if (!existingSheets.includes(name)) {
      throw new Error(`Ğ›Ğ¸ÑÑ‚ "${name}" Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹ ĞµĞ³Ğ¾ Ğ² Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğµ.`);
    }
  }

  // Get user info
  try {
    const ui = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', { headers: { Authorization: `Bearer ${gAccessToken}` } });
    const ud = await ui.json();
    gUserEmail = ud.email;
    localStorage.setItem('gauth_v2', JSON.stringify({ email: gUserEmail }));
  } catch(e) {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SYNC: READ FROM SHEETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function syncFromSheets() {
  setSyncStatus('syncing','Ñ‡Ñ‚ĞµĞ½Ğ¸Ğµ...');

  // --- BASE PAYMENTS first (needed for auto-populate) ---
  const bpResp = await sheetsRequest('GET', `${SH_BP}!A1:C100`);
  const bpRows = bpResp.values || [];
  if (bpRows.length > 0) {
    const bps = bpRows
      .filter(r => r[0] && r[0] !== 'Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ' && r[0] !== 'name') // skip header if exists
      .map((r,i) => ({
        id: 'bp_'+i, name: r[0]||'',
        amount: parseFloat(String(r[1]||'').replace(/\s/g,''))||0,
        day: parseInt(r[2])||5,
      }))
      .filter(bp => bp.name && bp.amount > 0);
    if (bps.length > 0) state.basePayments = bps;
  }
  // No fallback write â€” table is the source of truth

  // --- PERIODS ---
  const perResp = await sheetsRequest('GET', `${SH_PERIODS}!A1:ZZ500`);
  const perRows = perResp.values || [];

  if (perRows.length > 0) {
    const curName = state.periods[state.currentIdx]?.name;
    const periods = [];

    for (const row of perRows) {
      if (!row[0] || !row[1]) continue;
      const name   = row[0].trim();
      const income = parseFloat(String(row[1]).replace(/\s/g,'')) || 0;
      // Only read MANUAL expenses from ĞŸĞµÑ€Ğ¸Ğ¾Ğ´Ñ‹ sheet (not base payments)
      const allExpenses = [];
      // New format: 4 cols per expense (name, amount, paid, type)
      // Old format: 3 cols per expense (name, amount, paid) - backward compat
      let c = 2;
      while (c < row.length) {
        const expName = (row[c] || '').trim();
        const expAmt  = parseFloat(String(row[c+1] || '').replace(/\s/g,''));
        const expPaid = (row[c+2] || '').toString().toUpperCase() === 'TRUE';
        const expType = (row[c+3] || '').trim().toLowerCase();
        if (expName && !isNaN(expAmt) && expAmt > 0) {
          // If type field is one of known types â€” new format (4 cols)
          const knownType = expType === 'manual' || expType === 'base' || expType === 'kopilka';
          if (knownType) {
            allExpenses.push({ name: expName, amount: expAmt, paid: expPaid,
              manual: expType === 'manual', fromKopilka: expType === 'kopilka' });
            c += 4;
          } else {
            // Old format (3 cols)
            allExpenses.push({ name: expName, amount: expAmt, paid: expPaid, manual: true });
            c += 3;
          }
        } else { c += 3; }
      }
      periods.push({ name, income, allExpenses });
    }

    if (periods.length > 0) {
      periods.forEach(p => {
        const day = parseInt(p.name.match(/\d+$/)?.[0]) || 0;
        const bps = state.basePayments.filter(bp => bp.day === day);
        const excludedForPeriod = (state.excludedBPs && state.excludedBPs[p.name.toLowerCase()]) || [];

        // New format: allExpenses contains everything with types
        if (p.allExpenses && p.allExpenses.length > 0) {
          // Merge: use sheet data as source of truth for paid status
          // For base expenses in sheet â€” use their paid status directly
          // Add any base payments that are missing from sheet (new BPs added after period was written)
          const sheetBaseNames = new Set(p.allExpenses.filter(e => !e.manual && !e.fromKopilka).map(e => e.name));
          const sheetManualNames = new Set(p.allExpenses.filter(e => e.manual).map(e => e.name));
          const missingBPs = bps
            .filter(bp => !excludedForPeriod.includes(bp.name) && !sheetBaseNames.has(bp.name) && !sheetManualNames.has(bp.name))
            .map(bp => ({ name: bp.name, amount: bp.amount, paid: false, manual: false }));
          p.expenses = [...p.allExpenses, ...missingBPs];
          delete p.allExpenses;
        } else {
          // Old format or empty: reconstruct from base payments
          const oldPeriod = state.periods.find(op => op.name === p.name);
          const basePaidMap = {};
          if (oldPeriod) oldPeriod.expenses.forEach(e => { if (!e.manual && !e.fromKopilka) basePaidMap[e.name] = e.paid; });
          const baseExpenses = bps
            .filter(bp => !excludedForPeriod.includes(bp.name))
            .map(bp => ({ name: bp.name, amount: bp.amount, paid: basePaidMap[bp.name] || false, manual: false }));
          const manuals = (p.manualExpenses || []);
          p.expenses = [...baseExpenses, ...manuals];
          delete p.manualExpenses;
          delete p.allExpenses;
        }
      });

      state.periods = periods;
      const newIdx = periods.findIndex(p => p.name === curName);
      if (newIdx >= 0) {
        state.currentIdx = newIdx;
      } else {
        let best = 0;
        for (let i = 0; i < periods.length; i++) {
          const pd = getPeriodDate(periods[i].name);
          const today = new Date(); today.setHours(0,0,0,0);
          if (pd && pd <= today) best = i;
        }
        state.currentIdx = best;
      }

      // No need to write back â€” base payments are NOT stored in ĞŸĞµÑ€Ğ¸Ğ¾Ğ´Ñ‹ sheet
    }
  }

  // --- KOPILKA ---
  // Format: Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´ | Ñ‚Ğ¸Ğ¿ | Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ | ÑÑƒĞ¼Ğ¼Ğ° | Ğ¾Ğ¿Ğ»Ğ°Ñ‡ĞµĞ½Ğ¾
  // Ñ‚Ğ¸Ğ¿: 'Ğ±Ğ°Ğ»Ğ°Ğ½Ñ' | 'Ğ² ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ' | 'Ğ¸Ğ· ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºĞ¸' | 'ĞºÑ€ĞµĞ´Ğ¸Ñ‚'
  const kopResp = await sheetsRequest('GET', `${SH_KOPILKA}!A1:E500`);
  const kopRows = kopResp.values || [];
  if (kopRows.length > 0) {
    const entries = kopRows
      .filter(r => r[0] && r[3] && r[0] !== 'Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´')
      .map((r, i) => {
        const period = (r[0]||'').trim();
        const typ = (r[1]||'').trim();
        const name = (r[2]||'').trim();
        const stableId = 'k_' + period.toLowerCase().replace(/\s+/g,'_') + '__' + typ.toLowerCase().replace(/\s+/g,'_');
        return {
          id: stableId,
          period, typ, name,
          amount: parseFloat(String(r[3]||'').replace(/\s/g,''))||0,
          paid: (r[4]||'').toString().toUpperCase() === 'TRUE',
          rowIndex: i + 1,
        };
      })
      .filter(e => e.amount > 0);
    if (entries.length > 0) {
      state.kopilka.entries = entries;
      recalcKopilkaBalance();
      injectKopilkaIntoPeriods();
      // Debug: log what was read
      console.log('Kopilka entries:', entries.map(e => e.period + ' | ' + e.typ + ' | ' + e.amount + ' | paid:' + e.paid));
      console.log('Kopilka balance:', state.kopilka.balance);
    }
  }

  saveState();
}

function recalcKopilkaBalance() {
  if (!state.kopilka.entries || !state.kopilka.entries.length) return;
  let bal = 0;
  state.kopilka.entries.forEach(e => {
    if (!e.paid) return;
    const t = e.typ.toLowerCase().trim();
    if (t === 'Ğ±Ğ°Ğ»Ğ°Ğ½Ñ' || t === 'Ğ² ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ') bal += e.amount;
    else bal -= e.amount; // 'Ğ¸Ğ· ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºĞ¸', 'ĞºÑ€ĞµĞ´Ğ¸Ñ‚'
  });
  state.kopilka.balance = bal;
}

function injectKopilkaIntoPeriods() {
  // First clear ALL fromKopilka entries from all periods
  state.periods.forEach(p => {
    p.expenses = p.expenses.filter(e => !e.fromKopilka);
  });
  // Then inject current kopilka entries into matching periods
  (state.kopilka.entries || []).forEach(kEntry => {
    if (kEntry.typ.toLowerCase().trim() !== 'Ğ² ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ') return;
    const p = state.periods.find(p => p.name.toLowerCase().trim() === kEntry.period.toLowerCase().trim());
    if (!p) return;
    // Only inject once per period (skip if already injected)
    if (p.expenses.some(e => e.fromKopilka)) return;
    p.expenses.unshift({
      name: 'Ğ’ ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ',
      amount: kEntry.amount,
      paid: kEntry.paid,
      manual: false,
      fromKopilka: true,
      kopilkaId: kEntry.id,
    });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SYNC: WRITE TO SHEETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function writeKopilkaToSheets() {
  // Write full kopilka table (period | Ñ‚Ğ¸Ğ¿ | Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ | ÑÑƒĞ¼Ğ¼Ğ° | Ğ¾Ğ¿Ğ»Ğ°Ñ‡ĞµĞ½Ğ¾)
  const rows = state.kopilka.entries.map(e => [
    e.period, e.typ, e.name, e.amount,
    e.paid ? 'TRUE' : 'FALSE'
  ]);
  await sheetsRequest('CLEAR', `${SH_KOPILKA}!A1:E500`);
  if (rows.length > 0) {
    await sheetsRequest('PUT', `${SH_KOPILKA}!A1`, { range:`${SH_KOPILKA}!A1`, majorDimension:'ROWS', values: rows });
  }
}

// Write only the paid status of one entry (by rowIndex)
async function writeKopilkaRowPaid(entry) {
  if (!gAccessToken || !entry.rowIndex) return;
  const row = entry.rowIndex;
  await sheetsRequest('PUT', `${SH_KOPILKA}!E${row}`, {
    range: `${SH_KOPILKA}!E${row}`,
    majorDimension: 'ROWS',
    values: [[entry.paid ? 'TRUE' : 'FALSE']]
  });
}

// Write only the amount of one entry (by rowIndex)
async function writeKopilkaRowAmount(entry) {
  if (!gAccessToken || !entry.rowIndex) return;
  const row = entry.rowIndex;
  await sheetsRequest('PUT', `${SH_KOPILKA}!D${row}`, {
    range: `${SH_KOPILKA}!D${row}`,
    majorDimension: 'ROWS',
    values: [[entry.amount]]
  });
}

async function writeBPToSheets() {
  const rows = state.basePayments.map(bp => [bp.name, bp.amount, bp.day]);
  await sheetsRequest('CLEAR', `${SH_BP}!A1:C100`);
  await sheetsRequest('PUT', `${SH_BP}!A1`, { range:`${SH_BP}!A1`, majorDimension:'ROWS', values: rows });
}

// â”€â”€â”€ Build row for a period: income + ALL expenses with type â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildPeriodRow(p) {
  const row = [p.name, p.income];
  p.expenses.forEach(e => {
    const type = e.fromKopilka ? 'kopilka' : (e.manual ? 'manual' : 'base');
    row.push(e.name, e.amount, e.paid ? 'TRUE' : 'FALSE', type);
  });
  return row;
}

// â”€â”€â”€ Write period row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function writePeriodRow(periodIdx) {
  if (!gAccessToken) return;
  const p = state.periods[periodIdx];
  const sheetRow = periodIdx + 1;
  const row = buildPeriodRow(p);
  await sheetsRequest('CLEAR', `${SH_PERIODS}!A${sheetRow}:ZZ${sheetRow}`);
  await sheetsRequest('PUT', `${SH_PERIODS}!A${sheetRow}`, {
    range: `${SH_PERIODS}!A${sheetRow}`,
    majorDimension: 'ROWS',
    values: [row]
  });
}

// â”€â”€â”€ Write ALL periods to sheet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function writeAllPeriods() {
  if (!gAccessToken) return;
  await sheetsRequest('CLEAR', `${SH_PERIODS}!A1:ZZ500`);
  for (let i = 0; i < state.periods.length; i++) {
    const row = buildPeriodRow(state.periods[i]);
    await sheetsRequest('PUT', `${SH_PERIODS}!A${i+1}`, {
      range: `${SH_PERIODS}!A${i+1}`,
      majorDimension: 'ROWS',
      values: [row]
    });
  }
}

// â”€â”€â”€ Debounced sync wrapper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let syncTimer = null;
function scheduleSync(writeFn) {
  if (!gAccessToken) return;
  clearTimeout(syncTimer);
  syncTimer = setTimeout(async () => {
    setSyncStatus('syncing','ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ...');
    try {
      await writeFn();
      setSyncStatus('connected','ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾');
    } catch(e) {
      setSyncStatus('error','Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸');
      showToast('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ² Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ');
    }
  }, 800);
}

async function manualSync() {
  if (!gAccessToken) { signIn(); return; }
  setSyncStatus('syncing','ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ...');
  try {
    await syncFromSheets();
    setSyncStatus('connected','ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾');
    showToast('ğŸ”„ Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹!');
    renderPeriod();
    if (curTab === 'kopilka') renderKopilka();
    if (curTab === 'settings') renderSettings();
  } catch(e) {
    setSyncStatus('error','Ğ¾ÑˆĞ¸Ğ±ĞºĞ°');
    showToast('âŒ ' + (e.message || 'ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸'));
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmt(n){return Math.round(n).toLocaleString('ru-RU');}
let toastTimer=null;
function showToast(msg, duration){
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.classList.add('show');
  if(toastTimer)clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>t.classList.remove('show'), duration||2500);
}
function closeModal(id){document.getElementById(id).classList.remove('open');}
function openModal(id){document.getElementById(id).classList.add('open');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(tab){
  curTab=tab;
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(n=>n.classList.remove('active'));
  document.getElementById('screen-'+tab).classList.add('active');
  const nav=document.getElementById('nav-'+tab);if(nav)nav.classList.add('active');
  if(tab==='kopilka')renderKopilka();
  if(tab==='periods')renderPeriod();
  if(tab==='settings')renderSettings();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PERIODS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function changePeriod(dir){
  const ni=state.currentIdx+dir;
  if(ni<0||ni>=state.periods.length)return;
  state.currentIdx=ni;saveState();renderPeriod();
}

function renderPeriod(){
  if(!state.periods.length){
    document.getElementById('period-name').textContent='â€”';
    document.getElementById('hero-income').textContent='0 â‚½';
    document.getElementById('hero-exp').textContent='0 â‚½';
    document.getElementById('hero-paid').textContent='0 â‚½';
    const le=document.getElementById('hero-left');le.textContent='0 â‚½';le.className='hero-stat-val yellow';
    document.getElementById('prog-pct').textContent='0%';
    document.getElementById('prog-fill').style.width='0%';
    document.getElementById('btn-prev').disabled=true;
    document.getElementById('btn-next').disabled=true;
    document.getElementById('mk-val').textContent=fmt(state.kopilka.balance);
    document.getElementById('exp-list').innerHTML='<div class="empty-state"><div class="empty-ico">ğŸ”„</div><div class="empty-txt">Ğ’Ğ¾Ğ¹Ğ´Ğ¸ Ñ‡ĞµÑ€ĞµĞ· Google<br>Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ñ‹</div></div>';
    return;
  }
  const p=state.periods[state.currentIdx];
  document.getElementById('period-name').textContent=p.name;
  document.getElementById('hero-income').textContent=fmt(p.income);
  const totalExp=p.expenses.reduce((s,e)=>s+e.amount,0);
  const paidExp=p.expenses.filter(e=>e.paid).reduce((s,e)=>s+e.amount,0);
  const leftover=p.income-totalExp;
  document.getElementById('hero-exp').textContent=fmt(totalExp);
  document.getElementById('hero-paid').textContent=fmt(paidExp);
  const le=document.getElementById('hero-left');
  le.textContent=fmt(leftover);
  le.className='hero-stat-val '+(leftover<0?'coral':'yellow');
  const pct=totalExp>0?Math.round(paidExp/totalExp*100):0;
  document.getElementById('prog-pct').textContent=pct+'%';
  const fill=document.getElementById('prog-fill');
  fill.style.width=Math.min(pct,100)+'%';
  fill.className='prog-fill'+(pct>=100?' warn':pct>=70?' warn':'');
  document.getElementById('btn-prev').disabled=state.currentIdx===0;
  document.getElementById('btn-next').disabled=state.currentIdx===state.periods.length-1;
  if (typeof isDesktop==='function' && isDesktop() && typeof dtCurrentTab!=='undefined' && dtCurrentTab==='periods') setTimeout(renderDtGrid,0);
  document.getElementById('mk-val').textContent=fmt(state.kopilka.balance);

  const isFuture=!isCurrentOrPastPeriod(state.currentIdx);
  const list=document.getElementById('exp-list');list.innerHTML='';

  if(isFuture){
    const notice=document.createElement('div');
    notice.style.cssText='margin:0 0 12px;padding:10px 16px;background:var(--yellow-light);border-radius:var(--rs);font-size:13px;font-weight:600;color:#B8860B;display:flex;align-items:center;gap:8px;';
    notice.innerHTML='â³ Ğ­Ñ‚Ğ¾Ñ‚ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´ ĞµÑ‰Ñ‘ Ğ½Ğµ Ğ½Ğ°ÑÑ‚ÑƒĞ¿Ğ¸Ğ» â€” Ğ¾Ñ‚Ğ¼ĞµÑ‚ĞºĞ° Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ°';
    list.appendChild(notice);
  }
  if(!p.expenses.length){
    const empty=document.createElement('div');
    empty.innerHTML='<div class="empty-state"><div class="empty-ico">ğŸ‰</div><div class="empty-txt">Ğ Ğ°ÑÑ…Ğ¾Ğ´Ğ¾Ğ² Ğ½ĞµÑ‚</div></div>';
    list.appendChild(empty);return;
  }
  p.expenses.forEach((exp,i)=>{
    const el=document.createElement('div');
    el.className='exp-item'+(exp.paid?' paid':'')+(isFuture?' future-locked':'');
    el.innerHTML=`
      <div class="exp-check ${isFuture?'locked':''}" ${isFuture?'':`onclick="toggleExp(${i})"`}>${exp.paid?'âœ“':(isFuture?'ğŸ”’':'')}</div>
      <div class="exp-info"><div class="exp-name">${exp.name}</div></div>
      <div class="exp-amt">${fmt(exp.amount)}</div>
      <div class="exp-actions">
        <button class="exp-btn" onclick="openEditExp(${i})">âœï¸</button>
        <button class="exp-btn del" onclick="deleteExp(${i})">âœ•</button>
      </div>`;
    list.appendChild(el);
  });
}

const MONTH_MAP={'ÑĞ½Ğ²Ğ°Ñ€ÑŒ':0,'Ñ„ĞµĞ²Ñ€Ğ°Ğ»ÑŒ':1,'Ğ¼Ğ°Ñ€Ñ‚':2,'Ğ°Ğ¿Ñ€ĞµĞ»ÑŒ':3,'Ğ¼Ğ°Ğ¹':4,'Ğ¸ÑĞ½ÑŒ':5,'Ğ¸ÑĞ»ÑŒ':6,'Ğ°Ğ²Ğ³ÑƒÑÑ‚':7,'ÑĞµĞ½Ñ‚ÑĞ±Ñ€ÑŒ':8,'Ğ¾ĞºÑ‚ÑĞ±Ñ€ÑŒ':9,'Ğ½Ğ¾ÑĞ±Ñ€ÑŒ':10,'Ğ´ĞµĞºĞ°Ğ±Ñ€ÑŒ':11};
function getPeriodDate(name){
  const parts=name.trim().split(' ');const month=MONTH_MAP[parts[0]];const day=parseInt(parts[1]);
  if(month===undefined||isNaN(day))return null;
  const now=new Date();let year=now.getFullYear();const testDate=new Date(year,month,day);
  const sixMonths=180*24*3600*1000;
  if(testDate-now>sixMonths)year--;else if(now-testDate>sixMonths)year++;
  return new Date(year,month,day);
}
function isCurrentOrPastPeriod(idx){
  const p=state.periods[idx];const pd=getPeriodDate(p.name);if(!pd)return true;
  const today=new Date();today.setHours(0,0,0,0);return pd<=today;
}

function toggleExp(i){
  if(!isCurrentOrPastPeriod(state.currentIdx)){showToast('â³ Ğ­Ñ‚Ğ¾Ñ‚ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´ ĞµÑ‰Ñ‘ Ğ½Ğµ Ğ½Ğ°ÑÑ‚ÑƒĞ¿Ğ¸Ğ»');return;}
  const p=state.periods[state.currentIdx];
  const exp=p.expenses[i];
  exp.paid=!exp.paid;

  if(exp.fromKopilka){
    // Sync paid status back to kopilka entry
    const kEntry=(state.kopilka.entries||[]).find(e=>e.id===exp.kopilkaId);
    if(kEntry){
      kEntry.paid=exp.paid;
      recalcKopilkaBalance();
      document.getElementById('mk-val').textContent=fmt(state.kopilka.balance);
      showToast(exp.paid?'ğŸ’° +'+fmt(exp.amount)+' Ğ² ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ!':'â†©ï¸ Ğ£Ğ±Ñ€Ğ°Ğ½Ğ¾ Ğ¸Ğ· ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºĞ¸');
      scheduleSync(()=>writeKopilkaRowPaid(kEntry));
    }
  }else{
    showToast(exp.paid?'âœ… ĞĞ¿Ğ»Ğ°Ñ‡ĞµĞ½Ğ¾!':'â†©ï¸ ĞĞµ Ğ¾Ğ¿Ğ»Ğ°Ñ‡ĞµĞ½Ğ¾');
    scheduleSync(()=>writePeriodRow(state.currentIdx));
  }
  saveState();renderPeriod();
}

function deleteExp(i){
  if(!confirm('Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ñ€Ğ°ÑÑ…Ğ¾Ğ´?'))return;
  const p = state.periods[state.currentIdx];
  const exp = p.expenses[i];
  // If base payment (not manual, not from kopilka) â€” record exclusion so it doesn't come back on sync
  if(!exp.manual && !exp.fromKopilka){
    if(!state.excludedBPs) state.excludedBPs = {};
    const _epKey = p.name.toLowerCase();
    if(!state.excludedBPs[_epKey]) state.excludedBPs[_epKey] = [];
    if(!state.excludedBPs[_epKey].includes(exp.name))
      state.excludedBPs[_epKey].push(exp.name);
    console.log('Saved exclusion:', _epKey, exp.name, state.excludedBPs);
  }
  p.expenses.splice(i,1);
  saveState();renderPeriod();showToast('ğŸ—‘ï¸ Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¾');
  if(gAccessToken){
    setSyncStatus('syncing','ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ...');
    writePeriodRow(state.currentIdx).then(()=>setSyncStatus('connected','ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾')).catch(()=>setSyncStatus('error','Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸'));
  }
}

function openAddExpense(){
  editExpIdx=null;
  document.getElementById('modal-exp-title').textContent='ĞĞ¾Ğ²Ñ‹Ğ¹ Ñ€Ğ°ÑÑ…Ğ¾Ğ´';
  document.getElementById('exp-name-in').value='';
  document.getElementById('exp-amt-in').value='';
  openModal('modal-expense');
  setTimeout(()=>document.getElementById('exp-name-in').focus(),300);
}
function openEditExp(i){
  const e=state.periods[state.currentIdx].expenses[i];
  // If this is a kopilka-injected expense, open kopilka amount editor
  if(e.fromKopilka){
    openEditKopilkaEntry(e.kopilkaId);
    return;
  }
  editExpIdx=i;
  document.getElementById('modal-exp-title').textContent='Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ñ€Ğ°ÑÑ…Ğ¾Ğ´';
  document.getElementById('exp-name-in').value=e.name;
  document.getElementById('exp-amt-in').value=e.amount;
  openModal('modal-expense');
}

function openEditKopilkaEntry(kopilkaId){
  const entry=(state.kopilka.entries||[]).find(e=>e.id===kopilkaId);
  if(!entry)return;
  document.getElementById('kop-edit-id').value=kopilkaId;
  document.getElementById('kop-edit-amt').value=entry.amount;
  document.getElementById('kop-edit-period').textContent=entry.period;
  openModal('modal-kop-edit');
  setTimeout(()=>document.getElementById('kop-edit-amt').select(),300);
}

function saveKopilkaEntryEdit(){
  const id=document.getElementById('kop-edit-id').value;
  const amt=parseFloat(document.getElementById('kop-edit-amt').value);
  if(isNaN(amt)||amt<=0){showToast('âš ï¸ Ğ’Ğ²ĞµĞ´Ğ¸ ÑÑƒĞ¼Ğ¼Ñƒ');return;}
  const entry=(state.kopilka.entries||[]).find(e=>e.id===id);
  if(!entry)return;
  entry.amount=amt;
  recalcKopilkaBalance();
  injectKopilkaIntoPeriods();
  saveState();
  closeModal('modal-kop-edit');
  renderPeriod();
  if(curTab==='kopilka')renderKopilka();
  document.getElementById('mk-val').textContent=fmt(state.kopilka.balance);
  showToast('âœ… Ğ¡ÑƒĞ¼Ğ¼Ğ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ°!');
  // Write only the changed cell immediately
  if(gAccessToken){
    const editId=document.getElementById('kop-edit-id').value;
    const target=(state.kopilka.entries||[]).find(e=>e.id===editId);
    if(target){
      setSyncStatus('syncing','ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ...');
      writeKopilkaRowAmount(target)
        .then(()=>setSyncStatus('connected','ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾'))
        .catch(()=>setSyncStatus('error','Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸'));
    }
  }
}
function saveExpense(){
  const name=document.getElementById('exp-name-in').value.trim();
  const amount=parseFloat(document.getElementById('exp-amt-in').value);
  if(!name||isNaN(amount)||amount<=0){showToast('âš ï¸ Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸ Ğ¿Ğ¾Ğ»Ñ');return;}
  const p=state.periods[state.currentIdx];
  if(editExpIdx!==null){
    const exp=p.expenses[editExpIdx];
    exp.name=name;
    exp.amount=amount;
    // If this was a base payment and something changed â€” mark as manual so it saves to sheet
    if(!exp.manual) exp.manual=true;
    showToast('âœï¸ Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¾!');
  } else {
    const isKopilka = name.toLowerCase().includes('ĞºĞ¾Ğ¿Ğ¸Ğ»Ğº');
    if(isKopilka){
      if(!state.kopilka.entries) state.kopilka.entries=[];
      const stableId = 'k_' + p.name.toLowerCase().replace(/\s+/g,'_') + '__Ğ²_ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ';
      // Update existing or insert new
      const existingIdx = state.kopilka.entries.findIndex(e=>e.id===stableId);
      if(existingIdx>=0){
        state.kopilka.entries[existingIdx].amount = amount;
      } else {
        const newEntry = {
          id: stableId,
          period: p.name,
          typ: 'Ğ² ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ',
          name: p.name, // period name shows correctly in timeline
          amount,
          paid: false,
          rowIndex: 0,
        };
        // Insert in correct chronological position by period order
        const periodOrder = state.periods.map(pp => pp.name.toLowerCase());
        const newPeriodRank = periodOrder.indexOf(p.name.toLowerCase());
        let insertAt = state.kopilka.entries.length;
        for(let i = 0; i < state.kopilka.entries.length; i++){
          const e = state.kopilka.entries[i];
          if(e.paid) continue;
          const eRank = periodOrder.indexOf((e.period||'').toLowerCase());
          if(eRank > newPeriodRank){ insertAt = i; break; }
        }
        state.kopilka.entries.splice(insertAt, 0, newEntry);
      }
      recalcKopilkaBalance();
      injectKopilkaIntoPeriods();
      document.getElementById('mk-val').textContent=fmt(state.kopilka.balance);
      showToast('âœ… Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ Ğ² ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ!');
      saveState();closeModal('modal-expense');renderPeriod();
      if(curTab==='kopilka') renderKopilka();
      if(gAccessToken){
        setSyncStatus('syncing','ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ...');
        writeKopilkaToSheets()
          .then(()=>setSyncStatus('connected','ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾'))
          .catch(()=>setSyncStatus('error','Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸'));
      }
      return;
    }
    p.expenses.push({name,amount,paid:false,manual:true});
    showToast('âœ… Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾!');
  }
  saveState();closeModal('modal-expense');renderPeriod();
  scheduleSync(()=>writePeriodRow(state.currentIdx));
}

function openEditIncome(){
  document.getElementById('income-in').value=state.periods[state.currentIdx].income;
  openModal('modal-income');
  setTimeout(()=>document.getElementById('income-in').select(),300);
}
function saveIncome(){
  const v=parseFloat(document.getElementById('income-in').value);
  if(isNaN(v)||v<0){showToast('âš ï¸ ĞĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ°');return;}
  state.periods[state.currentIdx].income=v;
  saveState();closeModal('modal-income');renderPeriod();showToast('ğŸ’¸ Ğ¡ÑƒĞ¼Ğ¼Ğ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ°!');
  scheduleSync(()=>writePeriodRow(state.currentIdx));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KOPILKA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderKopilka(showAllHistory) {
  // Desktop hook
  if (typeof isDesktop === 'function' && isDesktop()) {
    setTimeout(() => { renderDtKopilkaBalance(); if (typeof dtCurrentTab !== 'undefined' && dtCurrentTab === 'kopilka') renderDtKopilka(); }, 0);
  }
  document.getElementById('kop-balance').textContent = fmt(state.kopilka.balance);
  const container = document.getElementById('kop-timeline');
  container.innerHTML = '';
  const entries = state.kopilka.entries || [];
  // Skip 'Ğ±Ğ°Ğ»Ğ°Ğ½Ñ' entry in timeline display
  const items = entries.filter(e => e.typ.toLowerCase().trim() !== 'Ğ±Ğ°Ğ»Ğ°Ğ½Ñ');
  const pastItems   = items.filter(e => e.paid);
  const futureItems = items.filter(e => !e.paid);

  // Running balance for future items
  let runBal = state.kopilka.balance;
  const futureWithBal = futureItems.map(e => {
    const balBefore = runBal;
    if (e.typ.toLowerCase().trim() === 'Ğ² ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ') runBal += e.amount;
    else runBal -= e.amount;
    return { ...e, balBefore, balAfter: runBal };
  });

  // HISTORY section
  if (pastItems.length) {
    const HIST_LIMIT = 3;
    const showAll = showAllHistory === true;
    const hiddenCount = Math.max(0, pastItems.length - HIST_LIMIT);
    const visiblePast = showAll ? pastItems : pastItems.slice(-HIST_LIMIT);

    const hdr = document.createElement('div');
    hdr.className = 'tl-section-hdr';
    hdr.innerHTML = 'Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ <span style="font-size:10px;opacity:.6;font-family:\'Nunito\';text-transform:none;font-weight:600;letter-spacing:0">' + pastItems.length + ' Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹</span>';
    container.appendChild(hdr);

    if (!showAll && hiddenCount > 0) {
      const btn = document.createElement('button');
      btn.style.cssText = 'display:block;width:calc(100% - 48px);margin:0 24px 8px;padding:10px;background:var(--white);border:2px dashed #D8D5E8;border-radius:var(--rs);font-family:\'Nunito\',sans-serif;font-size:13px;font-weight:700;color:var(--ink-muted);cursor:pointer;';
      btn.textContent = 'â†‘ ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ²ÑÑ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ (' + hiddenCount + ' ÑĞºÑ€Ñ‹Ñ‚Ğ¾)';
      btn.onclick = () => renderKopilka(true);
      container.appendChild(btn);
    }
    visiblePast.forEach(e => container.appendChild(makeKopEntry(e, 'past', null)));
    if (showAll && hiddenCount > 0) {
      const btn = document.createElement('button');
      btn.style.cssText = 'display:block;width:calc(100% - 48px);margin:6px 24px 0;padding:10px;background:var(--white);border:2px dashed #D8D5E8;border-radius:var(--rs);font-family:\'Nunito\',sans-serif;font-size:13px;font-weight:700;color:var(--ink-muted);cursor:pointer;';
      btn.textContent = 'â†“ Ğ¡Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ';
      btn.onclick = () => renderKopilka(false);
      container.appendChild(btn);
    }
  }

  // PLANNED section
  if (futureItems.length) {
    const hdr = document.createElement('div');
    hdr.className = 'tl-section-hdr';
    hdr.style.marginTop = pastItems.length ? '10px' : '0';
    hdr.textContent = 'ĞŸĞ»Ğ°Ğ½Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ';
    container.appendChild(hdr);
    futureWithBal.forEach(e => {
      const isShort = (e.typ === 'ĞºÑ€ĞµĞ´Ğ¸Ñ‚' || e.typ === 'Ğ¸Ğ· ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºĞ¸') && e.balBefore < e.amount;
      container.appendChild(makeKopEntry(e, 'future', e.balAfter, isShort));
    });
  }
}

function makeKopEntry(e, section, balAfter, isShort) {
  const t_ = e.typ.toLowerCase().trim();
  const isIncome = t_ === 'Ğ² ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ';
  const isCredit = t_ === 'ĞºÑ€ĞµĞ´Ğ¸Ñ‚';
  const el = document.createElement('div');
  el.className = 'tl-item ' + section + (isShort ? ' danger-row' : '');

  const dotClass = 'tl-dot ' + (isIncome ? 'inc' : 'exp') + ' ' + section;
  const amtClass = 'tl-amt ' + (isIncome ? 'inc' : 'exp') + ' ' + section;
  const sign = isIncome ? '+' : 'âˆ’';
  const symbol = isIncome ? 'â†‘' : 'â†“';

  // Balance hint
  let balHtml = '';
  if (section === 'past') {
    // Compute running balance up to this entry from entries array
    let bal = 0;
    for (const en of (state.kopilka.entries || [])) {
      if (en.typ === 'Ğ±Ğ°Ğ»Ğ°Ğ½Ñ') { bal = en.amount; }
      else if (en.typ === 'Ğ² ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ') bal += en.amount;
      else bal -= en.amount;
      if (en.id === e.id) break;
    }
    balHtml = `<div class="tl-bal ok" style="color:#aaa">â†’ ${fmt(bal)}</div>`;
  } else if (balAfter !== null && balAfter !== undefined) {
    const ok = balAfter >= 0;
    const short = ok ? '' : ' (' + fmt(Math.abs(balAfter)) + ' Ğ½Ğµ Ñ…Ğ²Ğ°Ñ‚Ğ°ĞµÑ‚)';
    balHtml = `<div class="tl-bal ${ok ? 'ok' : 'warn'}">â†’ ${fmt(balAfter)}${short}</div>`;
  }

  // Right side
  let rightHtml = '';
  if (isCredit && section === 'future') {
    rightHtml = `<div class="tl-right-col"><div class="${amtClass}">${sign}${fmt(e.amount)}</div></div>` +
      (isShort ? '<div class="tl-warn-icon">âš ï¸</div>' : '') +
      `<button class="tl-check unpaid" onclick="toggleKopEntry('${e.id}')">â—‹</button>`;
  } else if (isCredit && section === 'past') {
    rightHtml = `<div class="${amtClass}">${sign}${fmt(e.amount)}</div><div class="tl-check paid" style="cursor:default;pointer-events:none">âœ“</div>`;
  } else if (!isIncome && section === 'future') {
    // 'Ğ¸Ğ· ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºĞ¸' â€” also toggleable
    rightHtml = `<div class="tl-right-col"><div class="${amtClass}">${sign}${fmt(e.amount)}</div></div>` +
      (isShort ? '<div class="tl-warn-icon">âš ï¸</div>' : '') +
      `<button class="tl-check unpaid" onclick="toggleKopEntry('${e.id}')">â—‹</button>`;
  } else {
    rightHtml = `<div class="${amtClass}">${sign}${fmt(e.amount)}</div>`;
  }

  el.innerHTML = `<div class="${dotClass}">${symbol}</div><div class="tl-info"><div class="tl-name">${e.name}</div>${balHtml}</div><div class="tl-right">${rightHtml}</div>`;
  return el;
}

function toggleKopEntry(id) {
  const e = (state.kopilka.entries || []).find(x => x.id === id);
  if (!e) return;
  e.paid = !e.paid;
  recalcKopilkaBalance();
  injectKopilkaIntoPeriods();
  saveState();
  renderKopilka();
  renderPeriod();
  document.getElementById('mk-val').textContent = fmt(state.kopilka.balance);
  showToast(e.paid ? 'âœ… ĞÑ‚Ğ¼ĞµÑ‡ĞµĞ½Ğ¾ Ğ¾Ğ¿Ğ»Ğ°Ñ‡ĞµĞ½Ğ½Ñ‹Ğ¼' : 'â†©ï¸ ĞÑ‚Ğ¼ĞµĞ½ĞµĞ½Ğ¾');
  scheduleSync(() => writeKopilkaRowPaid(e));
}

function openKopilkaOp(type) {
  kopOpType = type;
  document.getElementById('modal-kop-title').textContent = type === 'add' ? '+ ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ' : 'âˆ’ Ğ¡Ğ½ÑÑ‚ÑŒ Ğ¸Ğ· ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºĞ¸';
  document.getElementById('kop-amt-in').value = '';
  document.getElementById('kop-comment-in').value = '';
  openModal('modal-kop');
  setTimeout(() => document.getElementById('kop-amt-in').focus(), 300);
}

function saveKopOp() {
  const a = parseFloat(document.getElementById('kop-amt-in').value);
  const c = document.getElementById('kop-comment-in').value.trim() || (kopOpType === 'add' ? 'ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ' : 'Ğ¡Ğ½ÑÑ‚Ğ¸Ğµ');
  if (isNaN(a) || a <= 0) { showToast('âš ï¸ Ğ’Ğ²ĞµĞ´Ğ¸ ÑÑƒĞ¼Ğ¼Ñƒ'); return; }
  const isAdd = kopOpType === 'add';
  const entries = state.kopilka.entries || [];
  const firstUnpaidIdx = entries.findIndex(e => !e.paid);
  const newEntry = {
    id: 'manual_' + Date.now(),
    period: 'Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ',
    typ: isAdd ? 'Ğ² ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ' : 'Ğ¸Ğ· ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºĞ¸',
    name: c,
    amount: a,
    paid: true,
    rowIndex: 0,
  };
  if (firstUnpaidIdx === -1) entries.push(newEntry);
  else entries.splice(firstUnpaidIdx, 0, newEntry);
  state.kopilka.entries = entries;
  recalcKopilkaBalance();
  injectKopilkaIntoPeriods();
  saveState();
  closeModal('modal-kop');
  renderKopilka();
  document.getElementById('mk-val').textContent = fmt(state.kopilka.balance);
  showToast(isAdd ? 'ğŸ’° Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ Ğ² ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ!' : 'ğŸ’¸ Ğ¡Ğ½ÑÑ‚Ğ¾ Ğ¸Ğ· ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºĞ¸!');
  scheduleSync(() => writeKopilkaToSheets());
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSettings(){
  renderBPList();
  renderAuthCard();
}

function renderAuthCard(){
  const el=document.getElementById('auth-card-content');
  if(!el) return;
  if(gAccessToken&&gUserEmail){
    el.innerHTML=`
      <div class="auth-status-row">
        <div><div class="set-row-lbl">âœ… ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾</div><div class="auth-sub">${gUserEmail}</div></div>
      </div>
      <div class="auth-status-row">
        <div><div class="set-row-lbl">Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°</div><div class="auth-sub">ĞœĞ¾Ğ¸ Ñ‚Ñ€Ğ°Ñ‚Ñ‹ 2025</div></div>
        <a href="https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}" target="_blank" style="font-size:12px;color:var(--violet);font-weight:700;text-decoration:none">ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ â†’</a>
      </div>
      <button class="auth-btn disconnect" style="margin-top:14px" onclick="signOut()">ĞÑ‚ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ Google Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚</button>`;
  } else if(gUserEmail && !gAccessToken) {
    // Email known but token not yet restored â€” show loading
    el.innerHTML=`
      <div class="set-row-lbl" style="margin-bottom:6px">ğŸ”„ Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑĞµÑÑĞ¸Ğ¸...</div>
      <div class="auth-sub" style="font-size:13px;color:var(--ink-muted)">${gUserEmail}</div>`;
  } else {
    el.innerHTML=`
      <div class="set-row-lbl" style="margin-bottom:6px">Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ</div>
      <div class="auth-sub" style="font-size:13px;color:var(--ink-muted);line-height:1.5;margin-bottom:14px">ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸ Google Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞ»Ğ¸ÑÑŒ Ğ² Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğµ Ğ¸ Ğ±Ñ‹Ğ»Ğ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹ Ñ Ğ»ÑĞ±Ğ¾Ğ³Ğ¾ ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ°</div>
      <button class="auth-btn google" onclick="signIn()">ğŸ”‘ Ğ’Ğ¾Ğ¹Ñ‚Ğ¸ Ñ‡ĞµÑ€ĞµĞ· Google</button>`;
  }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BASE PAYMENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderBPList(){
  const container=document.getElementById('bp-list');container.innerHTML='';
  if(!state.basePayments.length){container.innerHTML='<div class="empty-state"><div class="empty-ico">ğŸ“‹</div><div class="empty-txt">Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ñ… Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶ĞµĞ¹ Ğ½ĞµÑ‚</div></div>';return;}
  [5,20].forEach(day=>{
    const items=state.basePayments.filter(bp=>bp.day===day);if(!items.length)return;
    const hdr=document.createElement('div');
    hdr.style.cssText='font-size:11px;font-weight:700;color:var(--ink-muted);text-transform:uppercase;letter-spacing:.5px;margin:10px 0 6px;';
    hdr.textContent=day===5?'ğŸ“… 5 Ñ‡Ğ¸ÑĞ»Ğ°':'ğŸ“… 20 Ñ‡Ğ¸ÑĞ»Ğ°';container.appendChild(hdr);
    items.forEach(bp=>{
      const idx=state.basePayments.indexOf(bp);
      const el=document.createElement('div');el.className='bp-item';
      el.innerHTML=`<div class="bp-badge ${day===5?'d5':'d20'}">${day}</div><div class="bp-info"><div class="bp-name">${bp.name}</div><div class="bp-sub">${day} Ñ‡Ğ¸ÑĞ»Ğ° ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ğ¼ĞµÑÑÑ†Ğ°</div></div><div class="bp-amt">${fmt(bp.amount)}</div><div class="bp-actions"><button class="bp-btn" onclick="openEditBP(${idx})">âœï¸</button><button class="bp-btn del" onclick="deleteBP(${idx})">âœ•</button></div>`;
      container.appendChild(el);
    });
  });
}

function openAddBP(){editBPIdx=null;bpDay=5;document.getElementById('modal-bp-title').textContent='ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ»Ğ°Ñ‚Ñ‘Ğ¶';document.getElementById('bp-name-in').value='';document.getElementById('bp-amt-in').value='';selectBPDay(5);openModal('modal-bp');setTimeout(()=>document.getElementById('bp-name-in').focus(),300);}
function openEditBP(idx){editBPIdx=idx;const bp=state.basePayments[idx];document.getElementById('modal-bp-title').textContent='Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ»Ğ°Ñ‚Ñ‘Ğ¶';document.getElementById('bp-name-in').value=bp.name;document.getElementById('bp-amt-in').value=bp.amount;bpDay=bp.day;selectBPDay(bp.day);openModal('modal-bp');}
function selectBPDay(day){bpDay=day;document.getElementById('bp-seg-5').className='modal-seg-btn'+(day===5?' active':'');document.getElementById('bp-seg-20').className='modal-seg-btn'+(day===20?' active':'');}
function saveBP(){
  const name=document.getElementById('bp-name-in').value.trim();
  const amount=parseFloat(document.getElementById('bp-amt-in').value);
  if(!name||isNaN(amount)||amount<=0){showToast('âš ï¸ Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸ Ğ¿Ğ¾Ğ»Ñ');return;}
  if(editBPIdx!==null){
    const oldBP=state.basePayments[editBPIdx];const oldName=oldBP.name;const oldAmt=oldBP.amount;const oldDay=oldBP.day;
    oldBP.name=name;oldBP.amount=amount;oldBP.day=bpDay;
    let updatedCount=0;
    state.periods.forEach(p=>{const periodDay=p.name.match(/\d+$/)?.[0];if(parseInt(periodDay)===oldDay||bpDay===oldDay){p.expenses.forEach(exp=>{if(!exp.paid&&exp.name===oldName&&exp.amount===oldAmt){exp.name=name;exp.amount=amount;updatedCount++;}});}});
    saveState();closeModal('modal-bp');renderBPList();renderPeriod();
    showToast(`âœ… ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾${updatedCount>0?' Ğ² '+updatedCount+' Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°Ñ…':''}!`);
    scheduleSync(()=>writeBPToSheets());
  }else{
    const id='bp_'+Date.now();state.basePayments.push({id,name,amount,day:bpDay});
    saveState();closeModal('modal-bp');renderBPList();showToast('âœ… Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ»Ğ°Ñ‚Ñ‘Ğ¶ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½!');
    scheduleSync(()=>writeBPToSheets());
  }
}
function deleteBP(idx){
  if(!confirm('Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ»Ğ°Ñ‚Ñ‘Ğ¶? Ğ˜Ğ· ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ñ… Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ¾Ğ² Ğ¾Ğ½ Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑÑ.'))return;
  state.basePayments.splice(idx,1);saveState();renderBPList();showToast('ğŸ—‘ï¸ Ğ£Ğ´Ğ°Ğ»Ñ‘Ğ½');
  scheduleSync(()=>writeBPToSheets());
}

function publishAllPeriods(){
  if(!gAccessToken){ showToast('âš ï¸ Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·ÑƒĞ¹ÑÑ'); return; }
  if(!confirm('Ğ—Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ²ÑĞµ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ñ‹ Ğ² Google Sheets? Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ² Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğµ Ğ±ÑƒĞ´ÑƒÑ‚ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿Ğ¸ÑĞ°Ğ½Ñ‹.')) return;
  setSyncStatus('syncing','Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ...');
  writeAllPeriods()
    .then(()=>{ setSyncStatus('connected','ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾'); showToast('âœ… Ğ’ÑĞµ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ñ‹ Ğ·Ğ°Ğ¿Ğ¸ÑĞ°Ğ½Ñ‹ Ğ² Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ!'); })
    .catch(()=>{ setSyncStatus('error','Ğ¾ÑˆĞ¸Ğ±ĞºĞ°'); showToast('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸'); });
}

function loadFromSheets(){
  if(!gAccessToken){ showToast('âš ï¸ Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·ÑƒĞ¹ÑÑ'); return; }
  if(!confirm('Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Google Sheets? Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ±ÑƒĞ´ÑƒÑ‚ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿Ğ¸ÑĞ°Ğ½Ñ‹.')) return;
  localStorage.removeItem('finance_v10');
  state = loadState();
  setSyncStatus('syncing','Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...');
  syncFromSheets()
    .then(()=>{
      saveState();
      renderPeriod();
      renderKopilka();
      renderSettings();
      setSyncStatus('connected','ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾');
      showToast('âœ… Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ñ‹ Ğ¸Ğ· Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹!');
    })
    .catch(()=>{ setSyncStatus('error','Ğ¾ÑˆĞ¸Ğ±ĞºĞ°'); showToast('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸'); });
}

function resetData(){
  if(!confirm('Ğ¡Ğ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ Ğ²ÑĞµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğº Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¼? Ğ­Ñ‚Ğ¾ Ğ½ĞµĞ»ÑŒĞ·Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ.'))return;
  localStorage.removeItem('finance_v10');
  state=loadState();saveState();renderPeriod();showToast('ğŸ”„ Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞ±Ñ€Ğ¾ÑˆĞµĞ½Ñ‹');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.querySelectorAll('.modal-ov').forEach(o=>{o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open');});});
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){['modal-expense','modal-income','modal-kop','modal-bp'].forEach(closeModal);}
  if(e.key==='Enter'){
    if(document.getElementById('modal-expense').classList.contains('open'))saveExpense();
    if(document.getElementById('modal-income').classList.contains('open'))saveIncome();
    if(document.getElementById('modal-kop').classList.contains('open'))saveKopOp();
    if(document.getElementById('modal-bp').classList.contains('open'))saveBP();
    if(document.getElementById('modal-kop-edit').classList.contains('open'))saveKopilkaEntryEdit();
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init() {
  // Hide loading immediately â€” show local data right away
  document.getElementById('loading-ov').classList.add('hidden');
  renderPeriod();
  renderAuthCard();
  // Google auth initialises in background
  initGoogleAuth();
}

init();


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DESKTOP LAYOUT JS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let dtCurrentTab = 'periods';

function isDesktop() { return window.innerWidth >= 900; }

function dtSwitchTab(tab) {
  dtCurrentTab = tab;
  ['periods','kopilka','settings'].forEach(t => {
    document.getElementById('dt-tab-' + t).classList.toggle('active', t === tab);
    document.getElementById('dt-' + t + '-view').style.display = t === tab ? 'block' : 'none';
  });
  if (tab === 'periods') renderDtGrid();
  if (tab === 'kopilka') renderDtKopilka();
  if (tab === 'settings') renderDtSettings();
}

function renderDtKopilkaBalance() {
  const el = document.getElementById('dt-kop-val');
  if (el) el.textContent = fmt(state.kopilka.balance);
}

function setSyncStatusDt(status) {
  const lbl = document.getElementById('sync-label-dt');
  if (lbl) {
    const emoji = status === 'connected' ? 'ğŸ™‚' : status === 'syncing' ? 'ğŸ‘€' : 'ğŸ¤«';
    lbl.textContent = emoji;
  }
}

function renderDtGrid() {
  if (!isDesktop()) return;
  renderDtKopilkaBalance();
  const grid = document.getElementById('dt-periods-grid');
  if (!grid) return;
  grid.innerHTML = '';
  state.periods.forEach((p, idx) => {
    const totalExp = p.expenses.reduce((s,e) => s + e.amount, 0);
    const paidExp  = p.expenses.filter(e => e.paid).reduce((s,e) => s + e.amount, 0);
    const leftover = p.income - totalExp;
    const pct = totalExp > 0 ? Math.round(paidExp / totalExp * 100) : 0;
    const isCurrent = idx === state.currentIdx;
    const isFuture = !isCurrentOrPastPeriod(idx);

    const card = document.createElement('div');
    card.className = 'dt-period-card' + (isCurrent ? ' current' : '');

    const fillClass = pct >= 100 ? 'warn' : pct >= 70 ? 'warn' : '';
    const leftColor = leftover < 0 ? 'var(--coral)' : 'var(--yellow)';

    card.innerHTML = `
      <div class="dt-card-header">
        <div>
          <div class="dt-card-name">${p.name}</div>
          <div class="dt-card-income">${fmt(p.income)}</div>
          <div class="dt-card-stats">
            <div class="dt-stat"><div class="dt-stat-lbl">Ğ Ğ°ÑÑ…Ğ¾Ğ´Ñ‹</div><div class="dt-stat-val" style="color:var(--coral)">${fmt(totalExp)}</div></div>
            <div class="dt-stat"><div class="dt-stat-lbl">ĞĞ¿Ğ»Ğ°Ñ‡ĞµĞ½Ğ¾</div><div class="dt-stat-val" style="color:var(--green)">${fmt(paidExp)}</div></div>
            <div class="dt-stat"><div class="dt-stat-lbl">ĞÑÑ‚Ğ°Ñ‚Ğ¾Ğº</div><div class="dt-stat-val" style="color:${leftColor}">${fmt(leftover)}</div></div>
          </div>
          <div class="dt-prog"><div class="dt-prog-fill ${fillClass}" style="width:${Math.min(pct,100)}%"></div></div>
        </div>
        <div style="display:flex;gap:6px;align-items:flex-start">
          ${!isFuture ? `<button onclick="dtAddExpense(${idx})" style="background:rgba(255,255,255,.15);border:none;border-radius:8px;color:white;padding:4px 8px;font-family:'Nunito',sans-serif;font-size:11px;font-weight:700;cursor:pointer">+ Ğ Ğ°ÑÑ…Ğ¾Ğ´</button>` : ''}
        </div>
      </div>
      <div class="dt-expenses" id="dt-exp-${idx}"></div>
    `;

    // Render expenses
    const expContainer = card.querySelector(`#dt-exp-${idx}`);
    if (!p.expenses.length) {
      expContainer.innerHTML = '<div style="padding:12px 0;text-align:center;color:var(--ink-muted);font-size:12px">ĞĞµÑ‚ Ñ€Ğ°ÑÑ…Ğ¾Ğ´Ğ¾Ğ²</div>';
    } else {
      p.expenses.forEach((exp, ei) => {
        const item = document.createElement('div');
        item.className = 'dt-exp-item' + (exp.paid ? ' paid' : '') + (isFuture ? ' future-locked' : '');
        item.innerHTML = `
          <div class="dt-exp-check">${exp.paid ? 'âœ“' : ''}</div>
          <div class="dt-exp-name">${exp.name}</div>
          <div class="dt-exp-amt">${fmt(exp.amount)}</div>
        `;
        if (!isFuture) {
          item.onclick = () => { state.currentIdx = idx; toggleExp(ei); renderDtGrid(); };
        }
        expContainer.appendChild(item);
      });
    }

    grid.appendChild(card);
  });
}

function dtAddExpense(periodIdx) {
  state.currentIdx = periodIdx;
  renderPeriod();
  openAddExpense();
  // After save, re-render grid
  const origSave = window._origSaveExpense;
}

function renderDtKopilka() {
  if (!isDesktop()) return;
  renderDtKopilkaBalance();
  const wrap = document.getElementById('dt-kopilka-content');
  if (!wrap) return;
  // Reuse mobile kopilka render into a container
  const tmp = document.createElement('div');
  tmp.innerHTML = `
    <div style="background:linear-gradient(135deg,var(--violet) 0%,#5B3FA8 100%);border-radius:var(--r);padding:24px;color:white;margin-bottom:16px;position:relative;overflow:hidden">
      <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;opacity:.65">Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºĞ¸</div>
      <div style="font-family:'Unbounded',sans-serif;font-size:36px;font-weight:800;margin-top:6px">${fmt(state.kopilka.balance)}</div>
      <div style="font-size:44px;position:absolute;right:20px;top:16px;opacity:.25">ğŸ’¸</div>
    </div>
    <div style="display:flex;gap:10px;margin-bottom:16px">
      <button onclick="openKopilkaOp('add')" style="flex:1;padding:11px;border:none;border-radius:var(--rs);font-family:'Nunito',sans-serif;font-size:14px;font-weight:700;cursor:pointer;background:var(--green-light);color:var(--green)">+ ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ</button>
      <button onclick="openKopilkaOp('sub')" style="flex:1;padding:11px;border:none;border-radius:var(--rs);font-family:'Nunito',sans-serif;font-size:14px;font-weight:700;cursor:pointer;background:var(--coral-light);color:var(--coral)">âˆ’ Ğ¡Ğ½ÑÑ‚ÑŒ</button>
    </div>
    <div id="dt-kop-timeline"></div>
  `;
  wrap.innerHTML = '';
  wrap.appendChild(tmp);
  // Render timeline into dt-kop-timeline
  const tlContainer = document.getElementById('dt-kop-timeline');
  if (tlContainer) {
    // Temporarily swap container for renderKopilka
    const origEl = document.getElementById('kop-timeline');
    origEl._dtSwapped = true;
    tlContainer.id = 'kop-timeline-real';
    const realEl = document.getElementById('kop-timeline');
    // Just call the timeline build directly
    renderKopilkaInto(tlContainer);
  }
}

function renderKopilkaInto(container) {
  // Simplified kopilka timeline render
  const tl = state.kopilka.timeline || state.kopilka.entries || [];
  const pastItems = tl.filter(t => t.paid);
  const futureItems = tl.filter(t => !t.paid);
  container.innerHTML = '';

  if (pastItems.length) {
    const hdr = document.createElement('div');
    hdr.style.cssText = 'font-family:Unbounded,sans-serif;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--ink-muted);padding:4px 0 8px';
    hdr.textContent = 'Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ';
    container.appendChild(hdr);
    pastItems.slice(-5).forEach(item => container.appendChild(makeTlItem(item, 'past', null, false)));
  }
  if (futureItems.length) {
    let runBal = state.kopilka.balance;
    const hdr = document.createElement('div');
    hdr.style.cssText = 'font-family:Unbounded,sans-serif;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--ink-muted);padding:12px 0 8px';
    hdr.textContent = 'ĞŸĞ»Ğ°Ğ½Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ';
    container.appendChild(hdr);
    futureItems.forEach(item => {
      const balBefore = runBal;
      if (item.type === 'income' || item.typ === 'Ğ² ĞºĞ¾Ğ¿Ğ¸Ğ»ĞºÑƒ') runBal += item.amount;
      else runBal -= item.amount;
      const isShort = (item.type === 'expense' || item.typ === 'ĞºÑ€ĞµĞ´Ğ¸Ñ‚') && item.isCredit && balBefore < item.amount;
      const el = makeTlItem({...item, balAfter: runBal}, 'future', runBal, isShort);
      // Fix onclick for desktop
      container.appendChild(el);
    });
  }
}

function renderDtSettings() {
  if (!isDesktop()) return;
  // Clone settings screen content into dt-settings-content
  const wrap = document.getElementById('dt-settings-content');
  if (!wrap) return;
  wrap.innerHTML = '';
  // Re-render the settings sections manually
  const settingsScreen = document.getElementById('screen-settings').cloneNode(true);
  settingsScreen.style.display = 'block';
  settingsScreen.style.maxWidth = '100%';
  settingsScreen.style.paddingBottom = '20px';
  // Remove topbar from clone
  const tb = settingsScreen.querySelector('.topbar');
  if (tb) tb.remove();
  wrap.appendChild(settingsScreen);
  // Re-init settings inputs in the clone
  const salInput = settingsScreen.querySelector('#salary-input');
  if (salInput) {
    salInput.value = state.salary || 150000;
    salInput.addEventListener('input', () => {
      const sal = parseFloat(salInput.value) || 150000;
      const rows = genSalaryPreview(sal);
      const preview = settingsScreen.querySelector('#sal-preview');
      if (preview) preview.innerHTML = '<div class="sal-preview-title">Ğ Ğ°ÑÑ‡Ñ‘Ñ‚ Ğ±Ğ»Ğ¸Ğ¶Ğ°Ğ¹ÑˆĞ¸Ñ… Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ¾Ğ²</div>' +
        rows.map(r => `<div class="sal-row"><span class="sal-row-lbl">${r.label}</span><span class="sal-row-val" style="color:${r.note==='avans'?'var(--violet)':'var(--green)'}">${fmt(r.val)}</span></div>`).join('');
    });
    salInput.dispatchEvent(new Event('input'));
  }
}

// Desktop sync hooks â€” handled inside original functions

// Init desktop on load
window.addEventListener('resize', () => {
  if (isDesktop() && dtCurrentTab === 'periods') renderDtGrid();
});

// Init desktop on load
if (isDesktop()) renderDtGrid();

</script>
</body>
</html>
